<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÊé®ËçêV2 - A/BÊµãËØï & ‰∏™ÊÄßÂåñ</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --starbucks-green: #00704a;
            --starbucks-light-green: #1e3932;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
        }

        .demo-header {
            background: linear-gradient(135deg, var(--starbucks-green) 0%, var(--starbucks-light-green) 100%);
            color: white;
            padding: 30px 24px;
            text-align: center;
        }

        .demo-header h1 { font-size: 28px; margin-bottom: 8px; }
        .demo-header p { opacity: 0.9; font-size: 14px; }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        .demo-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .demo-container { grid-template-columns: 1fr; }
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--starbucks-green);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #666; margin-bottom: 6px; }

        .persona-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .persona-card {
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 13px;
        }

        .persona-card:hover { border-color: var(--starbucks-green); }
        .persona-card.selected { border-color: var(--starbucks-green); background: rgba(0,112,74,0.1); }
        .persona-card .emoji { font-size: 24px; display: block; margin-bottom: 4px; }

        .toggle-group { display: flex; flex-direction: column; gap: 10px; }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .toggle-item label { font-size: 13px; color: #333; }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider { background: var(--starbucks-green); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }

        .btn-recommend {
            width: 100%;
            padding: 14px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-recommend:hover { background: var(--starbucks-light-green); }
        .btn-recommend:disabled { background: #ccc; cursor: not-allowed; }

        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main-content { min-height: 600px; }

        .experiment-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .experiment-banner .title {
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .experiment-banner .title::before {
            content: 'üß™';
        }
        .experiment-banner .variants {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .experiment-banner .variant-tag {
            background: rgba(255,255,255,0.15);
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s;
            cursor: pointer;
        }
        .experiment-banner .variant-tag:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }
        .experiment-banner .variant-tag.treatment {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.5);
        }
        .experiment-banner .variant-tag .exp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .experiment-banner .variant-tag .exp-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .experiment-banner .variant-tag .exp-variant {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        .experiment-banner .variant-tag.treatment .exp-variant {
            background: rgba(34, 197, 94, 0.5);
        }
        .experiment-banner .variant-tag .exp-desc {
            font-size: 11px;
            opacity: 0.85;
            line-height: 1.4;
        }
        .experiment-banner .variant-tag .exp-impact {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed rgba(255,255,255,0.2);
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .experiment-banner .variant-tag .exp-impact.positive {
            color: #86efac;
        }
        .experiment-banner .variant-tag .exp-impact.neutral {
            color: #fde68a;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .rec-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            transition: all 0.2s;
            border: 2px dashed #d1d5db;
        }

        .rec-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border-color: #00704a;
        }

        .rec-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .rec-card-title { font-size: 16px; font-weight: 600; color: #333; }
        .rec-card-category { font-size: 12px; color: #888; margin-top: 2px; }

        .match-score {
            font-size: 20px;
            font-weight: 700;
            color: var(--starbucks-green);
        }

        .score-breakdown {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 12px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .score-row:last-child { border-bottom: none; }
        .score-row .label { color: #666; }
        .score-row .value { font-weight: 600; color: #333; }
        .score-row .value.boost { color: #22c55e; }
        .score-row .value.penalty { color: #ef4444; }

        .rec-reason {
            font-size: 13px;
            color: #555;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,112,74,0.05);
            border-radius: 8px;
            border-left: 3px solid var(--starbucks-green);
        }

        .matched-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .keyword-tag {
            padding: 3px 8px;
            background: rgba(0,112,74,0.1);
            color: var(--starbucks-green);
            border-radius: 12px;
            font-size: 11px;
        }

        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .feedback-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .feedback-btn:hover { background: #f5f5f5; }
        .feedback-btn.like:hover { background: #dcfce7; border-color: #22c55e; }
        .feedback-btn.dislike:hover { background: #fee2e2; border-color: #ef4444; }
        .feedback-btn.clicked { background: #dcfce7; border-color: #22c55e; }

        /* Âè≥‰æßÈù¢Êùø */
        .side-panel { position: sticky; top: 20px; height: fit-content; }

        .session-info {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .session-info .title { font-weight: 600; color: #0369a1; margin-bottom: 6px; }

        .realtime-prefs {
            margin-top: 16px;
        }

        .pref-section { margin-bottom: 12px; }
        .pref-section .label { font-size: 12px; color: #888; margin-bottom: 6px; }

        .pref-tags { display: flex; flex-wrap: wrap; gap: 4px; }

        .pref-tag {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .pref-tag.liked { background: #dcfce7; color: #166534; }
        .pref-tag.disliked { background: #fee2e2; color: #991b1b; }
        .pref-tag.new { animation: tagPulse 0.5s ease; }
        @keyframes tagPulse {
            0% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        .tag-count { font-size: 10px; color: #999; font-weight: normal; }

        /* Ê¥ªÂä®Êó•Âøó */
        .activity-log-section {
            margin-top: 12px;
            padding: 10px;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 8px;
            border: 1px solid #bbf7d0;
        }
        .activity-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .activity-log-header .label { font-size: 12px; font-weight: 600; color: #166534; }
        .btn-demo-interactions {
            padding: 4px 8px;
            font-size: 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-demo-interactions:hover { background: #059669; transform: scale(1.05); }
        .activity-log {
            max-height: 120px;
            overflow-y: auto;
            font-size: 11px;
        }
        .activity-empty { color: #888; text-align: center; padding: 10px; }
        .activity-item {
            padding: 4px 6px;
            margin-bottom: 4px;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(-10px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .activity-item .time { color: #999; font-size: 10px; flex-shrink: 0; }
        .activity-item .action { flex: 1; }
        .activity-item.like { border-left: 3px solid #22c55e; }
        .activity-item.dislike { border-left: 3px solid #ef4444; }
        .activity-item.cart { border-left: 3px solid #3b82f6; }
        .activity-item.click { border-left: 3px solid #f59e0b; }
        .activity-item.context { border-left: 3px solid #8b5cf6; }

        /* ‰∏ä‰∏ãÊñáÂõ†Â≠êËø∑‰Ω†Â±ïÁ§∫ */
        .context-realtime-section {
            margin-top: 12px;
            padding: 10px;
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border-radius: 8px;
            border: 1px solid #c4b5fd;
        }
        .context-realtime-section .label { font-size: 12px; font-weight: 600; color: #6d28d9; margin-bottom: 8px; }
        .context-factors-mini {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        .context-factor-mini {
            padding: 6px 8px;
            background: white;
            border-radius: 6px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .context-factor-mini .name { color: #666; }
        .context-factor-mini .value { font-weight: 600; }
        .context-factor-mini .value.boost { color: #16a34a; }
        .context-factor-mini .value.neutral { color: #666; }
        .context-factor-mini .value.reduce { color: #dc2626; }

        .explanation-panel {
            margin-top: 16px;
            padding: 12px;
            background: #fefce8;
            border-radius: 8px;
            font-size: 12px;
        }

        .explanation-panel .title { font-weight: 600; color: #854d0e; margin-bottom: 8px; }

        .factor-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .factor-item:last-child { border-bottom: none; }

        .factor-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .factor-bar-fill {
            height: 100%;
            background: var(--starbucks-green);
            border-radius: 3px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #888;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #eee;
            border-top-color: var(--starbucks-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .stats-card {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }

        .stats-row .label { color: #666; }
        .stats-row .value { font-weight: 600; }

        /* ËÆ¢ÂçïÂØπÊØîÊºîÁ§∫Ê†∑Âºè */
        .comparison-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .comparison-title {
            font-size: 18px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-simulate {
            padding: 10px 20px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-simulate:hover { background: #d97706; }
        .btn-simulate:disabled { background: #ccc; cursor: not-allowed; }

        .btn-compare {
            padding: 10px 20px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-compare:hover { background: var(--starbucks-light-green); }
        .btn-compare:disabled { background: #ccc; cursor: not-allowed; }

        .order-status {
            padding: 8px 16px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }

        .order-status.has-orders {
            background: #dcfce7;
            color: #166534;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .comparison-grid { grid-template-columns: 1fr; }
        }

        .comparison-column {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .comparison-column-title {
            font-size: 15px;
            font-weight: 600;
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-column-title.old-user {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
        }

        .comparison-column-title.new-user {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
        }

        .comparison-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .comparison-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comparison-item-name {
            font-weight: 600;
            font-size: 14px;
        }

        .comparison-item-score {
            font-size: 18px;
            font-weight: 700;
        }

        .comparison-item-score.boosted {
            color: #22c55e;
        }

        .comparison-item-score.normal {
            color: #6366f1;
        }

        .boost-detail {
            background: #f0fdf4;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 11px;
            margin-top: 8px;
        }

        .boost-detail .factor {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .boost-detail .factor .label { color: #666; }
        .boost-detail .factor .value { font-weight: 600; color: #166534; }

        .boost-explanation {
            font-size: 12px;
            color: #15803d;
            margin-top: 6px;
            font-style: italic;
        }

        .comparison-summary {
            background: rgba(255,255,255,0.9);
            padding: 16px;
            border-radius: 10px;
            margin-top: 16px;
            text-align: center;
        }

        .comparison-summary h4 {
            margin: 0 0 10px 0;
            color: #92400e;
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .number {
            font-size: 24px;
            font-weight: 700;
            color: var(--starbucks-green);
        }

        .summary-stat .label {
            font-size: 12px;
            color: #666;
        }

        /* ÂÆ¢Âà∂ÂåñÁõ∏ÂÖ≥Ê†∑Âºè */
        .customization-section {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 10px;
            font-size: 12px;
        }

        .customization-section .title {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customization-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            color: #0c4a6e;
        }

        .customization-item .label { color: #64748b; }
        .customization-item .value { font-weight: 500; }

        .customization-reason {
            font-size: 11px;
            color: #0369a1;
            margin-top: 6px;
            font-style: italic;
            padding-top: 6px;
            border-top: 1px dashed rgba(3,105,161,0.3);
        }

        .customization-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .customization-keyword {
            padding: 3px 8px;
            background: rgba(3,105,161,0.15);
            color: #0369a1;
            border-radius: 12px;
            font-size: 10px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .confidence-high { background: #dcfce7; color: #166534; }
        .confidence-medium { background: #fef3c7; color: #92400e; }
        .confidence-low { background: #fee2e2; color: #991b1b; }

        /* ÂÆ¢Âà∂ÂåñÈÄâÈ°πÂèØËßÜÂåñÊ†∑Âºè */
        .cust-options-panel {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-radius: 12px;
            padding: 14px;
            margin-top: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
        }

        .cust-options-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 0;
            cursor: pointer;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .cust-options-panel.expanded .panel-header {
            border-bottom-color: #e5e7eb;
            margin-bottom: 12px;
        }

        .cust-options-panel .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cust-options-panel .toggle-icon {
            font-size: 12px;
            color: #9ca3af;
            transition: transform 0.3s ease;
        }

        .cust-options-panel.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .cust-options-content {
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cust-options-panel.expanded .cust-options-content {
            display: block;
        }

        .cust-option-group {
            margin-bottom: 14px;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #f3f4f6;
        }

        .cust-option-group:last-child {
            margin-bottom: 0;
        }

        .cust-option-label {
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .cust-option-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .cust-chip {
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 11px;
            background: #f1f5f9;
            color: #475569;
            border: 1.5px solid #e2e8f0;
            transition: all 0.2s;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
        }

        .cust-chip:empty {
            display: none;
        }

        .cust-chip.highlighted {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 600;
            border-color: transparent;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }

        .cust-chip.matched {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 600;
            border-color: transparent;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }

        .cust-chip.persona-match {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            font-weight: 600;
            border-color: transparent;
            box-shadow: 0 2px 6px rgba(249, 115, 22, 0.4);
        }

        .cust-chip.default {
            border: 2px solid #00704a;
            background: #f0fdf4;
            color: #00704a;
        }

        .cust-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .cust-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            color: #64748b;
        }

        .cust-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .cust-legend-dot.recommended { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .cust-legend-dot.persona { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .cust-legend-dot.default { background: #f0fdf4; border: 2px solid #00704a; }

        .member-price-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        /* È¢ÑËÆæÁÆ°ÁêÜÊ†∑Âºè */
        .preset-section {
            background: linear-gradient(135deg, #fae8ff 0%, #e9d5ff 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .preset-title {
            font-size: 16px;
            font-weight: 700;
            color: #7e22ce;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preset-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .btn-preset {
            padding: 8px 16px;
            background: #9333ea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-preset:hover { background: #7e22ce; }
        .btn-preset:disabled { background: #ccc; cursor: not-allowed; }

        .preset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preset-card {
            background: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .preset-card .name { font-weight: 600; color: #7e22ce; margin-bottom: 4px; }
        .preset-card .options { color: #666; font-size: 11px; }

        /* ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÈù¢ÊùøÊ†∑Âºè */
        .cust-prefs-panel {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border-radius: 8px;
        }

        .cust-prefs-panel .title {
            font-weight: 600;
            color: #047857;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .cust-prefs-panel .pref-section {
            margin-bottom: 10px;
        }

        .cust-prefs-panel .pref-section .label {
            font-size: 11px;
            color: #047857;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .cust-prefs-panel .pref-section .pref-value {
            font-size: 12px;
            color: #1f2937;
            font-weight: 600;
        }

        .cust-prefs-panel .pref-section .pref-value.empty {
            color: #6b7280;
            font-weight: normal;
            font-style: italic;
        }

        .cust-pref-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 11px;
        }

        .cust-pref-item .label { color: #047857; font-weight: 500; }
        .cust-pref-item .value { color: #0d9488; font-weight: 600; }

        /* Ëá™ÂÆö‰πâÂÅèÂ•ΩËæìÂÖ• */
        .custom-preference-section {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
        }

        .custom-preference-section .title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .custom-input-group {
            display: flex;
            gap: 8px;
        }

        .custom-input-group input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d97706;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }

        .custom-input-group input:focus {
            border-color: #92400e;
            box-shadow: 0 0 0 2px rgba(217,119,6,0.2);
        }

        .btn-custom-search {
            padding: 10px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-custom-search:hover { background: #d97706; }

        .hint-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .hint-tag {
            padding: 4px 10px;
            background: rgba(255,255,255,0.7);
            border: 1px solid #d97706;
            border-radius: 12px;
            font-size: 11px;
            color: #92400e;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hint-tag:hover {
            background: #f59e0b;
            color: white;
        }

        /* Ë¥≠Áâ©ËΩ¶Ê†∑Âºè */
        .cart-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cart-title {
            font-weight: 600;
            color: var(--starbucks-green);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cart-badge {
            background: var(--starbucks-green);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .btn-clear-cart {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #dc2626;
            color: #dc2626;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-clear-cart:hover {
            background: #dc2626;
            color: white;
        }

        .cart-items {
            max-height: 300px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .cart-item-customization {
            font-size: 10px;
            color: #666;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cart-item-qty button {
            width: 22px;
            height: 22px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .cart-item-qty button:hover {
            background: #f5f5f5;
        }

        .cart-item-qty span {
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }

        .cart-item-price {
            font-weight: 600;
            color: var(--starbucks-green);
        }

        .cart-item-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .cart-item-remove:hover {
            background: #dc2626;
            color: white;
        }

        .cart-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,112,74,0.2);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .cart-total-label {
            color: #666;
        }

        .cart-total-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--starbucks-green);
        }

        .btn-checkout {
            width: 100%;
            padding: 12px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-checkout:hover { background: var(--starbucks-light-green); }
        .btn-checkout:disabled { background: #ccc; cursor: not-allowed; }

        .cart-empty {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 13px;
        }

        /* Ê∑ªÂä†Âà∞Ë¥≠Áâ©ËΩ¶ÊåâÈíÆ */
        .btn-add-cart {
            flex: 1;
            padding: 8px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-add-cart:hover {
            background: var(--starbucks-light-green);
        }

        .btn-add-cart.added {
            background: #22c55e;
        }

        /* ËÆ¢ÂçïÊàêÂäüÂºπÁ™ó */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .order-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .order-modal-icon {
            font-size: 60px;
            margin-bottom: 16px;
        }

        .order-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--starbucks-green);
            margin-bottom: 8px;
        }

        .order-modal-id {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .order-modal-items {
            text-align: left;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .order-modal-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--starbucks-green);
            margin-bottom: 16px;
        }

        .btn-close-modal {
            padding: 12px 30px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ÂÆûÊó∂Âà∑Êñ∞ÊèêÁ§∫ */
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--starbucks-green);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .refresh-indicator.hidden {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100px); opacity: 0; }
        }

        /* ============ Â¢ûÂº∫ÂèØËßÜÂåñÊ†∑Âºè ============ */

        /* Êé®ËçêÊµÅÁ®ãPipelineÂèØËßÜÂåñ */
        .pipeline-section {
            background: linear-gradient(135deg, #1e3932 0%, #00704a 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            color: white;
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pipeline-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pipeline-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .pipeline-toggle:hover { background: rgba(255,255,255,0.3); }

        .pipeline-steps {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 10px;
            padding-top: 12px;
            margin-top: -8px;
        }

        .pipeline-step {
            flex: 1;
            min-width: 180px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            transition: all 0.3s;
        }

        .pipeline-step.active {
            background: rgba(255,255,255,0.25);
            transform: scale(1.02);
        }

        .pipeline-step.completed {
            background: rgba(34, 197, 94, 0.3);
        }

        .pipeline-step-number {
            position: absolute;
            top: -12px;
            left: -6px;
            min-width: 32px;
            height: 24px;
            padding: 0 8px;
            background: white;
            color: var(--starbucks-green);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .pipeline-step.completed .pipeline-step-number {
            background: #22c55e;
            color: white;
        }

        .pipeline-step-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .pipeline-step-desc {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .pipeline-step-output {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px;
            font-size: 10px;
            font-family: monospace;
            max-height: 60px;
            overflow: hidden;
        }

        .pipeline-step-time {
            margin-top: 8px;
            font-size: 10px;
            opacity: 0.7;
        }

        .pipeline-arrow {
            color: rgba(255,255,255,0.5);
            font-size: 20px;
            flex-shrink: 0;
            margin-top: 30px;
        }

        /* PipelineÊ≠•È™§ÂèØÁÇπÂáª */
        .pipeline-step.clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pipeline-step.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .pipeline-step.clickable:hover .step-hint {
            opacity: 1;
        }
        .step-hint {
            margin-top: 8px;
            font-size: 9px;
            opacity: 0;
            transition: opacity 0.2s;
            color: rgba(255,255,255,0.8);
        }

        /* ‰∏§Èò∂ÊÆµPipelineÂ∏ÉÂ±Ä */
        .pipeline-phase {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .phase-badge {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phase-badge.cust {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .phase-title {
            font-size: 17px;
            font-weight: 700;
            color: white;
        }

        .phase-desc {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            flex: 1;
        }

        .phase-time {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            background: rgba(0,0,0,0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .phase-output {
            margin-top: 16px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .phase-output.cust {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .phase-output .output-label {
            font-size: 12px;
            font-weight: 600;
            color: #22c55e;
        }

        .phase-output.cust .output-label {
            color: #a78bfa;
        }

        .phase-output .output-content {
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }

        /* Èò∂ÊÆµËøûÊé•Âô® */
        .phase-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 0;
            margin: -8px 0;
        }

        .connector-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
        }

        .connector-icon {
            font-size: 24px;
            animation: bounceDown 1.5s infinite;
        }

        .connector-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            background: rgba(0,0,0,0.2);
            padding: 4px 12px;
            border-radius: 12px;
        }

        @keyframes bounceDown {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(4px); }
        }

        /* ÂÆ¢Âà∂ÂåñÈò∂ÊÆµÁöÑÁâπÊÆäÊ†∑Âºè */
        .pipeline-phase.phase-customization {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.1);
        }

        .pipeline-step.cust-step {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .pipeline-step.cust-step.active {
            background: rgba(139, 92, 246, 0.35);
        }

        .pipeline-step.cust-step.completed {
            background: rgba(139, 92, 246, 0.4);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .pipeline-step.cust-step .pipeline-step-number {
            background: #8b5cf6;
            color: white;
        }

        .pipeline-step.cust-step.completed .pipeline-step-number {
            background: #a78bfa;
        }

        .pipeline-arrow.cust {
            color: rgba(167, 139, 250, 0.6);
        }

        /* ÁÆóÊ≥ïËØ¶ÊÉÖÂºπÁ™ó */
        .algorithm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(4px);
        }
        .algorithm-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .algorithm-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .algorithm-modal-overlay.show .algorithm-modal {
            transform: scale(1);
        }
        .algorithm-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #00754a 0%, #1e3932 100%);
            border-radius: 16px 16px 0 0;
        }
        .algorithm-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        .algorithm-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .algorithm-modal-close:hover { background: rgba(255,255,255,0.3); }
        .algorithm-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        .algorithm-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 16px 16px;
        }
        .algorithm-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-nav {
            padding: 10px 20px;
            background: #00754a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-nav:hover:not(:disabled) { background: #005a38; }
        .btn-nav:disabled { background: #ccc; cursor: not-allowed; }
        .step-indicator {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        /* ÂºπÁ™óÂÜÖÂÆπÊ†∑Âºè */
        .detail-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 12px;
        }
        .detail-section.highlight {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #a7f3d0;
        }
        .detail-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #1f2937;
        }
        .detail-section p { margin: 0 0 8px 0; color: #4b5563; line-height: 1.6; }
        .detail-section ul { margin: 8px 0; padding-left: 20px; }
        .detail-section li { margin: 6px 0; color: #4b5563; }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.5;
        }

        .flow-diagram { display: flex; flex-direction: column; gap: 12px; }
        .flow-step {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #00754a;
        }
        .flow-num {
            width: 28px;
            height: 28px;
            background: #00754a;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        .flow-content { flex: 1; }
        .flow-content strong { color: #1f2937; }
        .flow-content p { margin: 4px 0 0 0; font-size: 13px; }
        .flow-content ul { margin: 8px 0 0 0; font-size: 12px; }

        .concept-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .concept-title { font-weight: 700; color: #00754a; margin-bottom: 8px; }
        .vector-visual { margin-top: 12px; }
        .vector-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f1f5f9;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }
        .vector-item .text { color: #0369a1; font-weight: 600; min-width: 100px; }
        .vector-item .arrow { color: #94a3b8; }
        .vector-item .vector { color: #64748b; font-family: monospace; font-size: 11px; }
        .similarity { text-align: center; padding: 8px; color: #16a34a; font-weight: 600; }

        .tech-stack { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .tech-item { background: white; padding: 12px; border-radius: 8px; text-align: center; }
        .tech-name { font-size: 11px; color: #888; margin-bottom: 4px; }
        .tech-value { font-weight: 700; color: #1f2937; font-size: 13px; }

        .cache-diagram { background: white; padding: 12px; border-radius: 8px; }
        .cache-item {
            display: grid;
            grid-template-columns: 60px 80px 1fr 100px;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 11px;
        }
        .cache-item .sku { color: #00754a; font-weight: 600; }
        .cache-item .name { color: #1f2937; }
        .cache-item .desc { color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cache-item .vector { color: #94a3b8; font-family: monospace; }
        .cache-info { text-align: center; padding: 8px; color: #888; font-size: 11px; }

        .formula-card { background: white; padding: 20px; border-radius: 12px; text-align: center; }
        .formula-card.large .formula { font-size: 14px; }
        .formula {
            font-family: 'Monaco', monospace;
            font-size: 16px;
            color: #0369a1;
            padding: 16px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .formula-explain { text-align: left; font-size: 13px; }
        .formula-explain p { margin: 4px 0; }

        .retrieval-flow { display: flex; gap: 16px; }
        .retrieval-step {
            flex: 1;
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .retrieval-step .step-icon { font-size: 24px; margin-bottom: 8px; }
        .retrieval-step strong { display: block; color: #1f2937; margin-bottom: 4px; }
        .retrieval-step p { font-size: 12px; color: #64748b; margin: 0; }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .result-table th, .result-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        .result-table th { background: #f8fafc; font-weight: 600; color: #374151; }
        .result-table .match { color: #16a34a; }
        .result-table .weak { color: #d97706; }

        .factor-detail {
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .factor-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        .factor-icon { font-size: 18px; }
        .factor-name { font-weight: 600; color: #1f2937; }
        .factor-body { padding: 12px 16px; }
        .factor-body p { margin: 0 0 8px 0; font-size: 13px; }
        .factor-body ul { margin: 0; padding-left: 18px; font-size: 12px; }
        .factor-body .example { background: #fef3c7; padding: 8px 12px; border-radius: 6px; font-size: 12px; color: #92400e; }

        .mini-table {
            width: 100%;
            font-size: 12px;
        }
        .mini-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f1f5f9;
        }
        .mini-table td:first-child { font-weight: 600; width: 80px; }

        .rerank-example { background: white; padding: 12px; border-radius: 8px; }
        .rerank-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 12px;
        }
        .rerank-item.boosted { background: #f0fdf4; }
        .rerank-item .rank { font-weight: 700; color: #666; width: 50px; }
        .rerank-item .name { width: 80px; color: #1f2937; }
        .rerank-item .calc { flex: 1; color: #64748b; font-family: monospace; }
        .rerank-item .calc strong { color: #16a34a; }

        .llm-flow { display: flex; flex-direction: column; gap: 8px; }
        .llm-step { background: white; padding: 12px; border-radius: 8px; }
        .llm-step .step-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .llm-arrow {
            text-align: center;
            color: #00754a;
            font-weight: 700;
            padding: 4px;
        }
        .reason-output {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            color: #92400e;
            font-style: italic;
            text-align: center;
        }

        .explainability-card { background: white; padding: 16px; border-radius: 8px; }
        .explain-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .explain-label { width: 80px; font-size: 12px; color: #666; }
        .explain-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .explain-bar .bar-fill { height: 100%; background: #00754a; border-radius: 4px; }
        .explain-value { width: 40px; font-weight: 700; color: #1f2937; font-size: 12px; }

        .style-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .style-table th, .style-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        .style-table th { background: #f8fafc; }
        .style-table td:first-child { font-weight: 600; width: 80px; }
        .style-table td:nth-child(2) { color: #0369a1; font-style: italic; }
        .style-table td:nth-child(3) { color: #888; font-size: 11px; }

        /* ÂÆ¢Âà∂ÂåñÁÆóÊ≥ïÂèØËßÜÂåñÁªÑ‰ª∂ */
        .algorithm-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
        }
        .algorithm-card .algo-title {
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .algorithm-card .algo-formula {
            background: white;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 13px;
            color: #1e3a5f;
            margin-bottom: 12px;
        }
        .algorithm-card .algo-examples {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .algorithm-card .example-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .algorithm-card .example-item .attr {
            font-weight: 600;
            color: #0369a1;
        }
        .algorithm-card .example-item .calc {
            font-size: 11px;
            color: #64748b;
            font-family: monospace;
        }
        .algorithm-card .example-item .score {
            font-weight: 700;
            color: #22c55e;
        }

        /* Â∫ìÂ≠òÊ£ÄÊü•ÁªÑ‰ª∂ */
        .inventory-check {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .inventory-check .inv-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            background: #f8fafc;
        }
        .inventory-check .inv-item.available {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        .inventory-check .inv-item.available .icon { color: #22c55e; }
        .inventory-check .inv-item.low {
            background: #fffbeb;
            border: 1px solid #fde68a;
        }
        .inventory-check .inv-item.low .icon { color: #f59e0b; }
        .inventory-check .inv-item.out {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }
        .inventory-check .inv-item.out .icon { color: #ef4444; }
        .inventory-check .inv-item .name {
            font-weight: 600;
            min-width: 80px;
        }
        .inventory-check .inv-item .status {
            color: #64748b;
            font-size: 12px;
        }

        /* Â¢ûÂº∫ÂàÜÊï∞ÊãÜËß£ÂèØËßÜÂåñ */
        .score-breakdown-enhanced {
            background: #f8fafc;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }

        .score-progress-item {
            margin-bottom: 12px;
        }

        .score-progress-item:last-child {
            margin-bottom: 0;
        }

        .score-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .score-progress-label {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-progress-value {
            font-size: 13px;
            font-weight: 700;
        }

        .score-progress-value.boost { color: #16a34a; }
        .score-progress-value.penalty { color: #dc2626; }
        .score-progress-value.neutral { color: #64748b; }

        .score-progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .score-progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .score-progress-fill.similarity { background: linear-gradient(90deg, #00704a 0%, #1e3932 100%); }
        .score-progress-fill.rule { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); }
        .score-progress-fill.behavior { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
        .score-progress-fill.session { background: linear-gradient(90deg, #8b5cf6 0%, #6d28d9 100%); }
        .score-progress-fill.customization { background: linear-gradient(90deg, #06b6d4 0%, #0891b2 100%); }

        .score-final {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-final-label {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
        }

        .score-final-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--starbucks-green);
        }

        /* ÂÆ¢Âà∂ÂåñÂõ†Á¥†Â±ïÂºÄÈù¢Êùø */
        .customization-factors {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .customization-factors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customization-factors-header:hover {
            background: rgba(0,0,0,0.05);
        }

        .customization-factors-title {
            font-size: 12px;
            font-weight: 600;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customization-factors-toggle {
            font-size: 10px;
            color: #0369a1;
            transition: transform 0.2s;
        }

        .customization-factors-content {
            padding: 0 12px 12px;
            display: none;
        }

        .customization-factors.expanded .customization-factors-content {
            display: block;
        }

        .customization-factors.expanded .customization-factors-toggle {
            transform: rotate(180deg);
        }

        .cust-factor-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .cust-factor-item:last-child {
            border-bottom: none;
        }

        .cust-factor-icon {
            font-size: 16px;
            width: 24px;
            flex-shrink: 0;
        }

        .cust-factor-info {
            flex: 1;
            min-width: 0;
        }

        .cust-factor-name {
            font-size: 12px;
            color: #334155;
            font-weight: 500;
        }

        .cust-factor-desc {
            font-size: 10px;
            color: #64748b;
            margin-top: 2px;
        }

        .cust-factor-bar {
            width: 60px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 8px;
        }

        .cust-factor-bar-fill {
            height: 100%;
            border-radius: 4px;
        }

        .cust-factor-bar-fill.positive { background: #22c55e; }
        .cust-factor-bar-fill.negative { background: #ef4444; }
        .cust-factor-bar-fill.neutral { background: #94a3b8; }

        .cust-factor-value {
            font-size: 12px;
            font-weight: 700;
            width: 50px;
            text-align: right;
        }

        .cust-factor-value.positive { color: #16a34a; }
        .cust-factor-value.negative { color: #dc2626; }
        .cust-factor-value.neutral { color: #64748b; }

        /* ÂÆ¢Âà∂ÂåñÂª∫ËÆÆÂç°ÁâáÂ¢ûÂº∫ */
        .customization-suggestion-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }

        .suggestion-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .suggestion-card-title {
            font-size: 14px;
            font-weight: 700;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .suggestion-confidence {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .suggestion-confidence.high { background: #22c55e; color: white; }
        .suggestion-confidence.medium { background: #f59e0b; color: white; }
        .suggestion-confidence.low { background: #94a3b8; color: white; }

        .suggestion-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: white;
            border-radius: 8px;
        }

        .suggestion-item-icon {
            font-size: 18px;
        }

        .suggestion-item-info {
            flex: 1;
        }

        .suggestion-item-label {
            font-size: 10px;
            color: #64748b;
        }

        .suggestion-item-value {
            font-size: 13px;
            font-weight: 600;
            color: #166534;
        }

        .weather-factor-indicator {
            font-size: 10px;
            cursor: help;
            animation: pulse-weather 2s infinite;
        }

        @keyframes pulse-weather {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .suggestion-item-reason {
            font-size: 9px;
            color: #22c55e;
            margin-top: 2px;
        }

        .suggestion-price {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #86efac;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-price-label {
            font-size: 12px;
            color: #166534;
        }

        .suggestion-price-value {
            font-size: 18px;
            font-weight: 800;
            color: #166534;
        }

        .suggestion-price-adjust {
            font-size: 11px;
            color: #22c55e;
        }

        .suggestion-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-add-suggested {
            flex: 1;
            padding: 10px;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-suggested:hover { background: #15803d; }

        .btn-customize {
            padding: 10px 16px;
            background: white;
            color: #166534;
            border: 2px solid #86efac;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-customize:hover { background: #f0fdf4; }

        /* ÁÆóÊ≥ïÊ¥ûÂØüÂæΩÁ´† */
        .algo-insight-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .algo-insight-badge.new-item { background: #fef3c7; color: #92400e; }
        .algo-insight-badge.seasonal { background: #fce7f3; color: #9d174d; }
        .algo-insight-badge.repurchase { background: #dbeafe; color: #1e40af; }
        .algo-insight-badge.cold-start { background: #e0e7ff; color: #3730a3; }

        /* MOPÈó®Â∫ó‰∏é‰∏ä‰∏ãÊñáÊ†∑Âºè */
        .mop-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .mop-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #22c55e;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .store-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 8px 10px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
        }

        .busy-indicator { font-weight: 600; }
        .busy-indicator.low { color: #22c55e; }
        .busy-indicator.medium { color: #f59e0b; }
        .busy-indicator.high { color: #ef4444; }

        .wait-time { color: #666; }

        .context-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .context-col { }

        .time-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .time-pill {
            padding: 6px 10px;
            border: 1px solid #22c55e;
            background: white;
            border-radius: 16px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-pill:hover { background: #dcfce7; }
        .time-pill.active {
            background: #22c55e;
            color: white;
            font-weight: 600;
        }

        .weather-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .weather-display .weather-icon { font-size: 20px; }
        .weather-display .temp { font-weight: 600; color: #333; }

        .weather-select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 11px;
            background: white;
        }

        .scenario-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .scenario-card {
            padding: 10px 8px;
            background: white;
            border: 2px solid transparent;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-card:hover { border-color: #22c55e; transform: translateY(-1px); }
        .scenario-card.active {
            border-color: #22c55e;
            background: #dcfce7;
        }

        .scenario-icon { font-size: 20px; display: block; margin-bottom: 4px; }
        .scenario-name { font-size: 11px; color: #333; font-weight: 500; }

        /* ‰∏ä‰∏ãÊñáÂõ†Â≠êÈù¢Êùø */
        .context-factors-panel {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
        }

        .context-factors-panel .title {
            font-size: 13px;
            font-weight: 600;
            color: #059669;
            margin-bottom: 10px;
        }

        .context-factor-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .context-factor-row:last-child { border-bottom: none; }

        .context-factor-row .factor-icon { font-size: 14px; width: 20px; }
        .context-factor-row .factor-name { flex: 1; font-size: 12px; color: #333; }
        .context-factor-row .factor-bar {
            width: 60px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        .context-factor-row .factor-bar-fill {
            height: 100%;
            background: #22c55e;
            border-radius: 3px;
        }
        .context-factor-row .factor-value {
            font-size: 11px;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }
        .context-factor-row .factor-value.boost { color: #22c55e; }
        .context-factor-row .factor-value.penalty { color: #ef4444; }

        /* Â∫ìÂ≠òÊ†áÁ≠æ */
        .stock-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        .stock-badge.high { background: #dcfce7; color: #166534; }
        .stock-badge.medium { background: #fef3c7; color: #92400e; }
        .stock-badge.low { background: #fee2e2; color: #991b1b; }
        .stock-badge.out { background: #e5e7eb; color: #6b7280; }

        /* ËΩ¨ÂåñÊºèÊñó */
        .conversion-funnel {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }

        .conversion-funnel .title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .funnel-stages {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
        }

        .funnel-stage {
            text-align: center;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 8px;
            min-width: 60px;
        }

        .funnel-stage.highlight {
            background: #dcfce7;
            border: 2px solid #22c55e;
        }

        .funnel-stage .name { font-size: 10px; color: #666; display: block; }
        .funnel-stage .count { font-size: 14px; font-weight: 700; color: #333; }

        .funnel-arrow {
            font-size: 10px;
            color: #9ca3af;
            padding: 0 2px;
        }

        .total-rate {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            font-size: 12px;
            color: #666;
        }

        .total-rate strong { color: #22c55e; }

        /* A/BÂÆûÈ™åÁªìÊûú */
        .ab-results {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }

        .ab-results .title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .ab-experiment {
            margin-bottom: 12px;
        }

        .ab-experiment .exp-name {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .ab-variants {
            display: flex;
            gap: 8px;
        }

        .ab-variant {
            flex: 1;
            padding: 8px;
            background: #f3f4f6;
            border-radius: 6px;
            text-align: center;
        }

        .ab-variant.winner {
            background: #dcfce7;
            border: 2px solid #22c55e;
        }

        .ab-variant .name { font-size: 11px; color: #666; display: block; }
        .ab-variant .rate { font-size: 14px; font-weight: 700; color: #333; display: block; }
        .ab-variant .lift { font-size: 10px; color: #22c55e; font-weight: 600; }

        .confidence-info {
            margin-top: 8px;
            font-size: 10px;
            color: #9ca3af;
        }

        /* ‰∏ä‰∏ãÊñáËΩ¨ÂåñÂàÜÊûê */
        .context-analysis {
            background: white;
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }

        .context-analysis .title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .context-bars {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 80px;
        }

        .context-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .context-bar .bar {
            width: 100%;
            background: #22c55e;
            border-radius: 4px 4px 0 0;
            min-height: 10px;
        }

        .context-bar .label {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

        .context-bar .value {
            font-size: 10px;
            font-weight: 600;
            color: #333;
        }

    </style>
</head>
<body>
    <header class="demo-header">
        <h1>Êô∫ËÉΩÊé®ËçêÁ≥ªÁªü V3 MOP</h1>
        <p>Èó®Â∫óÈÄâÊã© | ‰∏ä‰∏ãÊñáÊÑüÁü• | A/BÊµãËØï | ‰∏™ÊÄßÂåñÊé®Ëçê | ËΩ¨ÂåñÊºèÊñó</p>
        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 12px;">
            <span class="badge">OpenAI Embedding + GPT-4o-mini</span>
            <a href="/presentation" class="badge" style="text-decoration: none; background: rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.3)'">
                üìä Êü•ÁúãÊäÄÊúØÊñπÊ°àPPT
            </a>
        </div>
    </header>

    <div class="demo-container">
        <!-- Â∑¶‰æßÊéßÂà∂Èù¢Êùø -->
        <div class="panel control-panel">
            <div class="panel-title">ÈÖçÁΩÆÈÄâÈ°π</div>

            <div class="form-group">
                <label class="form-label">ÈÄâÊã©Áî®Êà∑ÁîªÂÉè</label>
                <div class="persona-grid" id="personaGrid">
                    <div class="persona-card selected" data-persona="ÂÅ•Â∫∑Ëææ‰∫∫">
                        <span class="emoji">ü•ó</span>
                        <span>ÂÅ•Â∫∑Ëææ‰∫∫</span>
                    </div>
                    <div class="persona-card" data-persona="ÂíñÂï°ÈáçÂ∫¶Áî®Êà∑">
                        <span class="emoji">‚òï</span>
                        <span>ÂíñÂï°Ëææ‰∫∫</span>
                    </div>
                    <div class="persona-card" data-persona="ÁîúÂìÅÁà±Â•ΩËÄÖ">
                        <span class="emoji">üç∞</span>
                        <span>ÁîúÂìÅÊéß</span>
                    </div>
                    <div class="persona-card" data-persona="Â∞ùÈ≤úÊ¥æ">
                        <span class="emoji">‚ú®</span>
                        <span>Â∞ùÈ≤úÊ¥æ</span>
                    </div>
                    <div class="persona-card" data-persona="ÂÆûÁî®‰∏ª‰πâ">
                        <span class="emoji">üíº</span>
                        <span>ÂÆûÁî®Ê¥æ</span>
                    </div>
                    <div class="persona-card" data-persona="ÂÖªÁîüÁôΩÈ¢Ü">
                        <span class="emoji">üßò</span>
                        <span>ÂÖªÁîüÁôΩÈ¢Ü</span>
                    </div>
                </div>
            </div>

            <!-- MOPÈó®Â∫óÈÄâÊã© -->
            <div class="form-group mop-section">
                <label class="form-label">üìç ÈÄâÊã©ÂèñÈ§êÈó®Â∫ó</label>
                <select id="storeSelect" class="mop-select">
                    <option value="">Ëá™Âä®ÂÆö‰ΩçÊúÄËøëÈó®Â∫ó</option>
                </select>
                <div class="store-info" id="storeInfo" style="display: none;">
                    <span class="busy-indicator" id="busyIndicator">üü¢ Á©∫Èó≤</span>
                    <span class="wait-time" id="waitTime">È¢ÑËÆ°Á≠âÂæÖ 3-5 ÂàÜÈíü</span>
                </div>
            </div>

            <!-- Êó∂ÊÆµ‰∏éÂ§©Ê∞î -->
            <div class="form-group mop-section">
                <div class="context-row">
                    <div class="context-col">
                        <label class="form-label">‚è∞ Êó∂ÊÆµ</label>
                        <div class="time-pills" id="timePills">
                            <button class="time-pill active" data-time="auto">Ëá™Âä®</button>
                            <button class="time-pill" data-time="morning">‚òÄÔ∏è Êó©</button>
                            <button class="time-pill" data-time="lunch">üçΩÔ∏è Âçà</button>
                            <button class="time-pill" data-time="afternoon">‚òï ‰∏ãÂçà</button>
                            <button class="time-pill" data-time="evening">üåô Êôö</button>
                        </div>
                    </div>
                    <div class="context-col">
                        <label class="form-label">üå§Ô∏è Â§©Ê∞î</label>
                        <div class="weather-display" id="weatherDisplay">
                            <span class="weather-icon">‚òÄÔ∏è</span>
                            <span class="temp">25¬∞C</span>
                        </div>
                        <select id="weatherSelect" class="weather-select">
                            <option value="auto">ÂÆûÊó∂Â§©Ê∞î</option>
                            <option value="hot">‚òÄÔ∏è ÁÇéÁÉ≠ 32¬∞C</option>
                            <option value="rainy">üåßÔ∏è Èõ®Â§© 22¬∞C</option>
                            <option value="cold">‚ùÑÔ∏è ÂØíÂÜ∑ 5¬∞C</option>
                            <option value="sunny">üå§Ô∏è Êô¥Êúó 25¬∞C</option>
                            <option value="cloudy">‚òÅÔ∏è Â§ö‰∫ë 20¬∞C</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Âø´ÈÄüÂú∫ÊôØ -->
            <div class="form-group mop-section">
                <label class="form-label">üéØ Âø´ÈÄüÂú∫ÊôØ</label>
                <div class="scenario-cards" id="scenarioCards">
                    <div class="scenario-card" data-scenario="office_morning_rush">
                        <span class="scenario-icon">üè¢</span>
                        <span class="scenario-name">‰∏äÁè≠Êó©È´òÂ≥∞</span>
                    </div>
                    <div class="scenario-card" data-scenario="weekend_leisure">
                        <span class="scenario-icon">üõçÔ∏è</span>
                        <span class="scenario-name">Âë®Êú´‰ºëÈó≤</span>
                    </div>
                    <div class="scenario-card" data-scenario="student_study">
                        <span class="scenario-icon">üìö</span>
                        <span class="scenario-name">Â≠¶‰π†ÂÖÖÁîµ</span>
                    </div>
                    <div class="scenario-card" data-scenario="summer_cool">
                        <span class="scenario-icon">üßä</span>
                        <span class="scenario-name">Â§èÊó•Ê∏ÖÂáâ</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ÂäüËÉΩÂºÄÂÖ≥</label>
                <div class="toggle-group">
                    <div class="toggle-item" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);">
                        <label style="color: #059669; font-weight: 600;">üåç ‰∏ä‰∏ãÊñáÊÑüÁü•</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableContext" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>A/BÊµãËØï</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableABTest" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>ÂéÜÂè≤Ë°å‰∏∫Âä†ÊùÉ</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableBehavior" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>Session‰∏™ÊÄßÂåñ</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableSession" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>Ëß£ÈáäÊÄßÂ¢ûÂº∫</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableExplainability" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);">
                        <label style="color: #0369a1; font-weight: 600;">üé® ÂÆ¢Âà∂ÂåñÊé®Ëçê</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableCustomization" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ëá™ÂÆö‰πâÂÅèÂ•ΩËæìÂÖ• -->
            <div class="custom-preference-section">
                <div class="title">üîç ÊàñËÄÖÔºåÊèèËø∞ÊÇ®ÊÉ≥Ë¶ÅÁöÑÈ•ÆÂìÅ</div>
                <div class="custom-input-group">
                    <input type="text" id="customPreference" placeholder="‰æãÂ¶ÇÔºö‰ΩéÂç°„ÄÅÊèêÁ•û„ÄÅÂÜ∞ÁàΩÁöÑÈ•ÆÂìÅ" maxlength="100">
                    <button class="btn-custom-search" id="btnCustomSearch">Êô∫ËÉΩÂåπÈÖç</button>
                </div>
                <div class="hint-tags">
                    <span class="hint-tag" onclick="addHint('‰ΩéÂç°')">‰ΩéÂç°</span>
                    <span class="hint-tag" onclick="addHint('ÊèêÁ•û')">ÊèêÁ•û</span>
                    <span class="hint-tag" onclick="addHint('ÁîúËúú')">ÁîúËúú</span>
                    <span class="hint-tag" onclick="addHint('ÂÜ∞ÁàΩ')">ÂÜ∞ÁàΩ</span>
                    <span class="hint-tag" onclick="addHint('Ê§çÁâ©Â•∂')">Ê§çÁâ©Â•∂</span>
                    <span class="hint-tag" onclick="addHint('Êó†ÂíñÂï°Âõ†')">Êó†ÂíñÂï°Âõ†</span>
                </div>
            </div>

            <button class="btn-recommend" id="btnRecommend">Ëé∑ÂèñÊé®Ëçê</button>

            <div class="stats-card" id="metricsCard" style="display: none;">
                <div class="stats-row">
                    <span class="label">ÊÄªËÄóÊó∂</span>
                    <span class="value" id="metricTime">-</span>
                </div>
                <div class="stats-row">
                    <span class="label">LLMË∞ÉÁî®</span>
                    <span class="value" id="metricLLM">-</span>
                </div>
                <div class="stats-row">
                    <span class="label">Âπ≥ÂùáÂåπÈÖçÂ∫¶</span>
                    <span class="value" id="metricScore">-</span>
                </div>
            </div>
        </div>

        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content panel">
            <!-- ÂÆ¢Âà∂ÂåñÈ¢ÑËÆæÊºîÁ§∫ -->
            <div class="preset-section" id="presetSection">
                <div class="preset-title">
                    üé® ÂÆ¢Âà∂ÂåñÈ¢ÑËÆæÁÆ°ÁêÜ
                </div>
                <div class="preset-controls">
                    <button class="btn-preset" id="btnCreatePreset">
                        ‚ûï ÂàõÂª∫È¢ÑËÆæ
                    </button>
                    <button class="btn-preset" id="btnLoadPresets" style="background: #7e22ce;">
                        üìã Âä†ËΩΩÊàëÁöÑÈ¢ÑËÆæ
                    </button>
                    <div class="order-status" id="presetStatus" style="background: rgba(255,255,255,0.8);">
                        ÂàõÂª∫È¢ÑËÆæ‰ª•Âø´ÈÄüÂ∫îÁî®ÊÇ®ÁöÑÂÅèÂ•ΩËÆæÁΩÆ
                    </div>
                </div>
                <div class="preset-list" id="presetList"></div>
            </div>

            <!-- ËÆ¢ÂçïÂéÜÂè≤ÂØπÊØîÊºîÁ§∫ -->
            <div class="comparison-section" id="comparisonSection">
                <div class="comparison-title">
                    üìä ËÆ¢ÂçïÂéÜÂè≤ÊùÉÈáçÂØπÊØîÊºîÁ§∫
                </div>
                <div class="comparison-controls">
                    <button class="btn-simulate" id="btnSimulateOrders">
                        üé≤ Ê®°ÊãüÁîüÊàêËÆ¢ÂçïÂéÜÂè≤
                    </button>
                    <button class="btn-compare" id="btnCompare">
                        ‚ö° ÂØπÊØîÊé®ËçêÊïàÊûú
                    </button>
                    <div class="order-status" id="orderStatus">
                        ÊöÇÊó†Ê®°ÊãüËÆ¢Âçï
                    </div>
                </div>
                <div class="comparison-grid" id="comparisonGrid" style="display: none;">
                    <!-- Â∑¶‰æßÔºöÊúâËÆ¢ÂçïÂéÜÂè≤Áî®Êà∑ -->
                    <div class="comparison-column">
                        <div class="comparison-column-title old-user">
                            üë§ ËÄÅÁî®Êà∑ (ÊúâËÆ¢ÂçïÂéÜÂè≤)
                            <span id="oldUserOrderCount" style="font-weight: normal; font-size: 12px;"></span>
                        </div>
                        <div id="oldUserRecs"></div>
                    </div>
                    <!-- Âè≥‰æßÔºöÊñ∞Áî®Êà∑ -->
                    <div class="comparison-column">
                        <div class="comparison-column-title new-user">
                            üÜï Êñ∞Áî®Êà∑ (Êó†ËÆ¢ÂçïÂéÜÂè≤)
                        </div>
                        <div id="newUserRecs"></div>
                    </div>
                </div>
                <div class="comparison-summary" id="comparisonSummary" style="display: none;">
                    <h4>ÂØπÊØîÁªìËÆ∫</h4>
                    <div class="summary-stats" id="summaryStats"></div>
                </div>
            </div>

            <!-- Êé®ËçêÊµÅÁ®ãPipelineÂèØËßÜÂåñ - ‰∏§Èò∂ÊÆµÊû∂ÊûÑ -->
            <div id="pipelineSection" class="pipeline-section" style="display: none;">
                <div class="pipeline-header">
                    <div class="pipeline-title">
                        üîÑ Êé®ËçêÁÆóÊ≥ïÊâßË°åÊµÅÁ®ã
                    </div>
                    <button class="pipeline-toggle" onclick="togglePipeline()">Êî∂Ëµ∑</button>
                </div>

                <!-- Èò∂ÊÆµ‰∏ÄÔºöÂçÉÂ∫óÂçÉÈù¢ÂïÜÂìÅÊé®Ëçê -->
                <div class="pipeline-phase" id="phase1">
                    <div class="phase-header">
                        <div class="phase-badge">Èò∂ÊÆµ 1</div>
                        <div class="phase-title">üè™ ÂçÉÂ∫óÂçÉÈù¢ ¬∑ ÂïÜÂìÅÊé®Ëçê</div>
                        <div class="phase-desc">Âü∫‰∫éÈó®Â∫óSPU/SKUÁöÑ‰∏™ÊÄßÂåñÂïÜÂìÅÂåπÈÖç</div>
                        <div class="phase-time" id="phase1Time">-</div>
                    </div>
                    <div class="pipeline-steps" id="pipelineSteps">
                        <div class="pipeline-step clickable" id="step1" onclick="showAlgorithmDetail(1)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">1.1</div>
                            <div class="pipeline-step-title">üë§ Áî®Êà∑ÁîªÂÉè</div>
                            <div class="pipeline-step-desc">Persona ‚Üí ÊêúÁ¥¢Query</div>
                            <div class="pipeline-step-output" id="step1Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step1Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                        <div class="pipeline-arrow">‚Üí</div>
                        <div class="pipeline-step clickable" id="step2" onclick="showAlgorithmDetail(2)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">1.2</div>
                            <div class="pipeline-step-title">üî¢ ÂêëÈáèÂåñ</div>
                            <div class="pipeline-step-desc">text-embedding-3-small</div>
                            <div class="pipeline-step-output" id="step2Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step2Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                        <div class="pipeline-arrow">‚Üí</div>
                        <div class="pipeline-step clickable" id="step3" onclick="showAlgorithmDetail(3)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">1.3</div>
                            <div class="pipeline-step-title">üè™ Èó®Â∫óÂè¨Âõû</div>
                            <div class="pipeline-step-desc">Èó®Â∫óSPU/SKU √ó ‰ΩôÂº¶Áõ∏‰ººÂ∫¶</div>
                            <div class="pipeline-step-output" id="step3Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step3Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                        <div class="pipeline-arrow">‚Üí</div>
                        <div class="pipeline-step clickable" id="step4" onclick="showAlgorithmDetail(4)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">1.4</div>
                            <div class="pipeline-step-title">‚öñÔ∏è Â§öÂõ†Á¥†ÈáçÊéí</div>
                            <div class="pipeline-step-desc">ËßÑÂàô√óË°å‰∏∫√óÂ∫ìÂ≠ò√ó‰∏ä‰∏ãÊñá</div>
                            <div class="pipeline-step-output" id="step4Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step4Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                    </div>
                    <div class="phase-output">
                        <div class="output-label">üì¶ ËæìÂá∫</div>
                        <div class="output-content" id="phase1Output">Top-K ÂïÜÂìÅÂÄôÈÄâÈõÜ (SKU + Âü∫Á°ÄÂ±ûÊÄß + ÂåπÈÖçÂàÜÊï∞)</div>
                    </div>
                </div>

                <!-- Èò∂ÊÆµÈó¥ËøûÊé• -->
                <div class="phase-connector">
                    <div class="connector-line"></div>
                    <div class="connector-icon">‚¨áÔ∏è</div>
                    <div class="connector-label">ÂïÜÂìÅÁ°ÆÂÆöÂêéÔºåËøõÂÖ•ÂÆ¢Âà∂Âåñ</div>
                </div>

                <!-- Èò∂ÊÆµ‰∫åÔºöÂÆ¢Âà∂ÂåñÂ±ûÊÄßÊé®Ëçê -->
                <div class="pipeline-phase phase-customization" id="phase2">
                    <div class="phase-header">
                        <div class="phase-badge cust">Èò∂ÊÆµ 2</div>
                        <div class="phase-title">üé® ÂÆ¢Âà∂Âåñ ¬∑ Â±ûÊÄßÊé®Ëçê</div>
                        <div class="phase-desc">Âü∫‰∫éÁî®Êà∑ÂÅèÂ•ΩÁöÑ‰∏™ÊÄßÂåñÂÆöÂà∂Âª∫ËÆÆ</div>
                        <div class="phase-time" id="phase2Time">-</div>
                    </div>
                    <div class="pipeline-steps">
                        <div class="pipeline-step clickable cust-step" id="step5" onclick="showAlgorithmDetail(5)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">2.1</div>
                            <div class="pipeline-step-title">üìä ÂÅèÂ•ΩÂàÜÊûê</div>
                            <div class="pipeline-step-desc">ÂéÜÂè≤ËÆ¢Âçï ‚Üí ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÊ®°Âûã</div>
                            <div class="pipeline-step-output" id="step5Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step5Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                        <div class="pipeline-arrow cust">‚Üí</div>
                        <div class="pipeline-step clickable cust-step" id="step6" onclick="showAlgorithmDetail(6)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">2.2</div>
                            <div class="pipeline-step-title">üéØ Â±ûÊÄßÊé®Ëçê</div>
                            <div class="pipeline-step-desc">Ê∏©Â∫¶/ÊùØÂûã/Á≥ñÂ∫¶/Â•∂Á±ª</div>
                            <div class="pipeline-step-output" id="step6Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step6Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                        <div class="pipeline-arrow cust">‚Üí</div>
                        <div class="pipeline-step clickable cust-step" id="step7" onclick="showAlgorithmDetail(7)" title="ÁÇπÂáªÊü•ÁúãÁÆóÊ≥ïËØ¶ÊÉÖ">
                            <div class="pipeline-step-number">2.3</div>
                            <div class="pipeline-step-title">üí¨ ÁêÜÁî±ÁîüÊàê</div>
                            <div class="pipeline-step-desc">LLMÁîüÊàêÊé®ËçêËß£Èáä</div>
                            <div class="pipeline-step-output" id="step7Output">Á≠âÂæÖÊâßË°å...</div>
                            <div class="pipeline-step-time" id="step7Time">-</div>
                            <div class="step-hint">üîç ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ</div>
                        </div>
                    </div>
                    <div class="phase-output cust">
                        <div class="output-label">üé® ËæìÂá∫</div>
                        <div class="output-content" id="phase2Output">ÊØè‰∏™ÂïÜÂìÅÁöÑÊé®ËçêÂÆ¢Âà∂ÂåñÈÖçÁΩÆ + ‰∏™ÊÄßÂåñÁêÜÁî±</div>
                    </div>
                </div>
            </div>

            <div class="panel-title">Êé®ËçêÁªìÊûú</div>

            <div id="experimentBanner" class="experiment-banner" style="display: none;">
                <div class="title">A/BÂÆûÈ™åÂàÜÁªÑ</div>
                <div class="variants" id="experimentVariants"></div>
            </div>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 16px;">Ê≠£Âú®ÁîüÊàê‰∏™ÊÄßÂåñÊé®Ëçê...</p>
            </div>

            <div id="recommendationsGrid" class="recommendations-grid">
                <div style="text-align: center; padding: 60px; color: #888;">
                    <p>ÈÄâÊã©Áî®Êà∑ÁîªÂÉèÂπ∂ÁÇπÂáª„ÄåËé∑ÂèñÊé®Ëçê„Äç</p>
                </div>
            </div>
        </div>

        <!-- Âè≥‰æßÈù¢Êùø -->
        <div class="panel side-panel">
            <div class="panel-title">SessionÁä∂ÊÄÅ</div>

            <div class="session-info">
                <div class="title">ÂΩìÂâç‰ºöËØù</div>
                <div>Session ID: <span id="sessionId">-</span></div>
                <div>User ID: <span id="userId">-</span></div>
                <div>‰∫§‰∫íÊ¨°Êï∞: <span id="interactionCount">0</span></div>
            </div>

            <!-- ÂÆûÊó∂Ê¥ªÂä®Êó•Âøó -->
            <div class="activity-log-section">
                <div class="activity-log-header">
                    <span class="label">üìä ÂÆûÊó∂Ê¥ªÂä®Êó•Âøó</span>
                    <button class="btn-demo-interactions" id="btnDemoInteractions" title="Ê®°ÊãüÁî®Êà∑‰∫§‰∫í">üéØ Âø´ÈÄüÊºîÁ§∫</button>
                </div>
                <div class="activity-log" id="activityLog">
                    <div class="activity-empty">Á≠âÂæÖÁî®Êà∑‰∫§‰∫í...</div>
                </div>
            </div>

            <div class="realtime-prefs">
                <div class="pref-section">
                    <div class="label">‚úÖ ÂÆûÊó∂ÂñúÂ•ΩÊ†áÁ≠æ <span class="tag-count" id="likedCount">(0)</span></div>
                    <div class="pref-tags" id="likedTags">
                        <span style="color: #888; font-size: 11px;">ÁÇπÂáªÊé®ËçêÂç°ÁâáÁöÑüëçÊî∂ÈõÜÂÅèÂ•Ω</span>
                    </div>
                </div>
                <div class="pref-section">
                    <div class="label">‚ùå ÂÆûÊó∂ÊéíÊñ•Ê†áÁ≠æ <span class="tag-count" id="dislikedCount">(0)</span></div>
                    <div class="pref-tags" id="dislikedTags">
                        <span style="color: #888; font-size: 11px;">ÁÇπÂáªÊé®ËçêÂç°ÁâáÁöÑüëéÊî∂ÈõÜÂÅèÂ•Ω</span>
                    </div>
                </div>
            </div>

            <!-- ‰∏ä‰∏ãÊñáÂõ†Â≠êÂÆûÊó∂Â±ïÁ§∫ -->
            <div class="context-realtime-section" id="contextRealtimeSection" style="display: none;">
                <div class="label">üåç ÂΩìÂâç‰∏ä‰∏ãÊñáÂõ†Â≠ê</div>
                <div class="context-factors-mini" id="contextFactorsMini"></div>
            </div>

            <div id="explanationPanel" class="explanation-panel" style="display: none;">
                <div class="title">Êé®ËçêËß£Èáä (Top 1)</div>
                <div id="explanationContent"></div>
            </div>

            <div id="custPrefsPanel" class="cust-prefs-panel" style="display: none;">
                <div class="title">üé® ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÂàÜÊûê</div>
                <div id="custPrefsContent">
                    <div class="pref-section">
                        <div class="label">Ê∏©Â∫¶ÂÅèÂ•Ω</div>
                        <div id="tempPref" class="pref-value empty">ÊöÇÊó†Êï∞ÊçÆ</div>
                    </div>
                    <div class="pref-section">
                        <div class="label">Â•∂Á±ªÂÅèÂ•Ω</div>
                        <div id="milkPref" class="pref-value empty">ÊöÇÊó†Êï∞ÊçÆ</div>
                    </div>
                    <div class="pref-section">
                        <div class="label">Á≥ñÂ∫¶ÂÅèÂ•Ω</div>
                        <div id="sugarPref" class="pref-value empty">ÊöÇÊó†Êï∞ÊçÆ</div>
                    </div>
                    <div class="pref-section">
                        <div class="label">ÂÆ¢Âà∂ÂåñÂÖ≥ÈîÆËØç</div>
                        <div id="custKeywords" class="pref-value empty">ÊöÇÊó†Êï∞ÊçÆ</div>
                    </div>
                </div>
            </div>

            <!-- Ë¥≠Áâ©ËΩ¶ -->
            <div class="cart-section" id="cartSection">
                <div class="cart-header">
                    <div class="cart-title">
                        üõí Ë¥≠Áâ©ËΩ¶
                        <span class="cart-badge" id="cartBadge">0</span>
                    </div>
                    <button class="btn-clear-cart" id="btnClearCart" style="display: none;">Ê∏ÖÁ©∫</button>
                </div>
                <div class="cart-items" id="cartItems">
                    <div class="cart-empty">Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ</div>
                </div>
                <div class="cart-footer" id="cartFooter" style="display: none;">
                    <div class="cart-total">
                        <span class="cart-total-label">ÂêàËÆ°</span>
                        <span class="cart-total-value" id="cartTotal">¬•0.00</span>
                    </div>
                    <button class="btn-checkout" id="btnCheckout">ÂéªÁªìÁÆó</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Âà∑Êñ∞ÊèêÁ§∫ -->
    <div class="refresh-indicator" id="refreshIndicator" style="display: none;">
        <div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
        <span>Ê≠£Âú®Êõ¥Êñ∞Êé®Ëçê...</span>
    </div>

    <!-- ËÆ¢ÂçïÊàêÂäüÂºπÁ™ó -->
    <div class="order-modal" id="orderModal" style="display: none;">
        <div class="order-modal-content">
            <div class="order-modal-icon">‚úÖ</div>
            <div class="order-modal-title">‰∏ãÂçïÊàêÂäüÔºÅ</div>
            <div class="order-modal-id" id="modalOrderId">ËÆ¢ÂçïÂè∑: -</div>
            <div class="order-modal-items" id="modalOrderItems"></div>
            <div class="order-modal-total" id="modalOrderTotal">¬•0.00</div>
            <button class="btn-close-modal" onclick="closeOrderModal()">Á°ÆÂÆö</button>
        </div>
    </div>

    <script>
        // ÁîüÊàêÂîØ‰∏ÄID
        const sessionId = 'session_' + Date.now();
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);

        document.getElementById('sessionId').textContent = sessionId.substr(0, 16) + '...';
        document.getElementById('userId').textContent = userId;

        let selectedPersona = 'ÂÅ•Â∫∑Ëææ‰∫∫';
        let interactionCount = 0;
        let currentRecommendations = [];

        // MOP‰∏ä‰∏ãÊñáÁä∂ÊÄÅ
        let selectedStoreId = '';
        let selectedTimeOfDay = 'auto';
        let selectedWeather = 'auto';
        let selectedScenario = '';
        let storesData = [];
        let currentCity = '‰∏äÊµ∑';  // ÂΩìÂâçÈÄâ‰∏≠ÂüéÂ∏Ç

        // A/BÂÆûÈ™åÂÖÉÊï∞ÊçÆÈÖçÁΩÆ
        const experimentMetadata = {
            'rec_algorithm': {
                icon: 'ü§ñ',
                name: 'Êé®ËçêÁÆóÊ≥ï',
                variants: {
                    'embedding': { name: 'EmbeddingËØ≠‰πâ', desc: 'Âü∫‰∫éÂêëÈáèËØ≠‰πâÁõ∏‰ººÂ∫¶ÂåπÈÖç', impact: 'Á≤æÂáÜÂåπÈÖçÁî®Êà∑ÊÑèÂõæ' },
                    'embedding_plus': { name: 'Embedding+Ë°å‰∏∫', desc: 'ËØ≠‰πâ+ÂéÜÂè≤Ë°å‰∏∫Âä†ÊùÉ', impact: '‰∏™ÊÄßÂåñÊùÉÈáçÊèêÂçá20%' },
                    'hybrid': { name: 'Ê∑∑ÂêàÊé®Ëçê', desc: 'ËØ≠‰πâ+ËßÑÂàô+ÁÉ≠Â∫¶ÁªºÂêà', impact: 'Â§öÁª¥Â∫¶‰ºòÂåñÊéíÂ∫è' },
                    'control': { name: 'ÂØπÁÖßÁªÑ', desc: 'Âü∫Á°ÄEmbeddingÂåπÈÖç', impact: 'Âü∫ÂáÜÂØπÊØî' }
                }
            },
            'reason_style': {
                icon: 'üí¨',
                name: 'ÁêÜÁî±È£éÊ†º',
                variants: {
                    'concise': { name: 'ÁÆÄÊ¥ÅÁâà', desc: '‰∏ÄÂè•ËØùÊé®ËçêÁêÜÁî±', impact: 'ÈòÖËØªÊïàÁéáÈ´ò' },
                    'detailed': { name: 'ËØ¶ÁªÜÁâà', desc: 'Â§öÁª¥Â∫¶Ëß£ÈáäÊé®ËçêÂéüÂõ†', impact: 'ÂÜ≥Á≠ñ‰ø°ÊÅØ‰∏∞ÂØå' },
                    'control': { name: 'ÂØπÁÖßÁªÑ', desc: 'Ê†áÂáÜÊé®ËçêÁêÜÁî±', impact: 'Âü∫ÂáÜÂØπÊØî' }
                }
            },
            'customization_strategy': {
                icon: 'üé®',
                name: 'ÂÆ¢Âà∂ÂåñÁ≠ñÁï•',
                variants: {
                    'user_history': { name: 'ÂéÜÂè≤ÂÅèÂ•Ω', desc: 'Âü∫‰∫éÁî®Êà∑ËøáÂæÄËÆ¢Âçï', impact: 'Â§çË¥≠ËΩ¨ÂåñÊèêÂçá15%' },
                    'item_popular': { name: 'ÁÉ≠Èó®ÈÖçÁΩÆ', desc: 'Âü∫‰∫éÂïÜÂìÅÁïÖÈîÄÊê≠ÈÖç', impact: 'Êñ∞Áî®Êà∑ÂèãÂ•Ω' },
                    'hybrid': { name: 'Ê∑∑ÂêàÁ≠ñÁï•', desc: 'ÂéÜÂè≤+ÁÉ≠Èó®Êô∫ËÉΩËûçÂêà', impact: 'Ë¶ÜÁõñÁéáÊúÄ‰ºò' },
                    'control': { name: 'ÂØπÁÖßÁªÑ', desc: 'ÈªòËÆ§ÈÖçÁΩÆÊé®Ëçê', impact: 'Âü∫ÂáÜÂØπÊØî' }
                }
            },
            'context_weight': {
                icon: 'üåç',
                name: '‰∏ä‰∏ãÊñáÊùÉÈáç',
                variants: {
                    'low': { name: '‰ΩéÊùÉÈáç', desc: '‰∏ä‰∏ãÊñáÂΩ±ÂìçÂõ†Â≠ê1.1x', impact: 'ÂèòÂåñÂπ≥Áºì' },
                    'medium': { name: '‰∏≠ÊùÉÈáç', desc: '‰∏ä‰∏ãÊñáÂΩ±ÂìçÂõ†Â≠ê1.3x', impact: 'Âπ≥Ë°°Êé®Ëçê' },
                    'high': { name: 'È´òÊùÉÈáç', desc: '‰∏ä‰∏ãÊñáÂΩ±ÂìçÂõ†Â≠ê1.5x', impact: 'Âú∫ÊôØÊïèÊÑü' },
                    'control': { name: 'ÂØπÁÖßÁªÑ', desc: 'Ê†áÂáÜ‰∏ä‰∏ãÊñáÊùÉÈáç', impact: 'Âü∫ÂáÜÂØπÊØî' }
                }
            },
            'weather_adaptation': {
                icon: 'üå°Ô∏è',
                name: 'Â§©Ê∞îÈÄÇÈÖç',
                variants: {
                    'none': { name: '‰∏çÂêØÁî®', desc: '‰∏çËÄÉËôëÂ§©Ê∞îÂõ†Á¥†', impact: 'Êó†Â§©Ê∞îÂΩ±Âìç' },
                    'temperature_only': { name: '‰ªÖÊ∏©Â∫¶', desc: 'Âè™Ê†πÊçÆÊ∏©Â∫¶Ë∞ÉÊï¥', impact: 'ÂÜ∑ÁÉ≠È•ÆÂìÅÈÄÇÈÖç' },
                    'full': { name: 'ÂÆåÊï¥ÈÄÇÈÖç', desc: 'Ê∏©Â∫¶+Â§©Ê∞îÁä∂ÂÜµÁªºÂêà', impact: 'Âú∫ÊôØÂåπÈÖçÂ∫¶+25%' },
                    'control': { name: 'ÂØπÁÖßÁªÑ', desc: 'Âü∫Á°ÄÂ§©Ê∞îÈÄÇÈÖç', impact: 'Âü∫ÂáÜÂØπÊØî' }
                }
            },
            'customization_display': {
                icon: 'üìã',
                name: 'Â±ïÁ§∫ÊñπÂºè',
                variants: {
                    'inline': { name: 'ÂÜÖËÅîÂ±ïÁ§∫', desc: 'ÂÆ¢Âà∂ÂåñÈÄâÈ°πÁõ¥Êé•ÊòæÁ§∫', impact: 'Êìç‰ΩúÊ≠•È™§Â∞ë' },
                    'expandable': { name: 'ÂèØÂ±ïÂºÄ', desc: 'ÁÇπÂáªÂ±ïÂºÄËØ¶ÁªÜÈÄâÈ°π', impact: 'ÁïåÈù¢ÁÆÄÊ¥Å' },
                    'control': { name: 'ÂØπÁÖßÁªÑ', desc: 'ÈªòËÆ§Â±ïÁ§∫ÊñπÂºè', impact: 'Âü∫ÂáÜÂØπÊØî' }
                }
            }
        };

        // Ê∏≤ÊüìÂ¢ûÂº∫ÁâàÂÆûÈ™åÂàÜÁªÑ
        function renderExperimentBanner(experimentData) {
            const banner = document.getElementById('experimentBanner');
            const variants = document.getElementById('experimentVariants');

            if (!experimentData || Object.keys(experimentData).length === 0) {
                banner.style.display = 'none';
                return;
            }

            variants.innerHTML = '';

            for (const [expId, info] of Object.entries(experimentData)) {
                const variantId = info.variant || info;
                const meta = experimentMetadata[expId];
                const variantMeta = meta?.variants?.[variantId] || meta?.variants?.['control'] || {};

                const isControl = variantId === 'control' || variantId === info.variant;
                const isTreatment = variantId !== 'control' && !variantId.includes('control');

                const tag = document.createElement('div');
                tag.className = `variant-tag ${isTreatment ? 'treatment' : ''}`;
                tag.innerHTML = `
                    <div class="exp-header">
                        <span class="exp-name">
                            <span>${meta?.icon || 'üî¨'}</span>
                            ${meta?.name || expId}
                        </span>
                        <span class="exp-variant">${variantMeta.name || variantId}</span>
                    </div>
                    <div class="exp-desc">${variantMeta.desc || info.experiment_name || 'ÂÆûÈ™åËøõË°å‰∏≠'}</div>
                    <div class="exp-impact ${isTreatment ? 'positive' : 'neutral'}">
                        ${isTreatment ? '‚ö°' : 'üìä'} ${variantMeta.impact || 'Êï∞ÊçÆÊî∂ÈõÜ‰∏≠'}
                    </div>
                `;
                variants.appendChild(tag);
            }

            banner.style.display = 'block';
        }

        // Êõ¥Êñ∞Â§©Ê∞îÊòæÁ§∫
        async function updateWeatherDisplay(city) {
            if (selectedWeather !== 'auto') return;  // Â¶ÇÊûú‰∏çÊòØÂÆûÊó∂Â§©Ê∞îÊ®°ÂºèÔºå‰∏çÊõ¥Êñ∞

            try {
                const response = await fetch(`/api/weather?city=${encodeURIComponent(city)}`);
                const data = await response.json();
                if (data.icon && data.temperature !== undefined) {
                    document.querySelector('#weatherDisplay .weather-icon').textContent = data.icon;
                    document.querySelector('#weatherDisplay .temp').textContent = `${data.temperature}¬∞C`;
                    currentCity = city;
                    console.log(`Â§©Ê∞îÂ∑≤Êõ¥Êñ∞: ${city} ${data.temperature}¬∞C ${data.icon}`);
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Â§©Ê∞îÂ§±Ë¥•:', error);
            }
        }

        // ÂàùÂßãÂåñMOPÊéß‰ª∂
        async function initMOPControls() {
            // Âä†ËΩΩÈó®Â∫óÂàóË°®
            try {
                const response = await fetch('/api/stores');
                const data = await response.json();
                storesData = data.stores || [];

                const storeSelect = document.getElementById('storeSelect');
                storesData.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.store_id;
                    option.textContent = `${store.name} (${store.city})`;
                    storeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Âä†ËΩΩÈó®Â∫óÂ§±Ë¥•:', error);
            }

            // Âä†ËΩΩÈªòËÆ§Â§©Ê∞î‰ø°ÊÅØÔºà‰∏äÊµ∑Ôºâ
            await updateWeatherDisplay('‰∏äÊµ∑');

            // Èó®Â∫óÈÄâÊã©‰∫ã‰ª∂
            document.getElementById('storeSelect').addEventListener('change', async function() {
                selectedStoreId = this.value;
                const storeInfo = document.getElementById('storeInfo');

                if (selectedStoreId) {
                    const store = storesData.find(s => s.store_id === selectedStoreId);
                    if (store) {
                        storeInfo.style.display = 'flex';
                        const busyIndicator = document.getElementById('busyIndicator');
                        const waitTime = document.getElementById('waitTime');

                        if (store.busy_level === 'low') {
                            busyIndicator.textContent = 'üü¢ Á©∫Èó≤';
                            busyIndicator.className = 'busy-indicator low';
                        } else if (store.busy_level === 'medium') {
                            busyIndicator.textContent = 'üü° ÈÄÇ‰∏≠';
                            busyIndicator.className = 'busy-indicator medium';
                        } else {
                            busyIndicator.textContent = 'üî¥ ÁπÅÂøô';
                            busyIndicator.className = 'busy-indicator high';
                        }

                        waitTime.textContent = `È¢ÑËÆ°Á≠âÂæÖ ${store.wait_minutes} ÂàÜÈíü`;

                        // Ê†πÊçÆÈó®Â∫óÂüéÂ∏ÇÊõ¥Êñ∞Â§©Ê∞î
                        if (store.city && store.city !== currentCity) {
                            await updateWeatherDisplay(store.city);
                        }

                        // ËÆ∞ÂΩïÊ¥ªÂä®Êó•Âøó
                        addActivityLog('context', `ÈÄâÊã©Èó®Â∫ó: ${store.name.split('(')[1]?.replace(')','') || store.city}`, 'üìç');
                    }
                } else {
                    storeInfo.style.display = 'none';
                    // ÊÅ¢Â§çÈªòËÆ§ÂüéÂ∏ÇÂ§©Ê∞î
                    if (currentCity !== '‰∏äÊµ∑') {
                        await updateWeatherDisplay('‰∏äÊµ∑');
                    }
                    addActivityLog('context', `ÂèñÊ∂àÈó®Â∫óÈÄâÊã©`, 'üìç');
                }
            });

            // Êó∂ÊÆµÈÄâÊã©‰∫ã‰ª∂
            const timeLabels = { 'auto': 'Ëá™Âä®', 'morning': 'Êó©Êô®', 'lunch': 'ÂçàÈ§ê', 'afternoon': '‰∏ãÂçà', 'evening': 'ÊôöÈó¥' };
            document.querySelectorAll('.time-pill').forEach(pill => {
                pill.addEventListener('click', function() {
                    document.querySelectorAll('.time-pill').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    selectedTimeOfDay = this.dataset.time;
                    addActivityLog('context', `ÂàáÊç¢Êó∂ÊÆµ: ${timeLabels[selectedTimeOfDay] || selectedTimeOfDay}`, '‚è∞');
                });
            });

            // Â§©Ê∞îÈÄâÊã©‰∫ã‰ª∂
            const weatherLabels = { 'auto': 'ÂÆûÊó∂Â§©Ê∞î', 'hot': 'ÁÇéÁÉ≠', 'rainy': 'Èõ®Â§©', 'cold': 'ÂØíÂÜ∑', 'sunny': 'Êô¥Êúó', 'cloudy': 'Â§ö‰∫ë' };
            document.getElementById('weatherSelect').addEventListener('change', async function() {
                selectedWeather = this.value;
                const display = document.getElementById('weatherDisplay');

                if (selectedWeather === 'auto') {
                    // ÂàáÂõûÂÆûÊó∂Â§©Ê∞îÔºåËé∑ÂèñÂΩìÂâçÂüéÂ∏ÇÁöÑÂ§©Ê∞î
                    await updateWeatherDisplay(currentCity);
                    addActivityLog('context', `ÂàáÊç¢Â§©Ê∞î: ${currentCity} ÂÆûÊó∂Â§©Ê∞î`, 'üå§Ô∏è');
                } else {
                    // ‰ΩøÁî®Ê®°ÊãüÂ§©Ê∞î
                    const weatherIcons = {
                        'hot': '‚òÄÔ∏è', 'rainy': 'üåßÔ∏è',
                        'cold': '‚ùÑÔ∏è', 'sunny': 'üå§Ô∏è', 'cloudy': '‚òÅÔ∏è'
                    };
                    const weatherTemps = {
                        'hot': 32, 'rainy': 22,
                        'cold': 5, 'sunny': 25, 'cloudy': 20
                    };

                    display.querySelector('.weather-icon').textContent = weatherIcons[selectedWeather] || 'üå§Ô∏è';
                    display.querySelector('.temp').textContent = `${weatherTemps[selectedWeather] || 25}¬∞C`;
                    addActivityLog('context', `Ê®°ÊãüÂ§©Ê∞î: ${weatherLabels[selectedWeather] || selectedWeather} ${weatherTemps[selectedWeather]}¬∞C`, 'üå°Ô∏è');
                }
            });

            // Âú∫ÊôØÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.addEventListener('click', function() {
                    const wasActive = this.classList.contains('active');
                    document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));

                    if (!wasActive) {
                        this.classList.add('active');
                        selectedScenario = this.dataset.scenario;
                        const scenarioName = this.querySelector('.scenario-name')?.textContent || selectedScenario;
                        addActivityLog('context', `ÈÄâÊã©Âú∫ÊôØ: ${scenarioName}`, 'üéØ');
                    } else {
                        selectedScenario = '';
                        addActivityLog('context', `ÂèñÊ∂àÂú∫ÊôØÈÄâÊã©`, 'üéØ');
                    }
                });
            });
        }

        // Ê∏≤Êüì‰∏ä‰∏ãÊñáÂõ†Â≠êÈù¢Êùø
        function renderContextFactors(contextFactors) {
            if (!contextFactors || Object.keys(contextFactors).length === 0) return '';

            const factorIcons = {
                'time_factor': '‚è∞',
                'weather_factor': 'üå°Ô∏è',
                'store_factor': 'üìç',
                'scenario_factor': 'üéØ',
                'inventory_factor': 'üì¶'
            };

            const factorNames = {
                'time_factor': 'Êó∂ÊÆµÂõ†Â≠ê',
                'weather_factor': 'Â§©Ê∞îÈÄÇÈÖç',
                'store_factor': 'Èó®Â∫óÁÉ≠ÈîÄ',
                'scenario_factor': 'Âú∫ÊôØÂåπÈÖç',
                'inventory_factor': 'Â∫ìÂ≠òÁä∂ÊÄÅ'
            };

            let html = '<div class="context-factors-panel"><div class="title">üåç ‰∏ä‰∏ãÊñáÂõ†Â≠ê</div>';

            for (const [key, factor] of Object.entries(contextFactors)) {
                if (!factor || !factor.value) continue;

                const value = factor.value;
                const isBoost = value > 1;
                const isPenalty = value < 1;
                const percent = Math.abs((value - 1) * 100).toFixed(0);
                const barWidth = Math.min(100, Math.abs(value - 0.5) * 100);

                html += `
                    <div class="context-factor-row">
                        <span class="factor-icon">${factorIcons[key] || 'üìä'}</span>
                        <span class="factor-name">${factorNames[key] || key}</span>
                        <div class="factor-bar">
                            <div class="factor-bar-fill" style="width: ${barWidth}%"></div>
                        </div>
                        <span class="factor-value ${isBoost ? 'boost' : (isPenalty ? 'penalty' : '')}">
                            ${isBoost ? '+' : (isPenalty ? '-' : '')}${percent}%
                        </span>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Ê∏≤ÊüìÂ∫ìÂ≠òÊ†áÁ≠æ
        function renderStockBadge(inventoryLevel) {
            if (!inventoryLevel) return '';

            const labels = {
                'high': 'ÂÖÖË∂≥',
                'medium': 'ÈÄÇ‰∏≠',
                'low': 'Á¥ß‰øè',
                'out': 'ÂîÆÁΩÑ'
            };

            return `<span class="stock-badge ${inventoryLevel}">${labels[inventoryLevel] || inventoryLevel}</span>`;
        }

        // ÂàùÂßãÂåñ
        initMOPControls();

        // ‰∫∫ËÆæ‰∏éÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÊò†Â∞Ñ
        const personaCustomizationMap = {
            'ÂÅ•Â∫∑Ëææ‰∫∫': {
                temperatures: ['ÂÜ∞', 'Â∞ëÂÜ∞', 'ÂéªÂÜ∞'],
                sugars: ['‰∏çÂè¶Â§ñÂä†Á≥ñ', '0ÁÉ≠Èáè‰ª£Á≥ñ'],
                milks: ['ÁáïÈ∫¶Â•∂', 'ËÑ±ËÑÇÁâõÂ•∂', 'Â∑¥Êó¶Êú®Â•∂', 'Ë±ÜÂ•∂'],
                keywords: ['‰ΩéÂç°', 'Êó†Á≥ñ', 'Ê§çÁâ©Âü∫']
            },
            'ÂíñÂï°ÈáçÂ∫¶Áî®Êà∑': {
                temperatures: ['ÁÉ≠', 'ÁâπÂà´ÁÉ≠'],
                espressoRoasts: ['ÁªèÂÖ∏ÊµìÁº©(Ê∑±ÁÉò)'],
                espressoTypes: ['ÂéüËêÉÊµìÁº©', 'Êª°ËêÉÊµìÁº©'],
                keywords: ['ÊµìÈÉÅ', 'ÊèêÁ•û', 'ÊµìÁº©']
            },
            'ÁîúÂìÅÁà±Â•ΩËÄÖ': {
                temperatures: ['ÂÜ∞', 'Â∞ëÂÜ∞'],
                sugars: ['ÁªèÂÖ∏Á≥ñ'],
                sugarFreeFlavors: ['È¶ôËçâÈ£éÂë≥', 'Ê¶õÊûúÈ£éÂë≥', 'Êµ∑ÁõêÁÑ¶Á≥ñÈ£éÂë≥'],
                drizzles: ['Êë©Âç°Ê∑ãÈÖ±', 'ÁÑ¶Á≥ñÈ£éÂë≥ÈÖ±'],
                whippedCream: true,
                keywords: ['ÁîúËúú', 'Â•∂Ê≤π', 'ÁÑ¶Á≥ñ']
            },
            'Â∞ùÈ≤úÊ¥æ': {
                temperatures: ['ÂÜ∞', 'Â∞ëÂÜ∞'],
                milks: ['ÁáïÈ∫¶Â•∂', 'Ê§∞Â•∂'],
                sugarFreeFlavors: ['Â§ßÊ∫™Âú∞È¶ôËçâÈ£éÂë≥', 'ËéìËéìÈ£éÂë≥', 'Á≥ØÈ¶ôÊñëÊñìÈ£éÂë≥'],
                keywords: ['Êñ∞ÂìÅ', 'ÈôêÂÆö', 'ÂàõÊñ∞']
            },
            'ÂÆûÁî®‰∏ª‰πâ': {
                cupSizes: ['Â§ßÊùØ', 'Ë∂ÖÂ§ßÊùØ'],
                temperatures: ['ÁÉ≠', 'ÂÜ∞'],
                sugars: ['ÁªèÂÖ∏Á≥ñ', '‰∏çÂè¶Â§ñÂä†Á≥ñ'],
                keywords: ['ÁªèÂÖ∏', 'ÂÆûÊÉ†', 'Â§ßÊùØ']
            },
            'ÂÖªÁîüÁôΩÈ¢Ü': {
                temperatures: ['ÁÉ≠', 'ÂæÆÁÉ≠', 'Â∞ëÂÜ∞'],
                sugars: ['‰∏çÂè¶Â§ñÂä†Á≥ñ', '0ÁÉ≠Èáè‰ª£Á≥ñ', 'Â∞ëÁîú'],
                milks: ['ÁáïÈ∫¶Â•∂', 'ËÑ±ËÑÇÁâõÂ•∂'],
                keywords: ['ÊèêÁ•û', '‰ΩéÁ≥ñ', 'ÂÅ•Â∫∑']
            }
        };

        // Ê∏≤ÊüìÂÆ¢Âà∂ÂåñÈÄâÈ°π
        function renderCustomizationOptions(constraints, suggestedCust, persona) {
            if (!constraints) return '';

            const personaPrefs = personaCustomizationMap[persona] || {};
            const suggested = suggestedCust?.suggested_customization || {};

            let html = '<div class="cust-options-content">';

            // Ê∏©Â∫¶ÈÄâÈ°π - ËøáÊª§Á©∫ÂÄº
            const temps = (constraints.available_temperatures || []).filter(t => t && t.trim());
            if (temps.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">üå°Ô∏è Ê∏©Â∫¶</div>
                    <div class="cust-option-chips">
                        ${temps.map(t => {
                            const isRecommended = suggested.temperature === t;
                            const isPersonaMatch = personaPrefs.temperatures?.includes(t);
                            const isDefault = constraints.default_temperature === t;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${t}${isRecommended ? ' ‚úì' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // ÊµìÁº©ÁÉòÁÑôÁ±ªÂûã - ËøáÊª§Á©∫ÂÄº
            const roasts = (constraints.available_espresso_roasts || []).filter(r => r && r.trim());
            if (roasts.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">‚òï ÊµìÁº©ÁÉòÁÑô</div>
                    <div class="cust-option-chips">
                        ${roasts.map(r => {
                            const isRecommended = suggested.espresso_roast === r;
                            const isPersonaMatch = personaPrefs.espressoRoasts?.includes(r);
                            const isDefault = constraints.default_espresso_roast === r;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${r}${isRecommended ? ' ‚úì' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // ÊµìÁº©ËêÉÂèñÁ±ªÂûã - ËøáÊª§Á©∫ÂÄº
            const espressoTypes = (constraints.available_espresso_types || []).filter(t => t && t.trim());
            if (espressoTypes.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">‚ö° ÊµìÁº©ËêÉÂèñ</div>
                    <div class="cust-option-chips">
                        ${espressoTypes.map(t => {
                            const isRecommended = suggested.espresso_type === t;
                            const isPersonaMatch = personaPrefs.espressoTypes?.includes(t);
                            const isDefault = constraints.default_espresso_type === t;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${t}${isRecommended ? ' ‚úì' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // ÁîúÂ∫¶ÈÄâÈ°π - ËøáÊª§Á©∫ÂÄº
            const sugars = (constraints.available_sugar_levels || []).filter(s => s && s.trim());
            if (sugars.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">üç¨ ÁîúÂ∫¶</div>
                    <div class="cust-option-chips">
                        ${sugars.map(s => {
                            const isRecommended = suggested.sugar_level === s;
                            const isPersonaMatch = personaPrefs.sugars?.includes(s);
                            const isDefault = constraints.default_sugar_level === s;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${s}${isRecommended ? ' ‚úì' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // Â•∂Á±ªÈÄâÈ°π - ËøáÊª§Á©∫ÂÄº
            const milks = (constraints.available_milk_types || []).filter(m => m && m.trim());
            if (milks.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">ü•õ Â•∂Á±ª</div>
                    <div class="cust-option-chips">
                        ${milks.map(m => {
                            const isRecommended = suggested.milk_type === m;
                            const isPersonaMatch = personaPrefs.milks?.includes(m);
                            const isDefault = constraints.default_milk_type === m;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${m}${isRecommended ? ' ‚úì' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // Êó†Á≥ñÈ£éÂë≥Á≥ñÊµÜ - ËøáÊª§Á©∫ÂÄº
            const flavors = (constraints.available_sugar_free_flavors || []).filter(f => f && f.trim());
            if (flavors.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">üå∏ Êó†Á≥ñÈ£éÂë≥Á≥ñÊµÜ</div>
                    <div class="cust-option-chips">
                        ${flavors.map(f => {
                            const isPersonaMatch = personaPrefs.sugarFreeFlavors?.includes(f);
                            let classes = ['cust-chip'];
                            if (isPersonaMatch) classes.push('persona-match');
                            return `<span class="${classes.join(' ')}">${f}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // Ê∑ãÈÖ±ÈÄâÈ°π - ËøáÊª§Á©∫ÂÄº
            const drizzles = (constraints.available_drizzles || []).filter(d => d && d.trim());
            if (drizzles.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">üç´ Ê∑ãÈÖ±</div>
                    <div class="cust-option-chips">
                        ${drizzles.map(d => {
                            const isPersonaMatch = personaPrefs.drizzles?.includes(d);
                            let classes = ['cust-chip'];
                            if (isPersonaMatch) classes.push('persona-match');
                            return `<span class="${classes.join(' ')}">${d}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // È¢ùÂ§ñÈÄâÈ°πÔºàÂ•∂Ê≤πÈ°∂„ÄÅÊµìÁº©‰ªΩÊï∞Ôºâ
            let extras = [];
            if (constraints.supports_whipped_cream) {
                const isPersonaMatch = personaPrefs.whippedCream;
                extras.push(`<span class="cust-chip ${isPersonaMatch ? 'persona-match' : ''}">ÂèØÂä†Â•∂Ê≤πÈ°∂</span>`);
            }
            if (constraints.supports_espresso_adjustment) {
                extras.push(`<span class="cust-chip">ÂèØË∞ÉÊï¥ÊµìÁº©‰ªΩÊï∞</span>`);
            }
            if (constraints.supports_extra_cream) {
                extras.push(`<span class="cust-chip">ÂèØÂä†Á®ÄÂ•∂Ê≤π</span>`);
            }
            if (constraints.supports_mocha_sauce) {
                extras.push(`<span class="cust-chip">ÂèØÂä†Êë©Âç°ÈÖ±</span>`);
            }

            if (extras.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">‚ú® È¢ùÂ§ñÈÄâÈ°π</div>
                    <div class="cust-option-chips">${extras.join('')}</div>
                </div>`;
            }

            // Âõæ‰æã
            html += `<div class="cust-legend">
                <div class="cust-legend-item"><span class="cust-legend-dot recommended"></span>Êé®ËçêÈÄâÈ°π</div>
                <div class="cust-legend-item"><span class="cust-legend-dot persona"></span>‰∫∫ËÆæÂÅèÂ•Ω</div>
                <div class="cust-legend-item"><span class="cust-legend-dot default"></span>ÈªòËÆ§ÈÖçÁΩÆ</div>
            </div>`;

            html += '</div>';

            return html;
        }

        // ÂàáÊç¢ÂÆ¢Âà∂ÂåñÈù¢ÊùøÂ±ïÂºÄ/Êî∂Ëµ∑
        function toggleCustPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('expanded');
            }
        }

        // ÁîªÂÉèÈÄâÊã©
        document.querySelectorAll('.persona-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedPersona = card.dataset.persona;
            });
        });

        // Ëé∑ÂèñÊé®Ëçê
        // PipelineÂèØËßÜÂåñÁõ∏ÂÖ≥Áä∂ÊÄÅ
        let pipelineVisible = true;
        let currentPipelineData = null;

        // ÂàáÊç¢PipelineÊòæÁ§∫
        function togglePipeline() {
            const section = document.getElementById('pipelineSection');
            const steps = document.getElementById('pipelineSteps');
            const btn = section.querySelector('.pipeline-toggle');

            pipelineVisible = !pipelineVisible;
            steps.style.display = pipelineVisible ? 'flex' : 'none';
            btn.textContent = pipelineVisible ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ';
        }

        // Êõ¥Êñ∞PipelineÊ≠•È™§Áä∂ÊÄÅ
        function updatePipelineStep(stepNum, status, output, timeMs) {
            const step = document.getElementById(`step${stepNum}`);
            const outputEl = document.getElementById(`step${stepNum}Output`);
            const timeEl = document.getElementById(`step${stepNum}Time`);

            step.classList.remove('active', 'completed');
            if (status === 'active') {
                step.classList.add('active');
            } else if (status === 'completed') {
                step.classList.add('completed');
            }

            if (output) {
                outputEl.textContent = output;
            }
            if (timeMs !== undefined) {
                timeEl.textContent = `‚è±Ô∏è ${timeMs}ms`;
            }
        }

        // ÈáçÁΩÆPipeline
        function resetPipeline() {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
                document.getElementById(`step${i}Output`).textContent = 'Á≠âÂæÖÊâßË°å...';
                document.getElementById(`step${i}Time`).textContent = '-';
            }
        }

        // Êõ¥Êñ∞PipelineÊòæÁ§∫Ôºà‰ªéreasoning_stepsÊï∞ÊçÆÔºâ
        function updatePipelineFromData(reasoningSteps, llmInfo) {
            if (!reasoningSteps || reasoningSteps.length === 0) return;

            const stepMapping = {
                'Áî®Êà∑ÁîªÂÉèÁîüÊàê': 1,
                'Áî®Êà∑ÂêëÈáèÂåñ': 2,
                'ËØ≠‰πâÂêëÈáèÂè¨Âõû': 3,
                '‰∏öÂä°ËßÑÂàôÈáçÊéí': 4,
                'Â§öÂõ†Á¥†ÈáçÊéíÂ∫è': 4,
                'Êé®ËçêÁêÜÁî±ÁîüÊàê': 5
            };

            for (const step of reasoningSteps) {
                const stepNum = stepMapping[step.name] || step.step;
                if (stepNum >= 1 && stepNum <= 5) {
                    let output = '';
                    if (step.output) {
                        if (step.name === 'Áî®Êà∑ÁîªÂÉèÁîüÊàê' && step.output.search_query) {
                            output = `Êü•ËØ¢: "${step.output.search_query}"`;
                        } else if (step.name === 'Áî®Êà∑ÂêëÈáèÂåñ' && step.output.vector_dim) {
                            output = `${step.output.model}: ${step.output.vector_dim}Áª¥`;
                        } else if (step.name === 'ËØ≠‰πâÂêëÈáèÂè¨Âõû' && step.output.top_candidates) {
                            output = step.output.top_candidates.slice(0, 3).map(c => c.name).join(', ');
                        } else if ((step.name === '‰∏öÂä°ËßÑÂàôÈáçÊéí' || step.name === 'Â§öÂõ†Á¥†ÈáçÊéíÂ∫è') && step.output.reranked_top) {
                            output = step.output.reranked_top.slice(0, 3).map(r => r.name).join(', ');
                        } else if (step.name === 'Êé®ËçêÁêÜÁî±ÁîüÊàê') {
                            output = `Â∑≤ÁîüÊàê${llmInfo?.total_llm_calls || 0}Êù°ÁêÜÁî±`;
                        } else {
                            output = JSON.stringify(step.output).slice(0, 50) + '...';
                        }
                    }
                    updatePipelineStep(stepNum, 'completed', output, step.duration_ms);
                }
            }
        }

        document.getElementById('btnRecommend').addEventListener('click', async () => {
            const btn = document.getElementById('btnRecommend');
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('recommendationsGrid');
            const pipelineSection = document.getElementById('pipelineSection');

            btn.disabled = true;
            btn.textContent = 'Êé®Ëçê‰∏≠...';
            loading.style.display = 'flex';
            grid.innerHTML = '';

            // ÊòæÁ§∫Âπ∂ÈáçÁΩÆPipeline
            pipelineSection.style.display = 'block';
            resetPipeline();

            // Ê®°ÊãüÊ≠•È™§ÊâßË°åÂä®Áîª
            updatePipelineStep(1, 'active', 'Ê≠£Âú®ÂàÜÊûêÁî®Êà∑ÁîªÂÉè...', undefined);

            try {
                const enableContext = document.getElementById('enableContext').checked;
                const useV3 = enableContext;

                // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
                const requestBody = {
                    persona_type: selectedPersona,
                    user_id: userId,
                    session_id: sessionId,
                    top_k: 6,
                    enable_ab_test: document.getElementById('enableABTest').checked,
                    enable_behavior: document.getElementById('enableBehavior').checked,
                    enable_session: document.getElementById('enableSession').checked,
                    enable_explainability: document.getElementById('enableExplainability').checked,
                    enable_customization: document.getElementById('enableCustomization').checked
                };

                // V3ÁâπÊúâÂèÇÊï∞
                if (useV3) {
                    requestBody.enable_context = true;
                    if (selectedStoreId) requestBody.store_id = selectedStoreId;
                    if (selectedWeather !== 'auto') requestBody.weather_override = selectedWeather;
                    if (selectedScenario) requestBody.scenario_override = selectedScenario;
                    if (selectedTimeOfDay !== 'auto') {
                        requestBody.context = { time_of_day: selectedTimeOfDay };
                    }
                }

                const apiEndpoint = useV3 ? '/api/embedding/recommend/v3' : '/api/embedding/recommend/v2';
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                currentRecommendations = data.recommendations || [];

                // Êõ¥Êñ∞PipelineÂèØËßÜÂåñ
                if (data.reasoning_steps) {
                    updatePipelineFromData(data.reasoning_steps, data.llm_info);
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâËØ¶ÁªÜÊ≠•È™§Êï∞ÊçÆÔºåÊ†áËÆ∞ÊâÄÊúâÊ≠•È™§ÂÆåÊàê
                    for (let i = 1; i <= 5; i++) {
                        updatePipelineStep(i, 'completed', '‚úì ÂÆåÊàê', undefined);
                    }
                }

                // ÊòæÁ§∫ÂÆûÈ™åÂàÜÁªÑ
                // ‰ΩøÁî®Â¢ûÂº∫ÁâàÂÆûÈ™åÂàÜÁªÑÊ∏≤Êüì
                renderExperimentBanner(data.experiment);

                // ÊòæÁ§∫ÊåáÊ†á
                if (data.metrics) {
                    document.getElementById('metricsCard').style.display = 'block';
                    document.getElementById('metricTime').textContent = `${data.metrics.total_time_ms}ms`;
                    document.getElementById('metricLLM').textContent = `${data.llm_info?.total_llm_calls || 0}Ê¨°`;
                    document.getElementById('metricScore').textContent = `${(data.metrics.avg_match_score * 100).toFixed(1)}%`;
                }

                // Ê∏≤ÊüìÊé®ËçêÂç°Áâá
                renderRecommendations(data.recommendations);

                // ÊòæÁ§∫Ëß£Èáä
                if (data.recommendations?.[0]?.explanation) {
                    showExplanation(data.recommendations[0].explanation);
                }

                // Êõ¥Êñ∞ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÈù¢Êùø
                if (document.getElementById('enableCustomization').checked) {
                    updateCustomizationPrefs();
                }

                // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÂõ†Â≠êËø∑‰Ω†Â±ïÁ§∫ (V3 API)
                if (useV3 && data.recommendations?.[0]?.context_factors) {
                    updateContextFactorsMini(data.recommendations[0].context_factors);
                    addActivityLog('context', `Êé®ËçêÂ∑≤Âü∫‰∫é‰∏ä‰∏ãÊñáÂõ†Â≠êË∞ÉÊï¥`, 'üéØ');
                }

                // ËÆ∞ÂΩïÊé®ËçêËé∑ÂèñÊ¥ªÂä®
                addActivityLog('click', `Ëé∑Âèñ ${data.recommendations?.length || 0} ‰∏™Êé®Ëçê`, 'üìã');

            } catch (error) {
                console.error('Error:', error);
                grid.innerHTML = `<div style="color: red; padding: 20px;">ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ëé∑ÂèñÊé®Ëçê';
                loading.style.display = 'none';
            }
        });

        function renderRecommendations(recommendations) {
            const grid = document.getElementById('recommendationsGrid');
            grid.innerHTML = '';

            recommendations.forEach((rec, index) => {
                const card = document.createElement('div');
                card.className = 'rec-card';

                const breakdown = rec.score_breakdown || {};
                const custBoostDetail = breakdown.customization_boost_detail || {};

                // ËÆ°ÁÆóÂêÑÂõ†Á¥†ÁöÑÁ±ªÂà´
                const getMultiplierClass = (val) => val > 1 ? 'boost' : (val < 1 ? 'penalty' : 'neutral');
                const getMultiplierSign = (val) => val > 1 ? '+' : (val < 1 ? '' : '');
                const formatMultiplier = (val) => {
                    if (!val || val === 1) return '√ó1.00';
                    const percent = ((val - 1) * 100).toFixed(0);
                    return `√ó${val.toFixed(2)} (${percent > 0 ? '+' : ''}${percent}%)`;
                };

                // ÊûÑÂª∫ÁÆóÊ≥ïÊ¥ûÂØüÂæΩÁ´†
                let insightBadges = '';
                if (rec.item.is_new) insightBadges += '<span class="algo-insight-badge new-item">üÜï Êñ∞ÂìÅÂä†ÊùÉ</span>';
                if (rec.item.is_seasonal) insightBadges += '<span class="algo-insight-badge seasonal">üçÇ Â≠£ËäÇÈôêÂÆö</span>';
                if (breakdown.order_boost_detail?.repurchase_boost > 1) insightBadges += '<span class="algo-insight-badge repurchase">üîÑ Â§çË¥≠Êé®Ëçê</span>';
                if (breakdown.is_cold_start) insightBadges += '<span class="algo-insight-badge cold-start">‚ùÑÔ∏è ÂÜ∑ÂêØÂä®</span>';

                // ÊûÑÂª∫Â¢ûÂº∫ÁâàÂàÜÊï∞ÊãÜËß£HTML
                const similarityPct = ((breakdown.embedding_similarity || 0) * 100).toFixed(0);
                const scoreBreakdownHtml = `
                    <div class="score-breakdown-enhanced">
                        <!-- ËØ≠‰πâÁõ∏‰ººÂ∫¶ -->
                        <div class="score-progress-item">
                            <div class="score-progress-header">
                                <span class="score-progress-label">üîç ËØ≠‰πâÁõ∏‰ººÂ∫¶</span>
                                <span class="score-progress-value neutral">${similarityPct}%</span>
                            </div>
                            <div class="score-progress-bar">
                                <div class="score-progress-fill similarity" style="width: ${similarityPct}%"></div>
                            </div>
                        </div>

                        <!-- ‰∏öÂä°ËßÑÂàô -->
                        <div class="score-progress-item">
                            <div class="score-progress-header">
                                <span class="score-progress-label">‚öôÔ∏è ‰∏öÂä°ËßÑÂàô</span>
                                <span class="score-progress-value ${getMultiplierClass(breakdown.rule_multiplier)}">${formatMultiplier(breakdown.rule_multiplier)}</span>
                            </div>
                            <div class="score-progress-bar">
                                <div class="score-progress-fill rule" style="width: ${Math.min(100, (breakdown.rule_multiplier || 1) * 50)}%"></div>
                            </div>
                        </div>

                        <!-- ÂéÜÂè≤Ë°å‰∏∫ -->
                        <div class="score-progress-item">
                            <div class="score-progress-header">
                                <span class="score-progress-label">üìà ÂéÜÂè≤Ë°å‰∏∫</span>
                                <span class="score-progress-value ${getMultiplierClass(breakdown.behavior_multiplier)}">${formatMultiplier(breakdown.behavior_multiplier)}</span>
                            </div>
                            <div class="score-progress-bar">
                                <div class="score-progress-fill behavior" style="width: ${Math.min(100, (breakdown.behavior_multiplier || 1) * 50)}%"></div>
                            </div>
                        </div>

                        <!-- SessionÂÅèÂ•Ω -->
                        <div class="score-progress-item">
                            <div class="score-progress-header">
                                <span class="score-progress-label">üí° SessionÂÅèÂ•Ω</span>
                                <span class="score-progress-value ${getMultiplierClass(breakdown.session_multiplier)}">${formatMultiplier(breakdown.session_multiplier)}</span>
                            </div>
                            <div class="score-progress-bar">
                                <div class="score-progress-fill session" style="width: ${Math.min(100, (breakdown.session_multiplier || 1) * 50)}%"></div>
                            </div>
                        </div>

                        <!-- ÂÆ¢Âà∂ÂåñÂåπÈÖç - ÂèØÂ±ïÂºÄ -->
                        <div class="customization-factors" id="cust-factors-${index}">
                            <div class="customization-factors-header" onclick="toggleCustomizationFactors(${index})">
                                <span class="customization-factors-title">
                                    üé® ÂÆ¢Âà∂ÂåñÂåπÈÖç
                                    <span style="font-weight: 800; margin-left: 4px;">${formatMultiplier(breakdown.customization_multiplier)}</span>
                                </span>
                                <span class="customization-factors-toggle">‚ñº</span>
                            </div>
                            <div class="customization-factors-content">
                                ${renderCustomizationFactors(custBoostDetail)}
                            </div>
                        </div>
                    </div>
                `;

                // ÊûÑÂª∫Â¢ûÂº∫ÁâàÂÆ¢Âà∂ÂåñÂª∫ËÆÆÂç°Áâá
                const suggestedCust = rec.suggested_customization;
                let suggestionCardHtml = '';
                if (suggestedCust && suggestedCust.suggested_customization) {
                    const sc = suggestedCust.suggested_customization;
                    const confidence = suggestedCust.confidence || 0;
                    const confSource = suggestedCust.confidence_source || 'default';
                    const confClass = confidence >= 0.7 ? 'high' : (confidence >= 0.4 ? 'medium' : 'low');

                    // Ê†πÊçÆÊù•Ê∫êÊòæÁ§∫‰∏çÂêåÁöÑÁΩÆ‰ø°Â∫¶Ê†áÁ≠æ
                    const sourceLabels = {
                        'preset': 'üìã È¢ÑËÆæ',
                        'history': 'üìä ÂéÜÂè≤',
                        'preset_history': 'üìã+üìä Ê∑∑Âêà',
                        'default': '‚öôÔ∏è ÈªòËÆ§'
                    };
                    const confSourceText = sourceLabels[confSource] || '';
                    const confText = confidence >= 0.7 ? 'È´òÁΩÆ‰ø°Â∫¶' : (confidence >= 0.4 ? '‰∏≠ÁΩÆ‰ø°Â∫¶' : '‰ΩéÁΩÆ‰ø°Â∫¶');

                    // ËÆ°ÁÆó‰ª∑Ê†ºË∞ÉÊï¥
                    const priceAdjust = suggestedCust.price_adjustment || 0;
                    const finalPrice = rec.item.base_price + priceAdjust;

                    suggestionCardHtml = `
                        <div class="customization-suggestion-card">
                            <div class="suggestion-card-header">
                                <span class="suggestion-card-title">‚ú® ‰∏∫ÊÇ®Êé®ËçêÁöÑÈÖçÁΩÆ</span>
                                <span class="suggestion-confidence ${confClass}" title="Êù•Ê∫ê: ${confSourceText}">${confSourceText} ${(confidence * 100).toFixed(0)}%</span>
                            </div>
                            <div class="suggestion-items">
                                ${sc.temperature ? `
                                    <div class="suggestion-item">
                                        <span class="suggestion-item-icon">üå°Ô∏è</span>
                                        <div class="suggestion-item-info">
                                            <div class="suggestion-item-label">Ê∏©Â∫¶${sc._weather_temp_boost && Object.keys(sc._weather_temp_boost).length > 0 ? ' <span class="weather-factor-indicator" title="Â§©Ê∞îÂõ†Â≠êÂ∑≤ÂΩ±ÂìçÊ∏©Â∫¶Êé®Ëçê">üå§Ô∏è</span>' : ''}</div>
                                            <div class="suggestion-item-value">${formatTemp(sc.temperature)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${sc.cup_size ? `
                                    <div class="suggestion-item">
                                        <span class="suggestion-item-icon">üìè</span>
                                        <div class="suggestion-item-info">
                                            <div class="suggestion-item-label">ÊùØÂûã</div>
                                            <div class="suggestion-item-value">${formatSize(sc.cup_size)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${sc.sugar_level ? `
                                    <div class="suggestion-item">
                                        <span class="suggestion-item-icon">üç¨</span>
                                        <div class="suggestion-item-info">
                                            <div class="suggestion-item-label">Á≥ñÂ∫¶</div>
                                            <div class="suggestion-item-value">${formatSugar(sc.sugar_level)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${sc.milk_type ? `
                                    <div class="suggestion-item">
                                        <span class="suggestion-item-icon">ü•õ</span>
                                        <div class="suggestion-item-info">
                                            <div class="suggestion-item-label">Â•∂Á±ª</div>
                                            <div class="suggestion-item-value">${formatMilk(sc.milk_type)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            ${(() => {
                                // ÁîüÊàêÂÆ¢Âà∂ÂåñÊé®ËçêÁêÜÁî±ÔºåÂåÖÂê´Â§©Ê∞îÂõ†Â≠ê
                                let reasonHtml = '';
                                if (suggestedCust.reason) {
                                    reasonHtml = suggestedCust.reason;
                                }
                                // Ê∑ªÂä†Â§©Ê∞îÂõ†Â≠êËØ¥ÊòéÔºà‰ªÖÂΩìÂïÜÂìÅÊîØÊåÅÂØπÂ∫îÊ∏©Â∫¶Êó∂ÊâçÊòæÁ§∫Ôºâ
                                if (sc._weather_temp_boost && Object.keys(sc._weather_temp_boost).length > 0) {
                                    const hotBoost = sc._weather_temp_boost['HOT'] || 0;
                                    const icedBoost = sc._weather_temp_boost['ICED'] || 0;
                                    // Ëé∑ÂèñÂïÜÂìÅÊîØÊåÅÁöÑÊ∏©Â∫¶ (Ê≥®ÊÑèÔºöÂÄºÊòØ‰∏≠ÊñáÔºåÂ¶Ç"ÁÉ≠"„ÄÅ"ÂÜ∞"Á≠â)
                                    const availableTemps = rec.item.available_temperatures || [];
                                    const supportsHot = availableTemps.some(t => t === 'ÁÉ≠' || t === 'ÁâπÂà´ÁÉ≠' || t === 'ÂæÆÁÉ≠');
                                    const supportsIced = availableTemps.some(t => t === 'ÂÜ∞' || t === 'Â∞ëÂÜ∞' || t === 'ÂéªÂÜ∞' || t === 'ÂÖ®ÂÜ∞');

                                    // Âè™ÊúâÂΩìÂïÜÂìÅÊîØÊåÅÁÉ≠È•Æ‰∏îÂ§©Ê∞îÊé®ËçêÁÉ≠È•ÆÊó∂ÊâçÊòæÁ§∫
                                    if (hotBoost > 0 && supportsHot) {
                                        reasonHtml += (reasonHtml ? 'Ôºõ' : '') + 'üå°Ô∏è Â§©Ê∞îËæÉÂÜ∑Êé®ËçêÁÉ≠È•Æ';
                                    } else if (icedBoost > 0 && supportsIced) {
                                        reasonHtml += (reasonHtml ? 'Ôºõ' : '') + '‚òÄÔ∏è Â§©Ê∞îËæÉÁÉ≠Êé®ËçêÂÜ∞È•Æ';
                                    } else if (hotBoost > 0 && !supportsHot) {
                                        // ÂïÜÂìÅ‰∏çÊîØÊåÅÁÉ≠È•Æ‰ΩÜÂ§©Ê∞îÊé®ËçêÁÉ≠È•ÆÔºåÊèêÁ§∫Áî®Êà∑
                                        reasonHtml += (reasonHtml ? 'Ôºõ' : '') + '‚ùÑÔ∏è Ê≠§ÂïÜÂìÅ‰ªÖÊîØÊåÅÂÜ∑È•Æ';
                                    } else if (icedBoost > 0 && !supportsIced) {
                                        // ÂïÜÂìÅ‰∏çÊîØÊåÅÂÜ∞È•Æ‰ΩÜÂ§©Ê∞îÊé®ËçêÂÜ∞È•ÆÔºåÊèêÁ§∫Áî®Êà∑
                                        reasonHtml += (reasonHtml ? 'Ôºõ' : '') + 'üî• Ê≠§ÂïÜÂìÅ‰ªÖÊîØÊåÅÁÉ≠È•Æ';
                                    }
                                }
                                return reasonHtml ? `<div style="font-size: 12px; color: #166534; margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 6px;">üí° ${reasonHtml}</div>` : '';
                            })()}
                            <div class="suggestion-price">
                                <div>
                                    <div class="suggestion-price-label">Êé®ËçêÈÖçÁΩÆ‰ª∑Ê†º</div>
                                    ${priceAdjust !== 0 ? `<div class="suggestion-price-adjust">${priceAdjust > 0 ? '+' : ''}¬•${priceAdjust} ÂÆ¢Âà∂Âåñ</div>` : ''}
                                </div>
                                <span class="suggestion-price-value">¬•${finalPrice.toFixed(0)}</span>
                            </div>
                            <div class="suggestion-actions">
                                <button class="btn-add-suggested" onclick="addToCart('${rec.item.sku}', '${rec.item.name}', ${finalPrice}, this, ${JSON.stringify(sc).replace(/"/g, "'")})">üõí ‰∏ÄÈîÆÊ∑ªÂä†Êé®ËçêÈÖçÁΩÆ</button>
                            </div>
                        </div>
                    `;
                }

                // Ëé∑ÂèñÂÆ¢Âà∂ÂåñÁ∫¶ÊùüÂíå‰ºöÂëò‰ª∑
                const constraints = rec.item.customization_constraints || {};
                const memberPrice = constraints.member_discount;
                const custPanelId = `cust-panel-${index}`;

                // ÊûÑÂª∫ÂÆ¢Âà∂ÂåñÈÄâÈ°πÈù¢ÊùøHTML
                const custOptionsHtml = renderCustomizationOptions(constraints, suggestedCust, selectedPersona);

                card.innerHTML = `
                    <div class="rec-card-header">
                        <div>
                            <div class="rec-card-title">${rec.item.name}</div>
                            <div class="rec-card-category">
                                ${rec.item.category} ¬∑ ¬•${rec.item.base_price}
                                ${memberPrice ? `<span class="member-price-badge">‚≠ê ‰ºöÂëò ¬•${memberPrice}</span>` : ''}
                            </div>
                            ${insightBadges ? `<div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 4px;">${insightBadges}</div>` : ''}
                        </div>
                        <div class="match-score">${(rec.match_score * 100).toFixed(0)}</div>
                    </div>

                    ${scoreBreakdownHtml}

                    ${suggestionCardHtml}

                    ${custOptionsHtml ? `
                    <div class="cust-options-panel" id="${custPanelId}">
                        <div class="panel-header" onclick="toggleCustPanel('${custPanelId}')">
                            <div class="panel-title">
                                <span>üìã ÂèØÈÄâÂÆ¢Âà∂ÂåñÈÖçÁΩÆ</span>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: normal;">(ÁÇπÂáªÂ±ïÂºÄ)</span>
                            </div>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        ${custOptionsHtml}
                    </div>
                    ` : ''}

                    <div class="rec-reason">${rec.reason || '‰∏∫ÊÇ®Á≤æÈÄâÊé®Ëçê'}</div>

                    ${rec.matched_keywords?.length > 0 ? `
                        <div class="matched-keywords">
                            ${rec.matched_keywords.map(k => `<span class="keyword-tag">${k}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="feedback-buttons">
                        <button class="feedback-btn like" onclick="recordFeedback('${rec.item.sku}', 'like', this, ${JSON.stringify(rec.item.tags).replace(/"/g, "'")})">üëç ÂñúÊ¨¢</button>
                        <button class="feedback-btn dislike" onclick="recordFeedback('${rec.item.sku}', 'dislike', this, ${JSON.stringify(rec.item.tags).replace(/"/g, "'")})">üëé ‰∏çÂñúÊ¨¢</button>
                        <button class="btn-add-cart" onclick="addToCart('${rec.item.sku}', '${rec.item.name}', ${rec.item.base_price}, this, ${JSON.stringify(rec.suggested_customization?.suggested_customization || {}).replace(/"/g, "'")})">üõí Ëá™ÂÆö‰πâÂä†ÂÖ•</button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Ê∏≤ÊüìÂÆ¢Âà∂ÂåñÂõ†Á¥†ËØ¶ÊÉÖ
        function renderCustomizationFactors(detail) {
            if (!detail || !detail.factors) {
                return '<div style="font-size: 11px; color: #64748b; padding: 8px 0;">ÊöÇÊó†ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÊï∞ÊçÆ</div>';
            }

            const factors = detail.factors;
            const factorConfig = {
                temperature_match: { icon: 'üå°Ô∏è', name: 'Ê∏©Â∫¶ÂåπÈÖç', desc: 'ÊîØÊåÅÊÇ®ÂÅèÂ•ΩÁöÑÊ∏©Â∫¶' },
                size_match: { icon: 'üìè', name: 'ÊùØÂûãÂåπÈÖç', desc: 'ÊîØÊåÅÊÇ®Â∏∏ÈÄâÁöÑÊùØÂûã' },
                milk_match: { icon: 'ü•õ', name: 'Â•∂Á±ªÂåπÈÖç', desc: 'ÊîØÊåÅÊÇ®ÂÅèÂ•ΩÁöÑÂ•∂Á±ª' },
                sugar_match: { icon: 'üç¨', name: 'Á≥ñÂ∫¶ÂåπÈÖç', desc: 'ÊîØÊåÅÊÇ®ÁöÑÁ≥ñÂ∫¶ÂÅèÂ•Ω' }
            };

            let html = '';
            for (const [key, config] of Object.entries(factorConfig)) {
                const value = factors[key] || 1;
                const isPositive = value > 1;
                const isNegative = value < 1;
                const barClass = isPositive ? 'positive' : (isNegative ? 'negative' : 'neutral');
                const valueClass = isPositive ? 'positive' : (isNegative ? 'negative' : 'neutral');
                const barWidth = Math.abs((value - 1) * 200);
                const displayValue = isPositive ? `+${((value - 1) * 100).toFixed(0)}%` :
                                     isNegative ? `${((value - 1) * 100).toFixed(0)}%` : '¬±0%';

                html += `
                    <div class="cust-factor-item">
                        <span class="cust-factor-icon">${config.icon}</span>
                        <div class="cust-factor-info">
                            <div class="cust-factor-name">${config.name}</div>
                            <div class="cust-factor-desc">${isPositive ? '‚úì ' : ''}${config.desc}</div>
                        </div>
                        <div class="cust-factor-bar">
                            <div class="cust-factor-bar-fill ${barClass}" style="width: ${Math.min(100, barWidth)}%"></div>
                        </div>
                        <span class="cust-factor-value ${valueClass}">${displayValue}</span>
                    </div>
                `;
            }

            if (detail.explanation) {
                html += `<div style="font-size: 11px; color: #0369a1; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">üí° ${detail.explanation}</div>`;
            }

            return html;
        }

        // ÂàáÊç¢ÂÆ¢Âà∂ÂåñÂõ†Á¥†Â±ïÂºÄ/Êî∂Ëµ∑
        function toggleCustomizationFactors(index) {
            const panel = document.getElementById(`cust-factors-${index}`);
            panel.classList.toggle('expanded');
        }

        function showExplanation(explanation) {
            const panel = document.getElementById('explanationPanel');
            const content = document.getElementById('explanationContent');

            let html = `<div style="margin-bottom: 8px;">${explanation.summary}</div>`;

            if (explanation.factors) {
                html += explanation.factors.map(f => `
                    <div class="factor-item">
                        <span style="flex-shrink: 0; width: 80px; font-size: 11px; color: #666;">${f.label}</span>
                        <div class="factor-bar">
                            <div class="factor-bar-fill" style="width: ${f.contribution || 25}%"></div>
                        </div>
                        <span style="flex-shrink: 0; font-size: 11px; font-weight: 600;">${f.contribution?.toFixed(0) || 25}%</span>
                    </div>
                `).join('');
            }

            content.innerHTML = html;
            panel.style.display = 'block';
        }

        async function recordFeedback(sku, type, btn, tags) {
            // ËßÜËßâÂèçÈ¶à
            btn.classList.add('clicked');

            // Êõ¥Êñ∞‰∫§‰∫íËÆ°Êï∞
            interactionCount++;
            document.getElementById('interactionCount').textContent = interactionCount;

            // Êõ¥Êñ∞ÂÆûÊó∂ÂÅèÂ•ΩÊòæÁ§∫
            updateRealtimePrefs(type, tags);

            // ËÆ∞ÂΩïÂèçÈ¶à
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        session_id: sessionId,
                        item_sku: sku,
                        feedback_type: type
                    })
                });

                // ËÆ∞ÂΩïSession‰∫§‰∫í
                const item = currentRecommendations.find(r => r.item.sku === sku)?.item;
                if (item) {
                    await fetch('/api/session/interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            interaction_type: type,
                            item_data: {
                                sku: item.sku,
                                tags: item.tags,
                                category: item.category,
                                price: item.base_price
                            }
                        })
                    });
                }
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        // ============ Ê¥ªÂä®Êó•ÂøóÂäüËÉΩ ============
        let likedTagsSet = new Set();
        let dislikedTagsSet = new Set();

        function addActivityLog(type, message, icon = '') {
            const log = document.getElementById('activityLog');
            const emptyMsg = log.querySelector('.activity-empty');
            if (emptyMsg) emptyMsg.remove();

            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const item = document.createElement('div');
            item.className = `activity-item ${type}`;
            item.innerHTML = `
                <span class="time">${time}</span>
                <span class="action">${icon} ${message}</span>
            `;

            log.insertBefore(item, log.firstChild);

            // ‰øùÁïôÊúÄËøë10Êù°
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        function updateTagCounts() {
            document.getElementById('likedCount').textContent = `(${likedTagsSet.size})`;
            document.getElementById('dislikedCount').textContent = `(${dislikedTagsSet.size})`;
        }

        function updateRealtimePrefs(type, tags, itemName = '') {
            const container = type === 'like' ? document.getElementById('likedTags') : document.getElementById('dislikedTags');
            const tagSet = type === 'like' ? likedTagsSet : dislikedTagsSet;

            // Ëß£Êûêtags (Â§ÑÁêÜÂçïÂºïÂè∑)
            let parsedTags = [];
            if (typeof tags === 'string') {
                try {
                    parsedTags = JSON.parse(tags.replace(/'/g, '"'));
                } catch (e) {
                    parsedTags = tags.split(',');
                }
            } else if (Array.isArray(tags)) {
                parsedTags = tags;
            }

            // Ê∏ÖÈô§"ÊöÇÊó†"ÊèêÁ§∫
            if (container.querySelector('span[style]')) {
                container.innerHTML = '';
            }

            // Ê∑ªÂä†Ê†áÁ≠æ
            let newTagsAdded = [];
            parsedTags.forEach(tag => {
                if (!container.querySelector(`[data-tag="${tag}"]`)) {
                    tagSet.add(tag);
                    newTagsAdded.push(tag);
                    const span = document.createElement('span');
                    span.className = `pref-tag ${type === 'like' ? 'liked' : 'disliked'} new`;
                    span.textContent = tag;
                    span.dataset.tag = tag;
                    container.appendChild(span);

                    // ÁßªÈô§Âä®ÁîªÁ±ª
                    setTimeout(() => span.classList.remove('new'), 500);
                }
            });

            // Êõ¥Êñ∞Ê†áÁ≠æËÆ°Êï∞
            updateTagCounts();

            // Ê∑ªÂä†Ê¥ªÂä®Êó•Âøó
            if (newTagsAdded.length > 0) {
                const icon = type === 'like' ? 'üëç' : 'üëé';
                const action = type === 'like' ? 'ÂñúÊ¨¢' : '‰∏çÂñúÊ¨¢';
                addActivityLog(type, `${action}: +${newTagsAdded.length}‰∏™Ê†áÁ≠æ [${newTagsAdded.slice(0,2).join(', ')}${newTagsAdded.length > 2 ? '...' : ''}]`, icon);
            }
        }

        // Êõ¥Êñ∞‰∏ä‰∏ãÊñáÂõ†Â≠êËø∑‰Ω†Â±ïÁ§∫
        function updateContextFactorsMini(contextFactors) {
            if (!contextFactors) return;

            const section = document.getElementById('contextRealtimeSection');
            const container = document.getElementById('contextFactorsMini');
            section.style.display = 'block';

            const factorNames = {
                'time_factor': '‚è∞ Êó∂ÊÆµ',
                'weather_factor': 'üå°Ô∏è Â§©Ê∞î',
                'store_factor': 'üìç Èó®Â∫ó',
                'scenario_factor': 'üéØ Âú∫ÊôØ'
            };

            let html = '';
            for (const [key, data] of Object.entries(contextFactors)) {
                if (factorNames[key] && data.value !== undefined) {
                    const valueClass = data.value > 1.05 ? 'boost' : (data.value < 0.95 ? 'reduce' : 'neutral');
                    const valueStr = data.value > 1 ? `+${((data.value - 1) * 100).toFixed(0)}%` : `${((data.value - 1) * 100).toFixed(0)}%`;
                    html += `
                        <div class="context-factor-mini">
                            <span class="name">${factorNames[key]}</span>
                            <span class="value ${valueClass}">${data.value === 1 ? '0%' : valueStr}</span>
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
        }

        // ============ Âø´ÈÄüÊºîÁ§∫ÂäüËÉΩ ============
        document.getElementById('btnDemoInteractions')?.addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'ÊºîÁ§∫‰∏≠...';

            // ÂÖàËé∑ÂèñÊé®Ëçê
            if (currentRecommendations.length === 0) {
                await getRecommendations();
            }

            // Ê®°Êãü‰∏ÄÁ≥ªÂàó‰∫§‰∫í
            const demoActions = [
                { type: 'context', delay: 300, action: () => {
                    addActivityLog('context', `ÂàáÊç¢Èó®Â∫ó: ${selectedStoreId ? storesData.find(s=>s.store_id===selectedStoreId)?.name?.split('(')[1]?.replace(')','') || '‰∏äÊµ∑' : '‰∏äÊµ∑'}`, 'üìç');
                }},
                { type: 'context', delay: 600, action: () => {
                    addActivityLog('context', `Â§©Ê∞î: ${currentCity} ${document.querySelector('#weatherDisplay .temp')?.textContent || '25¬∞C'}`, 'üå§Ô∏è');
                }},
            ];

            // ‰ªéÂΩìÂâçÊé®Ëçê‰∏≠ÈÄâÂèñÂïÜÂìÅËøõË°åÊ®°Êãü‰∫§‰∫í
            if (currentRecommendations.length > 0) {
                const rec1 = currentRecommendations[0];
                demoActions.push({
                    type: 'click', delay: 1000, action: () => {
                        addActivityLog('click', `ÊµèËßà: ${rec1.item.name}`, 'üëÄ');
                        interactionCount++;
                        document.getElementById('interactionCount').textContent = interactionCount;
                    }
                });
                demoActions.push({
                    type: 'like', delay: 1500, action: () => {
                        updateRealtimePrefs('like', rec1.item.tags, rec1.item.name);
                    }
                });

                if (currentRecommendations.length > 1) {
                    const rec2 = currentRecommendations[1];
                    demoActions.push({
                        type: 'click', delay: 2000, action: () => {
                            addActivityLog('click', `ÊµèËßà: ${rec2.item.name}`, 'üëÄ');
                            interactionCount++;
                            document.getElementById('interactionCount').textContent = interactionCount;
                        }
                    });
                    demoActions.push({
                        type: 'cart', delay: 2500, action: () => {
                            addActivityLog('cart', `Âä†Ë¥≠: ${rec2.item.name}`, 'üõí');
                            updateRealtimePrefs('like', rec2.item.tags, rec2.item.name);
                        }
                    });
                }

                if (currentRecommendations.length > 2) {
                    const rec3 = currentRecommendations[2];
                    demoActions.push({
                        type: 'dislike', delay: 3000, action: () => {
                            updateRealtimePrefs('dislike', rec3.item.tags, rec3.item.name);
                        }
                    });
                }
            }

            // ÊâßË°åÊºîÁ§∫
            for (const action of demoActions) {
                await new Promise(resolve => setTimeout(resolve, action.delay));
                action.action();
            }

            btn.disabled = false;
            btn.textContent = 'üéØ Âø´ÈÄüÊºîÁ§∫';
        });

        // ============ ËÆ¢ÂçïÂéÜÂè≤ÂØπÊØîÊºîÁ§∫ ============
        const comparisonUserId = 'demo_order_user_' + Date.now();
        const newUserId = 'brand_new_user_' + Date.now();
        let simulatedOrderCount = 0;

        // Ê®°ÊãüÁîüÊàêËÆ¢Âçï
        document.getElementById('btnSimulateOrders').addEventListener('click', async () => {
            const btn = document.getElementById('btnSimulateOrders');
            const status = document.getElementById('orderStatus');

            btn.disabled = true;
            btn.textContent = 'ÁîüÊàê‰∏≠...';

            try {
                const response = await fetch('/api/orders/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,  // Use current user so preferences show in panel
                        order_count: 20,
                        days_range: 60,
                        category_weights: {
                            'ÂíñÂï°': 0.6,
                            'Ëå∂È•Æ': 0.25,
                            'ÊòüÂÜ∞‰πê': 0.15
                        }
                    })
                });

                const data = await response.json();
                simulatedOrderCount = data.order_count;

                status.className = 'order-status has-orders';
                status.innerHTML = `‚úÖ Â∑≤ÁîüÊàê <strong>${data.order_count}</strong> Á¨îËÆ¢Âçï |
                    ${Object.entries(data.category_distribution).map(([k,v]) => `${k}: ${v}`).join(', ')}`;

            } catch (error) {
                console.error('Error:', error);
                status.textContent = '‚ùå ÁîüÊàêÂ§±Ë¥•';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üé≤ Ê®°ÊãüÁîüÊàêËÆ¢ÂçïÂéÜÂè≤';
            }
        });

        // ÂØπÊØîÊé®ËçêÊïàÊûú
        document.getElementById('btnCompare').addEventListener('click', async () => {
            const btn = document.getElementById('btnCompare');
            const grid = document.getElementById('comparisonGrid');
            const summary = document.getElementById('comparisonSummary');

            btn.disabled = true;
            btn.textContent = 'ÂØπÊØî‰∏≠...';

            try {
                // Âπ∂Ë°åËØ∑Ê±Ç‰∏§‰∏™Áî®Êà∑ÁöÑÊé®Ëçê
                const [oldUserResp, newUserResp] = await Promise.all([
                    fetch('/api/embedding/recommend/v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona_type: selectedPersona,
                            user_id: comparisonUserId,
                            top_k: 4,
                            enable_ab_test: false,
                            enable_behavior: true,
                            enable_session: false,
                            enable_explainability: true
                        })
                    }),
                    fetch('/api/embedding/recommend/v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona_type: selectedPersona,
                            user_id: newUserId,
                            top_k: 4,
                            enable_ab_test: false,
                            enable_behavior: true,
                            enable_session: false,
                            enable_explainability: true
                        })
                    })
                ]);

                const oldUserData = await oldUserResp.json();
                const newUserData = await newUserResp.json();

                // Ê∏≤ÊüìËÄÅÁî®Êà∑Êé®Ëçê
                document.getElementById('oldUserOrderCount').textContent =
                    simulatedOrderCount > 0 ? `(${simulatedOrderCount}Á¨îËÆ¢Âçï)` : '';
                renderComparisonRecs('oldUserRecs', oldUserData.recommendations, true);

                // Ê∏≤ÊüìÊñ∞Áî®Êà∑Êé®Ëçê
                renderComparisonRecs('newUserRecs', newUserData.recommendations, false);

                // ËÆ°ÁÆóÂØπÊØîÁªüËÆ°
                const oldAvgScore = oldUserData.recommendations.reduce((sum, r) => sum + r.match_score, 0) / oldUserData.recommendations.length;
                const newAvgScore = newUserData.recommendations.reduce((sum, r) => sum + r.match_score, 0) / newUserData.recommendations.length;
                const avgBoost = oldUserData.recommendations.reduce((sum, r) => sum + (r.score_breakdown?.behavior_multiplier || 1), 0) / oldUserData.recommendations.length;
                const improvement = ((oldAvgScore / newAvgScore - 1) * 100).toFixed(1);

                document.getElementById('summaryStats').innerHTML = `
                    <div class="summary-stat">
                        <div class="number">${(oldAvgScore * 100).toFixed(1)}%</div>
                        <div class="label">ËÄÅÁî®Êà∑Âπ≥ÂùáÂæóÂàÜ</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number">${(newAvgScore * 100).toFixed(1)}%</div>
                        <div class="label">Êñ∞Áî®Êà∑Âπ≥ÂùáÂæóÂàÜ</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number">√ó${avgBoost.toFixed(2)}</div>
                        <div class="label">Âπ≥ÂùáËÆ¢ÂçïÂä†ÊùÉ</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number" style="color: ${improvement > 0 ? '#22c55e' : '#6366f1'}">
                            ${improvement > 0 ? '+' : ''}${improvement}%
                        </div>
                        <div class="label">Êé®ËçêÊèêÂçá</div>
                    </div>
                `;

                grid.style.display = 'grid';
                summary.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ö° ÂØπÊØîÊé®ËçêÊïàÊûú';
            }
        });

        // ÂÆ¢Âà∂ÂåñÊ†ºÂºèÂåñËæÖÂä©ÂáΩÊï∞
        function formatTemp(temp) {
            const map = { 'HOT': 'ÁÉ≠È•Æ ‚òï', 'ICED': 'ÂÜ∞È•Æ üßä', 'BLENDED': 'ÂÜ∞Ê≤ô üåÄ' };
            return map[temp] || temp;
        }

        function formatSize(size) {
            const map = { 'TALL': '‰∏≠ÊùØ', 'GRANDE': 'Â§ßÊùØ', 'VENTI': 'Ë∂ÖÂ§ßÊùØ' };
            return map[size] || size;
        }

        function formatSugar(sugar) {
            const map = { 'NONE': 'Êó†Á≥ñ', 'LIGHT': 'Â∞ëÁ≥ñ', 'HALF': 'ÂçäÁ≥ñ', 'STANDARD': 'Ê†áÂáÜÁ≥ñ', 'EXTRA': 'Â§öÁ≥ñ' };
            return map[sugar] || sugar;
        }

        function formatMilk(milk) {
            const map = { 'WHOLE': 'ÂÖ®ËÑÇÂ•∂', 'SKIM': 'ËÑ±ËÑÇÂ•∂', 'SOY': 'Ë±ÜÂ•∂', 'OAT': 'ÁáïÈ∫¶Â•∂', 'ALMOND': 'Êùè‰ªÅÂ•∂', 'COCONUT': 'Ê§∞Â•∂' };
            return map[milk] || milk;
        }

        // Êõ¥Êñ∞ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÈù¢Êùø
        async function updateCustomizationPrefs() {
            // ËæÖÂä©ÂáΩÊï∞ÔºöÊõ¥Êñ∞ÂÅèÂ•ΩÈ°π
            function updatePrefItem(elementId, value) {
                const el = document.getElementById(elementId);
                if (value && value !== '-') {
                    el.textContent = value;
                    el.className = 'pref-value';
                } else {
                    el.textContent = 'ÊöÇÊó†Êï∞ÊçÆ';
                    el.className = 'pref-value empty';
                }
            }

            try {
                const response = await fetch(`/api/behavior/user/${userId}`);
                const data = await response.json();

                const panel = document.getElementById('custPrefsPanel');
                panel.style.display = 'block';

                if (data.customization_preference) {
                    const cp = data.customization_preference;

                    // Ê∏©Â∫¶ÂÅèÂ•Ω (backend returns 'temperature' not 'temperature_preference')
                    if (cp.temperature && Object.keys(cp.temperature).length > 0) {
                        const temps = Object.entries(cp.temperature)
                            .sort((a, b) => b[1] - a[1])
                            .map(([k, v]) => `${formatTemp(k)} ${(v * 100).toFixed(0)}%`)
                            .join(', ');
                        updatePrefItem('tempPref', temps);
                    } else {
                        updatePrefItem('tempPref', null);
                    }

                    // Â•∂Á±ªÂÅèÂ•Ω (backend returns 'milk' not 'milk_preference')
                    if (cp.milk && Object.keys(cp.milk).length > 0) {
                        const milks = Object.entries(cp.milk)
                            .sort((a, b) => b[1] - a[1])
                            .map(([k, v]) => `${formatMilk(k)} ${(v * 100).toFixed(0)}%`)
                            .join(', ');
                        updatePrefItem('milkPref', milks);
                    } else {
                        updatePrefItem('milkPref', null);
                    }

                    // Á≥ñÂ∫¶ÂÅèÂ•Ω (backend returns 'sugar' not 'sugar_preference')
                    if (cp.sugar && Object.keys(cp.sugar).length > 0) {
                        const sugars = Object.entries(cp.sugar)
                            .sort((a, b) => b[1] - a[1])
                            .map(([k, v]) => `${formatSugar(k)} ${(v * 100).toFixed(0)}%`)
                            .join(', ');
                        updatePrefItem('sugarPref', sugars);
                    } else {
                        updatePrefItem('sugarPref', null);
                    }

                    // ÂÆ¢Âà∂ÂåñÂÖ≥ÈîÆËØç
                    const keywordsContainer = document.getElementById('custKeywords');
                    if (data.customization_keywords && data.customization_keywords.length > 0) {
                        keywordsContainer.className = 'pref-value';
                        keywordsContainer.innerHTML = data.customization_keywords
                            .map(k => `<span class="customization-keyword">${k}</span>`)
                            .join(' ');
                    } else {
                        keywordsContainer.className = 'pref-value empty';
                        keywordsContainer.textContent = 'ÊöÇÊó†Êï∞ÊçÆ';
                    }
                } else {
                    // Ê≤°ÊúâÂÅèÂ•ΩÊï∞ÊçÆ
                    updatePrefItem('tempPref', null);
                    updatePrefItem('milkPref', null);
                    updatePrefItem('sugarPref', null);
                    const keywordsContainer = document.getElementById('custKeywords');
                    keywordsContainer.className = 'pref-value empty';
                    keywordsContainer.textContent = 'ÊöÇÊó†Êï∞ÊçÆ';
                }
            } catch (error) {
                console.log('No customization preferences yet');
            }
        }

        // ============ È¢ÑËÆæÁÆ°ÁêÜ ============
        document.getElementById('btnCreatePreset').addEventListener('click', async () => {
            const btn = document.getElementById('btnCreatePreset');
            const status = document.getElementById('presetStatus');

            btn.disabled = true;
            btn.textContent = 'ÂàõÂª∫‰∏≠...';

            try {
                const response = await fetch('/api/presets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        name: 'ÊàëÁöÑÊó•Â∏∏',
                        default_temperature: 'ICED',
                        default_cup_size: 'GRANDE',
                        default_sugar_level: 'NONE',
                        default_milk_type: 'OAT'
                    })
                });

                const data = await response.json();
                if (data.preset) {
                    status.className = 'order-status has-orders';
                    status.innerHTML = `‚úÖ Â∑≤ÂàõÂª∫È¢ÑËÆæ: <strong>${data.preset.name}</strong>`;
                    loadUserPresets();
                }
            } catch (error) {
                console.error('Error:', error);
                status.textContent = '‚ùå ÂàõÂª∫Â§±Ë¥•';
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ûï ÂàõÂª∫È¢ÑËÆæ';
            }
        });

        document.getElementById('btnLoadPresets').addEventListener('click', loadUserPresets);

        async function loadUserPresets() {
            const container = document.getElementById('presetList');
            const status = document.getElementById('presetStatus');

            try {
                const response = await fetch(`/api/presets/user/${userId}`);
                const data = await response.json();

                if (data.presets && data.presets.length > 0) {
                    container.innerHTML = data.presets.map(p => `
                        <div class="preset-card">
                            <div class="name">üìã ${p.name}</div>
                            <div class="options">
                                ${p.default_temperature ? formatTemp(p.default_temperature) : ''}
                                ${p.default_cup_size ? ' ¬∑ ' + formatSize(p.default_cup_size) : ''}
                                ${p.default_sugar_level ? ' ¬∑ ' + formatSugar(p.default_sugar_level) : ''}
                                ${p.default_milk_type ? ' ¬∑ ' + formatMilk(p.default_milk_type) : ''}
                            </div>
                        </div>
                    `).join('');
                    status.className = 'order-status has-orders';
                    status.innerHTML = `‚úÖ Â∑≤Âä†ËΩΩ <strong>${data.presets.length}</strong> ‰∏™È¢ÑËÆæ`;
                } else {
                    container.innerHTML = '<div style="color: #888; font-size: 12px;">ÊöÇÊó†È¢ÑËÆæÔºåÁÇπÂáª"ÂàõÂª∫È¢ÑËÆæ"ÂºÄÂßã</div>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderComparisonRecs(containerId, recommendations, showBoost) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            recommendations.forEach((rec, index) => {
                const breakdown = rec.score_breakdown || {};
                const orderDetail = breakdown.order_boost_detail || {};
                const hasBoosted = breakdown.behavior_multiplier > 1;

                let boostHtml = '';
                if (showBoost && hasBoosted && orderDetail.factors) {
                    boostHtml = `
                        <div class="boost-detail">
                            <div class="factor">
                                <span class="label">Â§çË¥≠Âä†ÊùÉ</span>
                                <span class="value">√ó${orderDetail.factors.repurchase?.toFixed(2) || '1.00'}</span>
                            </div>
                            <div class="factor">
                                <span class="label">Á±ªÂà´ÂÅèÂ•Ω</span>
                                <span class="value">√ó${orderDetail.factors.category?.toFixed(2) || '1.00'}</span>
                            </div>
                            <div class="factor">
                                <span class="label">Ê†áÁ≠æÂåπÈÖç</span>
                                <span class="value">√ó${orderDetail.factors.tag?.toFixed(2) || '1.00'}</span>
                            </div>
                            <div class="factor">
                                <span class="label">‰ª∑Ê†ºÂåπÈÖç</span>
                                <span class="value">√ó${orderDetail.factors.price_match?.toFixed(2) || '1.00'}</span>
                            </div>
                            ${orderDetail.explanation ? `<div class="boost-explanation">üí° ${orderDetail.explanation}</div>` : ''}
                        </div>
                    `;
                }

                const hasCustBoosted = breakdown.customization_multiplier && breakdown.customization_multiplier !== 1;

                const item = document.createElement('div');
                item.className = 'comparison-item';
                item.innerHTML = `
                    <div class="comparison-item-header">
                        <div>
                            <div class="comparison-item-name">${index + 1}. ${rec.item.name}</div>
                            <div style="font-size: 12px; color: #888;">${rec.item.category} ¬∑ ¬•${rec.item.base_price}</div>
                        </div>
                        <div class="comparison-item-score ${hasBoosted ? 'boosted' : 'normal'}">
                            ${(rec.match_score * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        Embedding: ${(breakdown.embedding_similarity * 100).toFixed(1)}%
                        √ó ËßÑÂàô: ${breakdown.rule_multiplier?.toFixed(2) || '1.00'}
                        √ó <strong style="color: ${hasBoosted ? '#22c55e' : '#666'}">ËÆ¢Âçï: ${breakdown.behavior_multiplier?.toFixed(2) || '1.00'}</strong>
                        √ó <strong style="color: ${hasCustBoosted ? '#0369a1' : '#666'}">ÂÆ¢Âà∂Âåñ: ${breakdown.customization_multiplier?.toFixed(2) || '1.00'}</strong>
                    </div>
                    ${boostHtml}
                `;
                container.appendChild(item);
            });
        }

        // ============ Ëá™ÂÆö‰πâÂÅèÂ•ΩÊêúÁ¥¢ ============
        function addHint(hint) {
            const input = document.getElementById('customPreference');
            const currentVal = input.value.trim();
            if (currentVal) {
                input.value = currentVal + '„ÄÅ' + hint;
            } else {
                input.value = hint;
            }
        }

        document.getElementById('btnCustomSearch').addEventListener('click', searchByCustomPreference);
        document.getElementById('customPreference').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchByCustomPreference();
        });

        async function searchByCustomPreference() {
            const input = document.getElementById('customPreference').value.trim();
            if (!input) return;

            const btn = document.getElementById('btnCustomSearch');
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('recommendationsGrid');

            btn.disabled = true;
            btn.textContent = 'ÂåπÈÖç‰∏≠...';
            loading.style.display = 'flex';
            grid.innerHTML = '';

            try {
                const response = await fetch('/api/embedding/recommend/custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        custom_preference: input,
                        user_id: userId,
                        session_id: sessionId,
                        top_k: 6,
                        enable_ab_test: document.getElementById('enableABTest').checked,
                        enable_behavior: document.getElementById('enableBehavior').checked,
                        enable_session: document.getElementById('enableSession').checked,
                        enable_explainability: document.getElementById('enableExplainability').checked,
                        enable_customization: document.getElementById('enableCustomization').checked
                    })
                });

                const data = await response.json();
                currentRecommendations = data.recommendations || [];

                // ‰ΩøÁî®Â¢ûÂº∫ÁâàÂÆûÈ™åÂàÜÁªÑÊ∏≤Êüì
                renderExperimentBanner(data.experiment);

                // ÊòæÁ§∫ÊåáÊ†á
                if (data.metrics) {
                    document.getElementById('metricsCard').style.display = 'block';
                    document.getElementById('metricTime').textContent = `${data.metrics.total_time_ms}ms`;
                    document.getElementById('metricLLM').textContent = `${data.llm_info?.total_llm_calls || 0}Ê¨°`;
                    document.getElementById('metricScore').textContent = `${(data.metrics.avg_match_score * 100).toFixed(1)}%`;
                }

                renderRecommendations(data.recommendations);

                if (data.recommendations?.[0]?.explanation) {
                    showExplanation(data.recommendations[0].explanation);
                }

            } catch (error) {
                console.error('Error:', error);
                grid.innerHTML = `<div style="color: red; padding: 20px;">ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Êô∫ËÉΩÂåπÈÖç';
                loading.style.display = 'none';
            }
        }

        // ============ Ë¥≠Áâ©ËΩ¶ÂäüËÉΩ ============
        let cartData = { items: [], total_price: 0, total_items: 0 };

        // ÂàùÂßãÂåñÂä†ËΩΩË¥≠Áâ©ËΩ¶
        async function loadCart() {
            try {
                const response = await fetch(`/api/cart/${sessionId}`);
                cartData = await response.json();
                renderCart();
            } catch (error) {
                console.log('Cart not loaded:', error);
            }
        }

        // Ê∑ªÂä†Âà∞Ë¥≠Áâ©ËΩ¶
        async function addToCart(sku, name, price, btn, customization) {
            btn.disabled = true;
            btn.textContent = 'Ê∑ªÂä†‰∏≠...';

            try {
                // Â§ÑÁêÜcustomization - Ëß£ÊûêÂçïÂºïÂè∑ÁöÑJSON
                let custData = null;
                if (customization && typeof customization === 'string') {
                    try {
                        custData = JSON.parse(customization.replace(/'/g, '"'));
                    } catch (e) {}
                } else if (customization && typeof customization === 'object' && Object.keys(customization).length > 0) {
                    custData = customization;
                }

                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_id: userId,
                        item_sku: sku,
                        quantity: 1,
                        customization: custData
                    })
                });

                const data = await response.json();
                if (data.status === 'added') {
                    cartData = data.cart;
                    renderCart();
                    btn.classList.add('added');
                    btn.textContent = '‚úì Â∑≤Âä†ÂÖ•';

                    // ËÆ∞ÂΩïÊ¥ªÂä®Êó•ÂøóÂíåÊõ¥Êñ∞ÂÅèÂ•Ω
                    addActivityLog('cart', `Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶: ${name}`, 'üõí');
                    interactionCount++;
                    document.getElementById('interactionCount').textContent = interactionCount;

                    // ‰ªéÊé®Ëçê‰∏≠ÊâæÂà∞ÂïÜÂìÅËé∑ÂèñÊ†áÁ≠æ
                    const rec = currentRecommendations.find(r => r.item.sku === sku);
                    if (rec?.item?.tags) {
                        updateRealtimePrefs('like', rec.item.tags, name);
                    }

                    setTimeout(() => {
                        btn.classList.remove('added');
                        btn.textContent = 'üõí Âä†ÂÖ•';
                    }, 1500);
                } else {
                    alert(data.message || 'Ê∑ªÂä†Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Add to cart error:', error);
                alert('Ê∑ªÂä†Â§±Ë¥•');
            } finally {
                btn.disabled = false;
            }
        }

        // Êõ¥Êñ∞Ë¥≠Áâ©ËΩ¶ÂïÜÂìÅÊï∞Èáè
        async function updateCartItemQty(itemId, delta) {
            const item = cartData.items.find(i => i.id === itemId);
            if (!item) return;

            const newQty = item.quantity + delta;

            try {
                const response = await fetch(`/api/cart/${sessionId}/item/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQty })
                });

                const data = await response.json();
                if (data.status === 'updated') {
                    cartData = data.cart;
                    renderCart();
                }
            } catch (error) {
                console.error('Update cart error:', error);
            }
        }

        // Âà†Èô§Ë¥≠Áâ©ËΩ¶ÂïÜÂìÅ
        async function removeCartItem(itemId) {
            try {
                const response = await fetch(`/api/cart/${sessionId}/item/${itemId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'removed') {
                    cartData = data.cart;
                    renderCart();
                }
            } catch (error) {
                console.error('Remove cart error:', error);
            }
        }

        // Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶
        document.getElementById('btnClearCart').addEventListener('click', async () => {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÂêóÔºü')) return;

            try {
                const response = await fetch(`/api/cart/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'cleared') {
                    cartData = data.cart;
                    renderCart();
                }
            } catch (error) {
                console.error('Clear cart error:', error);
            }
        });

        // ÁªìÁÆó
        document.getElementById('btnCheckout').addEventListener('click', async () => {
            if (cartData.items.length === 0) return;

            const btn = document.getElementById('btnCheckout');
            btn.disabled = true;
            btn.textContent = 'Â§ÑÁêÜ‰∏≠...';

            try {
                const response = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_id: userId
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showOrderModal(data);
                    cartData = { items: [], total_price: 0, total_items: 0 };
                    renderCart();
                } else {
                    alert(data.message || 'ÁªìÁÆóÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('ÁªìÁÆóÂ§±Ë¥•');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ÂéªÁªìÁÆó';
            }
        });

        // Ê∏≤ÊüìË¥≠Áâ©ËΩ¶
        function renderCart() {
            const itemsContainer = document.getElementById('cartItems');
            const footer = document.getElementById('cartFooter');
            const clearBtn = document.getElementById('btnClearCart');
            const badge = document.getElementById('cartBadge');
            const total = document.getElementById('cartTotal');

            badge.textContent = cartData.total_items || 0;
            total.textContent = `¬•${(cartData.total_price || 0).toFixed(2)}`;

            if (!cartData.items || cartData.items.length === 0) {
                itemsContainer.innerHTML = '<div class="cart-empty">Ë¥≠Áâ©ËΩ¶ÊòØÁ©∫ÁöÑ</div>';
                footer.style.display = 'none';
                clearBtn.style.display = 'none';
                return;
            }

            footer.style.display = 'block';
            clearBtn.style.display = 'block';

            itemsContainer.innerHTML = cartData.items.map(item => {
                const custText = formatCartCustomization(item.customization);
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.item_name}</div>
                            ${custText ? `<div class="cart-item-customization">${custText}</div>` : ''}
                        </div>
                        <div class="cart-item-qty">
                            <button onclick="updateCartItemQty('${item.id}', -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateCartItemQty('${item.id}', 1)">+</button>
                        </div>
                        <div class="cart-item-price">¬•${(item.final_price * item.quantity).toFixed(2)}</div>
                        <button class="cart-item-remove" onclick="removeCartItem('${item.id}')">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function formatCartCustomization(cust) {
            if (!cust) return '';
            const parts = [];
            if (cust.cup_size) parts.push(formatSize(cust.cup_size));
            if (cust.temperature) parts.push(formatTemp(cust.temperature));
            if (cust.sugar_level) parts.push(formatSugar(cust.sugar_level));
            if (cust.milk_type && cust.milk_type !== 'WHOLE') parts.push(formatMilk(cust.milk_type));
            return parts.join(' ¬∑ ');
        }

        // ÊòæÁ§∫ËÆ¢ÂçïÊàêÂäüÂºπÁ™ó
        function showOrderModal(data) {
            const modal = document.getElementById('orderModal');
            document.getElementById('modalOrderId').textContent = `ËÆ¢ÂçïÂè∑: ${data.order_id}`;
            document.getElementById('modalOrderTotal').textContent = `¬•${data.order.total_price.toFixed(2)}`;
            document.getElementById('modalOrderItems').innerHTML = data.order.items.map(item =>
                `<div>${item.item_name} √ó ${item.quantity} = ¬•${(item.final_price * item.quantity).toFixed(2)}</div>`
            ).join('');
            modal.style.display = 'flex';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        // ============ ÂÆûÊó∂Âà∑Êñ∞Êú∫Âà∂ ============
        let refreshTimer = null;
        let autoRefreshEnabled = true;

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = 'flex';
            indicator.classList.remove('hidden');
        }

        function hideRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('hidden');
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 300);
        }

        async function autoRefreshRecommendations() {
            if (!autoRefreshEnabled || currentRecommendations.length === 0) return;

            showRefreshIndicator();

            try {
                const customPref = document.getElementById('customPreference').value.trim();

                const response = await fetch(customPref ? '/api/embedding/recommend/custom' : '/api/embedding/recommend/v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona_type: selectedPersona,
                        custom_preference: customPref || undefined,
                        user_id: userId,
                        session_id: sessionId,
                        top_k: 6,
                        enable_ab_test: document.getElementById('enableABTest').checked,
                        enable_behavior: document.getElementById('enableBehavior').checked,
                        enable_session: document.getElementById('enableSession').checked,
                        enable_explainability: document.getElementById('enableExplainability').checked,
                        enable_customization: document.getElementById('enableCustomization').checked
                    })
                });

                const data = await response.json();
                currentRecommendations = data.recommendations || [];
                renderRecommendations(data.recommendations);

                // Êõ¥Êñ∞ÊåáÊ†á
                if (data.metrics) {
                    document.getElementById('metricTime').textContent = `${data.metrics.total_time_ms}ms`;
                    document.getElementById('metricScore').textContent = `${(data.metrics.avg_match_score * 100).toFixed(1)}%`;
                }

            } catch (error) {
                console.error('Auto refresh error:', error);
            } finally {
                hideRefreshIndicator();
            }
        }

        // ‰øÆÊîπrecordFeedbackÂáΩÊï∞ÔºåÊ∑ªÂä†Ëá™Âä®Âà∑Êñ∞
        const originalRecordFeedback = recordFeedback;
        recordFeedback = async function(sku, type, btn, tags) {
            // ËßÜËßâÂèçÈ¶à
            btn.classList.add('clicked');

            // Êõ¥Êñ∞‰∫§‰∫íËÆ°Êï∞
            interactionCount++;
            document.getElementById('interactionCount').textContent = interactionCount;

            // Êõ¥Êñ∞ÂÆûÊó∂ÂÅèÂ•ΩÊòæÁ§∫
            updateRealtimePrefs(type, tags);

            // ËÆ∞ÂΩïÂèçÈ¶à
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        session_id: sessionId,
                        item_sku: sku,
                        feedback_type: type
                    })
                });

                // ËÆ∞ÂΩïSession‰∫§‰∫í
                const item = currentRecommendations.find(r => r.item.sku === sku)?.item;
                if (item) {
                    await fetch('/api/session/interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            interaction_type: type,
                            item_data: {
                                sku: item.sku,
                                tags: item.tags,
                                category: item.category,
                                price: item.base_price
                            }
                        })
                    });
                }

                // Ëß¶ÂèëËá™Âä®Âà∑Êñ∞ÔºàÈò≤ÊäñÔºâ
                if (refreshTimer) clearTimeout(refreshTimer);
                refreshTimer = setTimeout(autoRefreshRecommendations, 800);

            } catch (error) {
                console.error('Feedback error:', error);
            }
        };

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñË¥≠Áâ©ËΩ¶
        loadCart();
    </script>

    <!-- ÁÆóÊ≥ïËØ¶ÊÉÖÂºπÁ™ó -->
    <div class="algorithm-modal-overlay" id="algorithmModal" onclick="closeAlgorithmModal(event)">
        <div class="algorithm-modal" onclick="event.stopPropagation()">
            <div class="algorithm-modal-header">
                <div class="algorithm-modal-title" id="algorithmModalTitle">ÁÆóÊ≥ïËØ¶ÊÉÖ</div>
                <button class="algorithm-modal-close" onclick="closeAlgorithmModal()">&times;</button>
            </div>
            <div class="algorithm-modal-body" id="algorithmModalBody">
                <!-- ÂÜÖÂÆπÂä®ÊÄÅÂ°´ÂÖÖ -->
            </div>
            <div class="algorithm-modal-footer">
                <div class="algorithm-nav">
                    <button class="btn-nav" id="btnPrevStep" onclick="navigateStep(-1)">‚Üê ‰∏ä‰∏ÄÊ≠•</button>
                    <span class="step-indicator" id="stepIndicator">1 / 5</span>
                    <button class="btn-nav" id="btnNextStep" onclick="navigateStep(1)">‰∏ã‰∏ÄÊ≠• ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ ÁÆóÊ≥ïËØ¶ÊÉÖÂºπÁ™ó ============
        let currentDetailStep = 1;

        const algorithmDetails = {
            1: {
                title: "üë§ Step 1: Áî®Êà∑ÁîªÂÉèÁîüÊàê",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>Â∞ÜÁî®Êà∑ÈÄâÊã©ÁöÑ‰∫∫Áæ§Á±ªÂûãÔºàPersonaÔºâËΩ¨Âåñ‰∏∫ÂèØÁî®‰∫éËØ≠‰πâÊêúÁ¥¢ÁöÑËá™ÁÑ∂ËØ≠Ë®ÄÊü•ËØ¢„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>üìã ËæìÂÖ•Êï∞ÊçÆ</h3>
                        <div class="code-block">
{
  "persona_type": "ÂíñÂï°ÈáçÂ∫¶Áî®Êà∑",
  "user_id": "user_abc123",
  "session_id": "sess_xyz789"
}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>‚öôÔ∏è Â§ÑÁêÜÊµÅÁ®ã</h3>
                        <div class="flow-diagram">
                            <div class="flow-step">
                                <div class="flow-num">1</div>
                                <div class="flow-content">
                                    <strong>PersonaÊ®°ÊùøÂåπÈÖç</strong>
                                    <p>‰ªéÈ¢ÑÂÆö‰πâÁöÑ6ÁßçÁî®Êà∑ÁîªÂÉèÊ®°Êùø‰∏≠ÂåπÈÖçÔºö</p>
                                    <ul>
                                        <li>‚òï ÂíñÂï°ÈáçÂ∫¶Áî®Êà∑ ‚Üí ÊµìÈÉÅ„ÄÅÊèêÁ•û„ÄÅÁªèÂÖ∏</li>
                                        <li>ü•ó ÂÅ•Â∫∑Ëææ‰∫∫ ‚Üí ‰ΩéÂç°„ÄÅÊó†Á≥ñ„ÄÅÁáïÈ∫¶Â•∂</li>
                                        <li>üç∞ ÁîúÂìÅÁà±Â•ΩËÄÖ ‚Üí ÁîúËúú„ÄÅÂ•∂Ê≤π„ÄÅÊòüÂÜ∞‰πê</li>
                                        <li>üÜï Â∞ùÈ≤úÊ¥æ ‚Üí Êñ∞ÂìÅ„ÄÅÈôêÂÆö„ÄÅÁΩëÁ∫¢</li>
                                        <li>üíº ÂÆûÁî®‰∏ª‰πâ ‚Üí ÁªèÂÖ∏„ÄÅÊÄß‰ª∑ÊØî„ÄÅ‰æøÊê∫</li>
                                        <li>üåø ÂÖªÁîüÁôΩÈ¢Ü ‚Üí ÂÅ•Â∫∑„ÄÅËå∂È•Æ„ÄÅ‰ΩéÂõ†</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="flow-step">
                                <div class="flow-num">2</div>
                                <div class="flow-content">
                                    <strong>LLMÂ¢ûÂº∫ÔºàÂèØÈÄâÔºâ</strong>
                                    <p>Ë∞ÉÁî®GPT-4o-miniÁîüÊàêÊõ¥‰∏∞ÂØåÁöÑÁî®Êà∑ÂÅèÂ•ΩÊèèËø∞Ôºö</p>
                                    <div class="code-block" style="font-size: 11px;">
Prompt: "Ê†πÊçÆÁî®Êà∑Á±ªÂûã'ÂíñÂï°ÈáçÂ∫¶Áî®Êà∑'Ôºå
ÁîüÊàêÈÄÇÂêàÊé®ËçêÊêúÁ¥¢ÁöÑÂÖ≥ÈîÆËØç..."

Output: "ÂñúÊ¨¢ÊµìÈÉÅÂè£ÊÑüÁöÑÁªèÂÖ∏ÂíñÂï°Ôºå
ËøΩÊ±ÇÊèêÁ•ûÊïàÊûúÔºåÂÅèÂ•ΩÁæéÂºè„ÄÅÊãøÈìÅÁ≠â‰º†ÁªüÈ•ÆÂìÅ"
                                    </div>
                                </div>
                            </div>
                            <div class="flow-step">
                                <div class="flow-num">3</div>
                                <div class="flow-content">
                                    <strong>ÁîüÊàêÊêúÁ¥¢Query</strong>
                                    <p>ÁªÑÂêàÁî®Êà∑ÂÅèÂ•Ω + ‰∏ä‰∏ãÊñáÁîüÊàêÊúÄÁªàÊü•ËØ¢ÊñáÊú¨</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üì§ ËæìÂá∫ÁªìÊûú</h3>
                        <div class="code-block">
{
  "search_query": "ÂñúÊ¨¢ÊµìÈÉÅÂè£ÊÑüÁöÑÁªèÂÖ∏ÂíñÂï°ÔºåËøΩÊ±ÇÊèêÁ•ûÊïàÊûúÔºå
ÂÅèÂ•ΩÁæéÂºè„ÄÅÊãøÈìÅÁ≠â‰º†ÁªüÂíñÂï°È•ÆÂìÅÔºåÊ≥®ÈáçÂíñÂï°Âõ†Âê´Èáè",
  "preference_tags": ["ÊµìÈÉÅ", "ÊèêÁ•û", "ÁªèÂÖ∏", "ÂíñÂï°Âõ†"],
  "duration_ms": 245
}
                        </div>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° ËÆæËÆ°Ë¶ÅÁÇπ</h3>
                        <ul>
                            <li><strong>Ê®°Êùø+LLMÊ∑∑Âêà</strong>ÔºöÊ®°Êùø‰øùËØÅÂü∫Á°ÄË¥®ÈáèÔºåLLMÊèê‰æõ‰∏™ÊÄßÂåñ</li>
                            <li><strong>‰∏ä‰∏ãÊñáÊÑüÁü•</strong>ÔºöÂèØËûçÂÖ•Êó∂ÊÆµ„ÄÅÂ§©Ê∞îÁ≠âÂÆûÊó∂Âõ†Á¥†</li>
                            <li><strong>ÂèØËß£ÈáäÊÄß</strong>Ôºö‰øùÁïôpreference_tags‰æø‰∫éÂêéÁª≠Ëß£Èáä</li>
                        </ul>
                    </div>
                `
            },
            2: {
                title: "üî¢ Step 2: Áî®Êà∑ÂêëÈáèÂåñ (Embedding)",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>Â∞ÜÁî®Êà∑ÁîªÂÉèÁöÑËá™ÁÑ∂ËØ≠Ë®ÄÊèèËø∞ËΩ¨Âåñ‰∏∫È´òÁª¥ÂêëÈáèÔºå‰ΩøÂÖ∂ÂèØ‰∏éÂïÜÂìÅÂêëÈáèËøõË°åÊï∞Â≠¶ÊØîËæÉ„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>üß† EmbeddingÂéüÁêÜ</h3>
                        <div class="concept-card">
                            <div class="concept-title">‰ªÄ‰πàÊòØText Embedding?</div>
                            <p>Â∞ÜÊñáÊú¨Êò†Â∞ÑÂà∞È´òÁª¥ÂêëÈáèÁ©∫Èó¥ÔºåËØ≠‰πâÁõ∏‰ººÁöÑÊñáÊú¨Âú®ÂêëÈáèÁ©∫Èó¥‰∏≠Ë∑ùÁ¶ªÊõ¥Ëøë„ÄÇ</p>
                            <div class="vector-visual">
                                <div class="vector-item">
                                    <span class="text">"ÂíñÂï°Áà±Â•ΩËÄÖ"</span>
                                    <span class="arrow">‚Üí</span>
                                    <span class="vector">[0.12, -0.34, 0.56, ..., 0.78]</span>
                                </div>
                                <div class="vector-item">
                                    <span class="text">"ÁæéÂºèÂíñÂï°"</span>
                                    <span class="arrow">‚Üí</span>
                                    <span class="vector">[0.15, -0.31, 0.52, ..., 0.81]</span>
                                </div>
                                <div class="similarity">‰ΩôÂº¶Áõ∏‰ººÂ∫¶: 0.92 ‚úì È´òÂ∫¶Áõ∏‰ºº</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>‚öôÔ∏è ÊäÄÊúØÂÆûÁé∞</h3>
                        <div class="tech-stack">
                            <div class="tech-item">
                                <div class="tech-name">Ê®°Âûã</div>
                                <div class="tech-value">OpenAI text-embedding-3-small</div>
                            </div>
                            <div class="tech-item">
                                <div class="tech-name">ÂêëÈáèÁª¥Â∫¶</div>
                                <div class="tech-value">1536Áª¥</div>
                            </div>
                            <div class="tech-item">
                                <div class="tech-name">APIË∞ÉÁî®</div>
                                <div class="tech-value">~50-100ms / Ê¨°</div>
                            </div>
                        </div>

                        <div class="code-block">
# Python ÂÆûÁé∞
from openai import OpenAI

client = OpenAI()
response = client.embeddings.create(
    model="text-embedding-3-small",
    input="ÂñúÊ¨¢ÊµìÈÉÅÂè£ÊÑüÁöÑÁªèÂÖ∏ÂíñÂï°ÔºåËøΩÊ±ÇÊèêÁ•ûÊïàÊûú"
)
user_vector = response.data[0].embedding
# => [0.012, -0.034, 0.056, ...] (1536Áª¥)
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üì¶ ÂïÜÂìÅÂêëÈáèÈ¢ÑËÆ°ÁÆó</h3>
                        <p>‰∏∫ÊèêÂçáÊÄßËÉΩÔºåÊâÄÊúâÂïÜÂìÅÁöÑEmbeddingÂú®ÂêØÂä®Êó∂È¢ÑËÆ°ÁÆóÂπ∂ÁºìÂ≠òÔºö</p>
                        <div class="cache-diagram">
                            <div class="cache-item">
                                <span class="sku">COF001</span>
                                <span class="name">ÁæéÂºèÂíñÂï°</span>
                                <span class="desc">"ÁªèÂÖ∏ÁæéÂºèÔºåÊµìÈÉÅÂíñÂï°È¶ô..."</span>
                                <span class="vector">[1536Áª¥ÂêëÈáè]</span>
                            </div>
                            <div class="cache-item">
                                <span class="sku">COF002</span>
                                <span class="name">ÊãøÈìÅ</span>
                                <span class="desc">"ÈÜáÂéöÊãøÈìÅÔºå‰∏ùÊªëÂ•∂Ê≥°..."</span>
                                <span class="vector">[1536Áª¥ÂêëÈáè]</span>
                            </div>
                            <div class="cache-info">üíæ ÁºìÂ≠òËá≥ app/cache/embeddings.pkl</div>
                        </div>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° ÊÄßËÉΩ‰ºòÂåñ</h3>
                        <ul>
                            <li><strong>ÂÜ∑ÂêØÂä®‰ºòÂåñ</strong>ÔºöÈ¶ñÊ¨°ÂêØÂä®È¢ÑËÆ°ÁÆóÊâÄÊúâÂïÜÂìÅÂêëÈáè(~10s)</li>
                            <li><strong>Â¢ûÈáèÊõ¥Êñ∞</strong>ÔºöËèúÂçïÂèòÊõ¥Êó∂Âè™ÈáçÁÆóÊñ∞Â¢ûÂïÜÂìÅ</li>
                            <li><strong>ÊâπÈáèËØ∑Ê±Ç</strong>ÔºöÂ§ö‰∏™ÊñáÊú¨ÂèØÊâπÈáèÂèëÈÄÅÂáèÂ∞ëAPIË∞ÉÁî®</li>
                        </ul>
                    </div>
                `
            },
            3: {
                title: "üîç Step 3: ËØ≠‰πâÂè¨Âõû (Semantic Retrieval)",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>ÈÄöËøáÂêëÈáèÁõ∏‰ººÂ∫¶ËÆ°ÁÆóÔºå‰ªéÂÖ®ÈÉ®ÂïÜÂìÅ‰∏≠Âè¨Âõû‰∏éÁî®Êà∑ÂÅèÂ•ΩÊúÄÂåπÈÖçÁöÑÂÄôÈÄâÈõÜ„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>üìê ‰ΩôÂº¶Áõ∏‰ººÂ∫¶ËÆ°ÁÆó</h3>
                        <div class="formula-card">
                            <div class="formula">
                                cos(Œ∏) = (A ¬∑ B) / (||A|| √ó ||B||)
                            </div>
                            <div class="formula-explain">
                                <p>‚Ä¢ <strong>A ¬∑ B</strong>ÔºöÁî®Êà∑ÂêëÈáè‰∏éÂïÜÂìÅÂêëÈáèÁöÑÁÇπÁßØ</p>
                                <p>‚Ä¢ <strong>||A||, ||B||</strong>ÔºöÂêëÈáèÁöÑL2ËåÉÊï∞ÔºàÈïøÂ∫¶Ôºâ</p>
                                <p>‚Ä¢ <strong>ÁªìÊûúËåÉÂõ¥</strong>Ôºö[-1, 1]ÔºåË∂äÊé•Ëøë1Ë°®Á§∫Ë∂äÁõ∏‰ºº</p>
                            </div>
                        </div>

                        <div class="code-block">
import numpy as np

def cosine_similarity(vec_a, vec_b):
    dot_product = np.dot(vec_a, vec_b)
    norm_a = np.linalg.norm(vec_a)
    norm_b = np.linalg.norm(vec_b)
    return dot_product / (norm_a * norm_b)

# Á§∫‰æã
user_vec = [0.12, -0.34, 0.56, ...]  # 1536Áª¥
item_vec = [0.15, -0.31, 0.52, ...]  # 1536Áª¥
similarity = cosine_similarity(user_vec, item_vec)
# => 0.847
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üîÑ Âè¨ÂõûÊµÅÁ®ã</h3>
                        <div class="retrieval-flow">
                            <div class="retrieval-step">
                                <div class="step-icon">üìä</div>
                                <div class="step-content">
                                    <strong>ÈÅçÂéÜÂÖ®ÈÉ®ÂïÜÂìÅ</strong>
                                    <p>ËÆ°ÁÆóÁî®Êà∑ÂêëÈáè‰∏éÊØè‰∏™ÂïÜÂìÅÂêëÈáèÁöÑ‰ΩôÂº¶Áõ∏‰ººÂ∫¶</p>
                                </div>
                            </div>
                            <div class="retrieval-step">
                                <div class="step-icon">üìà</div>
                                <div class="step-content">
                                    <strong>Áõ∏‰ººÂ∫¶ÊéíÂ∫è</strong>
                                    <p>ÊåâÁõ∏‰ººÂ∫¶ÈôçÂ∫èÊéíÂàóÊâÄÊúâÂïÜÂìÅ</p>
                                </div>
                            </div>
                            <div class="retrieval-step">
                                <div class="step-icon">üéØ</div>
                                <div class="step-content">
                                    <strong>Top-KÊà™Êñ≠</strong>
                                    <p>ÂèñÂâçK‰∏™‰Ωú‰∏∫ÂÄôÈÄâÈõÜÔºàÈªòËÆ§K=20Ôºâ</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üìã Âè¨ÂõûÁªìÊûúÁ§∫‰æã</h3>
                        <table class="result-table">
                            <tr><th>ÊéíÂêç</th><th>ÂïÜÂìÅ</th><th>Áõ∏‰ººÂ∫¶</th><th>ËØ¥Êòé</th></tr>
                            <tr><td>1</td><td>ÁæéÂºèÂíñÂï°</td><td>0.892</td><td class="match">‚úì ÁªèÂÖ∏ÂíñÂï°ÔºåÈ´òÂ∫¶ÂåπÈÖç</td></tr>
                            <tr><td>2</td><td>ÂÜ∑ËêÉÂíñÂï°</td><td>0.867</td><td class="match">‚úì ÊµìÈÉÅÂè£ÊÑü</td></tr>
                            <tr><td>3</td><td>ÊãøÈìÅ</td><td>0.834</td><td class="match">‚úì ÂíñÂï°Âü∫Â∫ï</td></tr>
                            <tr><td>...</td><td>...</td><td>...</td><td>...</td></tr>
                            <tr><td>18</td><td>ËçâËéìÊòüÂÜ∞‰πê</td><td>0.423</td><td class="weak">‚ñ≥ Áõ∏ÂÖ≥Â∫¶ËæÉ‰Ωé</td></tr>
                        </table>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° ‰∏∫‰ªÄ‰πàÁî®ËØ≠‰πâÂè¨Âõû?</h3>
                        <ul>
                            <li><strong>ÁêÜËß£ËØ≠‰πâ</strong>Ôºö"ÊèêÁ•ûÈÜíËÑë" ËÉΩÂåπÈÖç "ÂíñÂï°Âõ†Âê´ÈáèÈ´ò"</li>
                            <li><strong>Ë∑®ËØ≠Ë®Ä</strong>Ôºö‰∏≠Ëã±ÊñáÊèèËø∞ÈÉΩËÉΩÊ≠£Á°ÆÂåπÈÖç</li>
                            <li><strong>Ê≥õÂåñËÉΩÂäõ</strong>ÔºöÂç≥‰ΩøÁî®Êà∑ËæìÂÖ•ËÆ≠ÁªÉÈõÜ‰∏≠Ê≤°ÊúâÁöÑË°®Ëø∞‰πüËÉΩÁêÜËß£</li>
                        </ul>
                    </div>
                `
            },
            4: {
                title: "‚öñÔ∏è Step 4: Â§öÂõ†Á¥†ÈáçÊéíÂ∫è (Re-ranking)",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>Âú®ËØ≠‰πâÂè¨ÂõûÁöÑÂü∫Á°Ä‰∏äÔºåËûçÂêà‰∏öÂä°ËßÑÂàô„ÄÅÁî®Êà∑Ë°å‰∏∫„ÄÅ‰∏ä‰∏ãÊñáÁ≠âÂ§öÁª¥Âõ†Á¥†ËøõË°åÁ≤æÊéí„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>üìä ÊúÄÁªàÂæóÂàÜÂÖ¨Âºè</h3>
                        <div class="formula-card large">
                            <div class="formula">
                                Final_Score = Embedding_Sim √ó Rule √ó Behavior √ó Session √ó Context
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üîß ÂêÑÂõ†Â≠êËØ¶Ëß£</h3>

                        <div class="factor-detail">
                            <div class="factor-header">
                                <span class="factor-icon">üìê</span>
                                <span class="factor-name">EmbeddingÁõ∏‰ººÂ∫¶ (Âü∫Á°ÄÂàÜ)</span>
                            </div>
                            <div class="factor-body">
                                <p>Êù•Ëá™Step 3ÁöÑ‰ΩôÂº¶Áõ∏‰ººÂ∫¶ÔºåËåÉÂõ¥[0,1]</p>
                                <div class="example">‰æãÔºöÁæéÂºèÂíñÂï° = 0.892</div>
                            </div>
                        </div>

                        <div class="factor-detail">
                            <div class="factor-header">
                                <span class="factor-icon">üìã</span>
                                <span class="factor-name">ËßÑÂàô‰πòÊï∞ (Rule Multiplier)</span>
                            </div>
                            <div class="factor-body">
                                <p>Âü∫‰∫é‰∏öÂä°ËßÑÂàôÁöÑÂä†ÊùÉÔºö</p>
                                <ul>
                                    <li>üÜï Êñ∞ÂìÅ/Â≠£ËäÇÈôêÂÆöÔºö√ó1.2</li>
                                    <li>‚≠ê Ê†áÁ≠æÂåπÈÖçÂ∫¶Ôºö√ó1.0~1.3</li>
                                    <li>üì¶ Â∫ìÂ≠òÁ¥ßÂº†Ôºö√ó0.8</li>
                                </ul>
                            </div>
                        </div>

                        <div class="factor-detail">
                            <div class="factor-header">
                                <span class="factor-icon">üìà</span>
                                <span class="factor-name">Ë°å‰∏∫‰πòÊï∞ (Behavior Multiplier)</span>
                            </div>
                            <div class="factor-body">
                                <p>Âü∫‰∫éÁî®Êà∑ÂéÜÂè≤ËÆ¢ÂçïÁöÑÂÅèÂ•ΩÂä†ÊùÉÔºö</p>
                                <div class="code-block" style="font-size: 11px;">
# Êó∂Èó¥Ë°∞ÂáèÂÖ¨Âºè (ÂçäË°∞Êúü30Â§©)
decay = 0.5 ^ (days_ago / 30)
boost = 1 + Œ£(order_weight √ó decay)

# Á§∫‰æãÔºö7Â§©Ââç‰π∞ËøáÁæéÂºè
decay = 0.5^(7/30) = 0.85
boost = 1 + 0.1√ó0.85 = 1.085
                                </div>
                            </div>
                        </div>

                        <div class="factor-detail">
                            <div class="factor-header">
                                <span class="factor-icon">üéØ</span>
                                <span class="factor-name">‰ºöËØù‰πòÊï∞ (Session Multiplier)</span>
                            </div>
                            <div class="factor-body">
                                <p>Âü∫‰∫éÂΩìÂâçSessionÁöÑÂÆûÊó∂‰∫§‰∫íÔºö</p>
                                <ul>
                                    <li>üëç ÁÇπËµûÂïÜÂìÅÊ†áÁ≠æÔºö+5%</li>
                                    <li>üëé ÁÇπË∏©ÂïÜÂìÅÊ†áÁ≠æÔºö-5%</li>
                                    <li>üõí Âä†Ë¥≠ÂïÜÂìÅÊ†áÁ≠æÔºö+8%</li>
                                </ul>
                            </div>
                        </div>

                        <div class="factor-detail">
                            <div class="factor-header">
                                <span class="factor-icon">üåç</span>
                                <span class="factor-name">‰∏ä‰∏ãÊñá‰πòÊï∞ (Context Multiplier) - MOP</span>
                            </div>
                            <div class="factor-body">
                                <p>Âü∫‰∫éMOPÂú∫ÊôØÁöÑÂÆûÊó∂‰∏ä‰∏ãÊñáÔºö</p>
                                <table class="mini-table">
                                    <tr><td>‚è∞ Êó∂ÊÆµ</td><td>Êó©Êô®ÂíñÂï°+15%</td></tr>
                                    <tr><td>üå°Ô∏è Â§©Ê∞î</td><td>È´òÊ∏©ÂÜ∞È•Æ+20%</td></tr>
                                    <tr><td>üìç Èó®Â∫ó</td><td>ÁÉ≠ÈîÄÂïÜÂìÅ+10%</td></tr>
                                    <tr><td>üéØ Âú∫ÊôØ</td><td>‰∏äÁè≠ÊóèÊèêÁ•û+15%</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üìã ÈáçÊéíÁªìÊûúÁ§∫‰æã</h3>
                        <div class="rerank-example">
                            <div class="rerank-item">
                                <span class="rank">1‚Üí1</span>
                                <span class="name">ÁæéÂºèÂíñÂï°</span>
                                <span class="calc">0.892 √ó 1.2 √ó 1.08 √ó 1.0 √ó 1.15 = <strong>1.33</strong></span>
                            </div>
                            <div class="rerank-item boosted">
                                <span class="rank">5‚Üí2</span>
                                <span class="name">ÂÜ∑ËêÉÂíñÂï°</span>
                                <span class="calc">0.823 √ó 1.3 √ó 1.15 √ó 1.05 √ó 1.20 = <strong>1.55</strong> ‚Üë</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° A/BÂÆûÈ™å</h3>
                        <p>ÂêÑÂõ†Â≠êÁöÑÊùÉÈáçÈÄöËøáA/BÊµãËØïÊåÅÁª≠‰ºòÂåñÔºö</p>
                        <ul>
                            <li><strong>context_weight</strong>Ôºö‰Ωé/‰∏≠/È´òÊùÉÈáçÂØπÊØî</li>
                            <li><strong>weather_adaptation</strong>ÔºöÂ§©Ê∞îÈÄÇÈÖçÁ≠ñÁï•ÂØπÊØî</li>
                        </ul>
                    </div>
                `
            },
            5: {
                title: "üìä Step 2.1: ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÂàÜÊûê",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>Âü∫‰∫éÁî®Êà∑ÂéÜÂè≤ËÆ¢ÂçïÔºåÊûÑÂª∫‰∏™‰∫∫ÂÆ¢Âà∂ÂåñÂÅèÂ•ΩÊ®°ÂûãÔºå‰∏∫ÂêéÁª≠Â±ûÊÄßÊé®ËçêÊèê‰æõÊï∞ÊçÆÊîØÊíë„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>üìã ËæìÂÖ•Êï∞ÊçÆ</h3>
                        <div class="code-block">
{
  "user_id": "user_abc123",
  "order_history": [
    {
      "item": "ÊãøÈìÅ",
      "temperature": "iced",
      "size": "grande",
      "milk": "oat_milk",
      "sugar": "less_sweet",
      "espresso_shots": 2,
      "timestamp": "2024-01-15T09:30:00"
    },
    // ... Êõ¥Â§öÂéÜÂè≤ËÆ¢Âçï
  ],
  "preset_preferences": {
    "default_temperature": "iced",
    "default_milk": "oat_milk"
  }
}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>‚öôÔ∏è ÂÅèÂ•ΩÂàÜÊûêÊµÅÁ®ã</h3>
                        <div class="flow-diagram">
                            <div class="flow-step">
                                <div class="flow-num">1</div>
                                <div class="flow-content">
                                    <strong>ÂéÜÂè≤ËÆ¢ÂçïËÅöÂêà</strong>
                                    <p>ÁªüËÆ°ÂêÑÂÆ¢Âà∂ÂåñÂ±ûÊÄßÁöÑ‰ΩøÁî®È¢ëÁéáÔºö</p>
                                    <ul>
                                        <li>Ê∏©Â∫¶ÔºöÂÜ∞ 72% / ÁÉ≠ 28%</li>
                                        <li>Â•∂Á±ªÔºöÁáïÈ∫¶Â•∂ 60% / ÂÖ®ËÑÇ 25% / ËÑ±ËÑÇ 15%</li>
                                        <li>Á≥ñÂ∫¶ÔºöÂ∞ëÁ≥ñ 55% / Ê†áÂáÜ 30% / Êó†Á≥ñ 15%</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="flow-step">
                                <div class="flow-num">2</div>
                                <div class="flow-content">
                                    <strong>Êó∂Èó¥Ë°∞ÂáèÂä†ÊùÉ</strong>
                                    <p>ËøëÊúüËÆ¢ÂçïÊùÉÈáçÊõ¥È´ò (30Â§©ÂçäË°∞Êúü)</p>
                                    <div class="code-block" style="font-size: 11px;">
weight = exp(-days_ago / 30)
# 1Â§©Ââç: 0.97, 30Â§©Ââç: 0.37, 90Â§©Ââç: 0.05
                                    </div>
                                </div>
                            </div>
                            <div class="flow-step">
                                <div class="flow-num">3</div>
                                <div class="flow-content">
                                    <strong>ÂÅèÂ•ΩÁΩÆ‰ø°Â∫¶ËØÑ‰º∞</strong>
                                    <p>Ê†πÊçÆÊ†∑Êú¨ÈáèËØÑ‰º∞ÂÅèÂ•ΩÂèØ‰ø°Â∫¶</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üì§ ËæìÂá∫ÔºöÁî®Êà∑ÂÅèÂ•ΩÊ®°Âûã</h3>
                        <div class="code-block">
{
  "preferences": {
    "temperature": {"value": "iced", "confidence": 0.85},
    "milk": {"value": "oat_milk", "confidence": 0.72},
    "sugar": {"value": "less_sweet", "confidence": 0.68},
    "espresso": {"value": "double", "confidence": 0.55}
  },
  "keywords": ["Ê∏ÖÁàΩ", "‰ΩéÁ≥ñ", "ÁáïÈ∫¶"],
  "sample_size": 23
}
                        </div>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° ËÆæËÆ°Ë¶ÅÁÇπ</h3>
                        <ul>
                            <li><strong>ÂÜ∑ÂêØÂä®Â§ÑÁêÜ</strong>ÔºöÊñ∞Áî®Êà∑ÈááÁî®ÁîªÂÉèÈªòËÆ§ÂÄºÊàñÁÉ≠Èó®ÈÖçÁΩÆ</li>
                            <li><strong>‰∏ä‰∏ãÊñáËûçÂêà</strong>ÔºöÂ§èÂ≠£Ëá™Âä®ÊèêÂçáÂÜ∞È•ÆÂÅèÂ•ΩÊùÉÈáç</li>
                            <li><strong>ÁΩÆ‰ø°Â∫¶ÈòàÂÄº</strong>Ôºö‰ΩéÁΩÆ‰ø°Â∫¶ÂÅèÂ•Ω‰∏çÂº∫Êé®ÔºåÁªôÁî®Êà∑ÈÄâÊã©Á©∫Èó¥</li>
                        </ul>
                    </div>
                `
            },
            6: {
                title: "üéØ Step 2.2: ÂÆ¢Âà∂ÂåñÂ±ûÊÄßÊé®Ëçê",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>‰∏∫ÊØè‰∏™Êé®ËçêÂïÜÂìÅÁîüÊàêÊúÄÈÄÇÂêàÁî®Êà∑ÁöÑÂÆ¢Âà∂ÂåñÈÖçÁΩÆÂª∫ËÆÆ„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>üìã ËæìÂÖ•Êï∞ÊçÆ</h3>
                        <div class="code-block">
{
  "recommended_item": {
    "sku": "COF001",
    "name": "ÊãøÈìÅ",
    "available_options": {
      "temperature": ["hot", "iced"],
      "size": ["tall", "grande", "venti"],
      "milk": ["whole", "skim", "oat_milk", "almond"],
      "sugar": ["standard", "less_sweet", "no_sugar"],
      "espresso": [1, 2, 3]
    }
  },
  "user_preferences": { /* Êù•Ëá™Step 2.1 */ },
  "context": {
    "weather": {"temp": 32, "condition": "hot"},
    "time_of_day": "afternoon"
  }
}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>‚öôÔ∏è Êé®ËçêÁÆóÊ≥ï</h3>
                        <div class="algorithm-card">
                            <div class="algo-title">Â§öÂõ†Á¥†ËûçÂêàÊé®Ëçê</div>
                            <div class="algo-formula">
                                <strong>Â±ûÊÄßÂæóÂàÜ</strong> = Áî®Êà∑ÂÅèÂ•Ω √ó 0.5 + ‰∏ä‰∏ãÊñáÈÄÇÈÖç √ó 0.3 + ÂïÜÂìÅÈÄÇÈÖç √ó 0.2
                            </div>
                            <div class="algo-examples">
                                <div class="example-item">
                                    <span class="attr">üßä Ê∏©Â∫¶Êé®ËçêÔºöÂÜ∞</span>
                                    <span class="calc">= ÂÅèÂ•Ω(ÂÜ∞:0.85) √ó 0.5 + È´òÊ∏©Â§©Ê∞î(0.9) √ó 0.3 + ÂïÜÂìÅÊîØÊåÅ(1.0) √ó 0.2</span>
                                    <span class="score">= 0.90</span>
                                </div>
                                <div class="example-item">
                                    <span class="attr">ü•õ Â•∂Á±ªÊé®ËçêÔºöÁáïÈ∫¶Â•∂</span>
                                    <span class="calc">= ÂÅèÂ•Ω(ÁáïÈ∫¶:0.72) √ó 0.5 + ÂÅ•Â∫∑Ë∂ãÂäø(0.6) √ó 0.3 + ÂïÜÂìÅÈÄÇÈÖç(0.8) √ó 0.2</span>
                                    <span class="score">= 0.70</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üè™ Èó®Â∫óÂ∫ìÂ≠òÁ∫¶Êùü</h3>
                        <p>Êé®ËçêÈÖçÁΩÆÈúÄËÄÉËôëÈó®Â∫óÂÆûÈôÖÂ∫ìÂ≠òÁä∂ÊÄÅÔºö</p>
                        <div class="inventory-check">
                            <div class="inv-item available">
                                <span class="icon">‚úì</span>
                                <span class="name">ÁáïÈ∫¶Â•∂</span>
                                <span class="status">Â∫ìÂ≠òÂÖÖË∂≥</span>
                            </div>
                            <div class="inv-item low">
                                <span class="icon">‚ö†Ô∏è</span>
                                <span class="name">Êùè‰ªÅÂ•∂</span>
                                <span class="status">Â∫ìÂ≠òÁ¥ßÂº†</span>
                            </div>
                            <div class="inv-item out">
                                <span class="icon">‚úó</span>
                                <span class="name">Ê§∞Â•∂</span>
                                <span class="status">ÊöÇÊó∂Áº∫Ë¥ß ‚Üí Êé®ËçêÊõø‰ª£</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üì§ ËæìÂá∫ÔºöÊé®ËçêÈÖçÁΩÆ</h3>
                        <div class="code-block">
{
  "recommended_config": {
    "temperature": "iced",
    "size": "grande",
    "milk": "oat_milk",
    "sugar": "less_sweet",
    "espresso_shots": 2
  },
  "config_reasons": {
    "temperature": "ÊÇ®ÂÅèÂ•ΩÂÜ∞È•ÆÔºå‰∏î‰ªäÂ§©Â§©Ê∞îÁÇéÁÉ≠",
    "milk": "Ê†πÊçÆÊÇ®ÁöÑÁáïÈ∫¶Â•∂ÂÅèÂ•Ω",
    "sugar": "‰øùÊåÅÊÇ®‰∏ÄË¥ØÁöÑÂ∞ëÁ≥ñÈÄâÊã©"
  },
  "alternatives": {
    "milk": ["almond", "skim"]  // Â§áÈÄâÊñπÊ°à
  }
}
                        </div>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° Áî®Êà∑‰ΩìÈ™åËÆæËÆ°</h3>
                        <ul>
                            <li><strong>‰∏ÄÈîÆ‰∏ãÂçï</strong>ÔºöÊé®ËçêÈÖçÁΩÆÂèØÁõ¥Êé•Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</li>
                            <li><strong>ÂèØ‰øÆÊîπ</strong>ÔºöÁî®Êà∑ÂèØË∞ÉÊï¥‰ªªÊÑèÂ±ûÊÄß</li>
                            <li><strong>ËÆ∞ÂøÜÂèçÈ¶à</strong>ÔºöÁî®Êà∑‰øÆÊîπÂêéÊõ¥Êñ∞ÂÅèÂ•ΩÊ®°Âûã</li>
                        </ul>
                    </div>
                `
            },
            7: {
                title: "üí¨ Step 2.3: ‰∏™ÊÄßÂåñÁêÜÁî±ÁîüÊàê",
                content: `
                    <div class="detail-section">
                        <h3>üéØ Ê†∏ÂøÉÁõÆÊ†á</h3>
                        <p>‰∏∫Êé®ËçêÁöÑÂïÜÂìÅ+ÂÆ¢Âà∂ÂåñÈÖçÁΩÆÁªÑÂêàÁîüÊàê‰∏™ÊÄßÂåñÊé®ËçêÁêÜÁî±ÔºåÊèêÂçáÁî®Êà∑‰ø°‰ªªÂ∫¶ÂíåËΩ¨ÂåñÁéá„ÄÇ</p>
                    </div>

                    <div class="detail-section">
                        <h3>ü§ñ LLMÁîüÊàêÊµÅÁ®ã</h3>
                        <div class="llm-flow">
                            <div class="llm-step">
                                <div class="step-label">ËæìÂÖ•</div>
                                <div class="code-block" style="font-size: 11px;">
{
  "user_type": "ÂíñÂï°ÈáçÂ∫¶Áî®Êà∑",
  "item_name": "ÂÜ∑ËêÉÂíñÂï°",
  "customization": {
    "temperature": "iced",
    "milk": "oat_milk",
    "sugar": "less_sweet"
  },
  "match_factors": {
    "semantic": 0.87,
    "behavior": 0.75,
    "context": "È´òÊ∏©Â§©Ê∞î+‰∏ãÂçàÊó∂ÊÆµ"
  }
}
                                </div>
                            </div>
                            <div class="llm-arrow">‚Üì GPT-4o-mini</div>
                            <div class="llm-step">
                                <div class="step-label">PromptÊ®°Êùø</div>
                                <div class="code-block" style="font-size: 11px;">
‰Ω†ÊòØÊòüÂ∑¥ÂÖãÁöÑÊé®ËçêÂä©Êâã„ÄÇ
ËØ∑Ê†πÊçÆ‰ª•‰∏ã‰ø°ÊÅØÁîüÊàêÁÆÄÁü≠ÁöÑÊé®ËçêÁêÜÁî±(30Â≠óÂÜÖ)Ôºö
- Áî®Êà∑Á±ªÂûãÔºö{user_type}
- Êé®ËçêÂïÜÂìÅÔºö{item_name}
- ÂÆ¢Âà∂ÂåñÈÖçÁΩÆÔºö{customization}
- Êé®ËçêÂéüÂõ†Ôºö{match_factors}
Ë¶ÅÊ±ÇÔºö‰∫≤Âàá„ÄÅ‰∏™ÊÄßÂåñ„ÄÅÁ™ÅÂá∫ÂïÜÂìÅ+ÈÖçÁΩÆÁöÑÁâπÁÇπ
                                </div>
                            </div>
                            <div class="llm-arrow">‚Üì</div>
                            <div class="llm-step">
                                <div class="step-label">ËæìÂá∫</div>
                                <div class="reason-output">
                                    "‚òÄÔ∏è ÁÇéÁÉ≠ÂçàÂêéÔºå‰∏∫ÊÇ®ÂáÜÂ§áÂÜ∞ÁàΩÂÜ∑ËêÉÈÖçÁáïÈ∫¶Â•∂ÔºåÂ∞ëÁ≥ñÊõ¥ÂÅ•Â∫∑ÔºåÊ≠£ÊòØÊÇ®ÂñúÊ¨¢ÁöÑÂè£Âë≥ÔºÅ"
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üìä ÂèØËß£ÈáäÊÄßÂõ†Â≠êÂàÜËß£</h3>
                        <p>Èô§‰∫ÜLLMÁîüÊàêÁöÑÊñáÊ°àÔºåËøòÊèê‰æõÁªìÊûÑÂåñÁöÑËß£ÈáäÊï∞ÊçÆÔºö</p>
                        <div class="explainability-card">
                            <div class="explain-item">
                                <div class="explain-label">ËØ≠‰πâÂåπÈÖç</div>
                                <div class="explain-bar"><div class="bar-fill" style="width: 87%"></div></div>
                                <div class="explain-value">87%</div>
                            </div>
                            <div class="explain-item">
                                <div class="explain-label">Ë°å‰∏∫ÂÅèÂ•Ω</div>
                                <div class="explain-bar"><div class="bar-fill" style="width: 75%"></div></div>
                                <div class="explain-value">75%</div>
                            </div>
                            <div class="explain-item">
                                <div class="explain-label">ÂÆ¢Âà∂ÂåñÂåπÈÖç</div>
                                <div class="explain-bar"><div class="bar-fill" style="width: 90%"></div></div>
                                <div class="explain-value">90%</div>
                            </div>
                            <div class="explain-item">
                                <div class="explain-label">‰∏ä‰∏ãÊñáÈÄÇÈÖç</div>
                                <div class="explain-bar"><div class="bar-fill" style="width: 80%"></div></div>
                                <div class="explain-value">80%</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>üé® ÁêÜÁî±È£éÊ†ºA/BÊµãËØï</h3>
                        <table class="style-table">
                            <tr>
                                <th>È£éÊ†º</th>
                                <th>Á§∫‰æã</th>
                                <th>ÈÄÇÁî®Âú∫ÊôØ</th>
                            </tr>
                            <tr>
                                <td>ÁÆÄÊ¥ÅÂûã</td>
                                <td>"Ê†πÊçÆÊÇ®ÁöÑÂè£Âë≥ÂÅèÂ•ΩÊé®Ëçê"</td>
                                <td>ÊïàÁéá‰ºòÂÖàÁî®Êà∑</td>
                            </tr>
                            <tr>
                                <td>ÊÉÖÊÑüÂûã</td>
                                <td>"ËøôÊùØÂíñÂï°ÁöÑÈ¶ôÊ∞îÔºåÈÖç‰∏äÊÇ®ÂñúÊ¨¢ÁöÑÁáïÈ∫¶Â•∂~"</td>
                                <td>ÊÉÖÊÑüÂÖ±È∏£Áî®Êà∑</td>
                            </tr>
                            <tr>
                                <td>Êï∞ÊçÆÂûã</td>
                                <td>"Âü∫‰∫é23Ê¨°ÂéÜÂè≤ËÆ¢ÂçïÁöÑ‰∏™ÊÄßÂåñÈÖçÁΩÆ"</td>
                                <td>ÁêÜÊÄßÂÜ≥Á≠ñÁî®Êà∑</td>
                            </tr>
                        </table>
                    </div>

                    <div class="detail-section highlight">
                        <h3>üí° Â∑•Á®ã‰ºòÂåñ</h3>
                        <ul>
                            <li><strong>ÊâπÈáèÁîüÊàê</strong>Ôºö‰∏ÄÊ¨°APIË∞ÉÁî®ÁîüÊàêÂ§ö‰∏™ÂïÜÂìÅÁöÑÁêÜÁî±</li>
                            <li><strong>ÁºìÂ≠òÁ≠ñÁï•</strong>ÔºöÁõ∏ÂêåPersona+ÂïÜÂìÅ+ÈÖçÁΩÆÁªÑÂêàÁºìÂ≠òÁêÜÁî±</li>
                            <li><strong>ÈôçÁ∫ßÊñπÊ°à</strong>ÔºöLLMË∂ÖÊó∂Êó∂‰ΩøÁî®Ê®°ÊùøÁîüÊàê</li>
                        </ul>
                    </div>
                `
            }
        };

        function showAlgorithmDetail(stepNum) {
            currentDetailStep = stepNum;
            const modal = document.getElementById('algorithmModal');
            const title = document.getElementById('algorithmModalTitle');
            const body = document.getElementById('algorithmModalBody');

            const detail = algorithmDetails[stepNum];
            if (detail) {
                title.textContent = detail.title;
                body.innerHTML = detail.content;
            }

            updateStepNavigation();
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeAlgorithmModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('algorithmModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function navigateStep(delta) {
            const newStep = currentDetailStep + delta;
            if (newStep >= 1 && newStep <= 7) {
                showAlgorithmDetail(newStep);
            }
        }

        function updateStepNavigation() {
            document.getElementById('stepIndicator').textContent = `${currentDetailStep} / 7`;
            document.getElementById('btnPrevStep').disabled = currentDetailStep <= 1;
            document.getElementById('btnNextStep').disabled = currentDetailStep >= 7;
        }

        // ESCÈîÆÂÖ≥Èó≠ÂºπÁ™ó
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAlgorithmModal();
            if (e.key === 'ArrowLeft') navigateStep(-1);
            if (e.key === 'ArrowRight') navigateStep(1);
        });
    </script>
</body>
</html>
