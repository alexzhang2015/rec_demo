<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ¨èV2 - A/Bæµ‹è¯• & ä¸ªæ€§åŒ–</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        :root {
            --starbucks-green: #00704a;
            --starbucks-light-green: #1e3932;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            margin: 0;
        }

        .demo-header {
            background: linear-gradient(135deg, var(--starbucks-green) 0%, var(--starbucks-light-green) 100%);
            color: white;
            padding: 30px 24px;
            text-align: center;
        }

        .demo-header h1 { font-size: 28px; margin-bottom: 8px; }
        .demo-header p { opacity: 0.9; font-size: 14px; }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        .demo-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .demo-container { grid-template-columns: 1fr; }
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--starbucks-green);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #666; margin-bottom: 6px; }

        .persona-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .persona-card {
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 13px;
        }

        .persona-card:hover { border-color: var(--starbucks-green); }
        .persona-card.selected { border-color: var(--starbucks-green); background: rgba(0,112,74,0.1); }
        .persona-card .emoji { font-size: 24px; display: block; margin-bottom: 4px; }

        .toggle-group { display: flex; flex-direction: column; gap: 10px; }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f8f8f8;
            border-radius: 8px;
        }

        .toggle-item label { font-size: 13px; color: #333; }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider { background: var(--starbucks-green); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }

        .btn-recommend {
            width: 100%;
            padding: 14px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-recommend:hover { background: var(--starbucks-light-green); }
        .btn-recommend:disabled { background: #ccc; cursor: not-allowed; }

        /* ä¸»å†…å®¹åŒº */
        .main-content { min-height: 600px; }

        .experiment-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .experiment-banner .title { font-weight: 600; margin-bottom: 6px; }
        .experiment-banner .variants { display: flex; gap: 12px; flex-wrap: wrap; }
        .experiment-banner .variant-tag {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .rec-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            position: relative;
            transition: all 0.2s;
        }

        .rec-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }

        .rec-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .rec-card-title { font-size: 16px; font-weight: 600; color: #333; }
        .rec-card-category { font-size: 12px; color: #888; margin-top: 2px; }

        .match-score {
            font-size: 20px;
            font-weight: 700;
            color: var(--starbucks-green);
        }

        .score-breakdown {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 12px;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        .score-row:last-child { border-bottom: none; }
        .score-row .label { color: #666; }
        .score-row .value { font-weight: 600; color: #333; }
        .score-row .value.boost { color: #22c55e; }
        .score-row .value.penalty { color: #ef4444; }

        .rec-reason {
            font-size: 13px;
            color: #555;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,112,74,0.05);
            border-radius: 8px;
            border-left: 3px solid var(--starbucks-green);
        }

        .matched-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .keyword-tag {
            padding: 3px 8px;
            background: rgba(0,112,74,0.1);
            color: var(--starbucks-green);
            border-radius: 12px;
            font-size: 11px;
        }

        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .feedback-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .feedback-btn:hover { background: #f5f5f5; }
        .feedback-btn.like:hover { background: #dcfce7; border-color: #22c55e; }
        .feedback-btn.dislike:hover { background: #fee2e2; border-color: #ef4444; }
        .feedback-btn.clicked { background: #dcfce7; border-color: #22c55e; }

        /* å³ä¾§é¢æ¿ */
        .side-panel { position: sticky; top: 20px; height: fit-content; }

        .session-info {
            padding: 12px;
            background: #f0f9ff;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .session-info .title { font-weight: 600; color: #0369a1; margin-bottom: 6px; }

        .realtime-prefs {
            margin-top: 16px;
        }

        .pref-section { margin-bottom: 12px; }
        .pref-section .label { font-size: 12px; color: #888; margin-bottom: 6px; }

        .pref-tags { display: flex; flex-wrap: wrap; gap: 4px; }

        .pref-tag {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .pref-tag.liked { background: #dcfce7; color: #166534; }
        .pref-tag.disliked { background: #fee2e2; color: #991b1b; }

        .explanation-panel {
            margin-top: 16px;
            padding: 12px;
            background: #fefce8;
            border-radius: 8px;
            font-size: 12px;
        }

        .explanation-panel .title { font-weight: 600; color: #854d0e; margin-bottom: 8px; }

        .factor-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .factor-item:last-child { border-bottom: none; }

        .factor-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .factor-bar-fill {
            height: 100%;
            background: var(--starbucks-green);
            border-radius: 3px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #888;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #eee;
            border-top-color: var(--starbucks-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .stats-card {
            background: #f8f8f8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }

        .stats-row .label { color: #666; }
        .stats-row .value { font-weight: 600; }

        /* è®¢å•å¯¹æ¯”æ¼”ç¤ºæ ·å¼ */
        .comparison-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .comparison-title {
            font-size: 18px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn-simulate {
            padding: 10px 20px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-simulate:hover { background: #d97706; }
        .btn-simulate:disabled { background: #ccc; cursor: not-allowed; }

        .btn-compare {
            padding: 10px 20px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-compare:hover { background: var(--starbucks-light-green); }
        .btn-compare:disabled { background: #ccc; cursor: not-allowed; }

        .order-status {
            padding: 8px 16px;
            background: rgba(255,255,255,0.8);
            border-radius: 8px;
            font-size: 13px;
            color: #666;
        }

        .order-status.has-orders {
            background: #dcfce7;
            color: #166534;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .comparison-grid { grid-template-columns: 1fr; }
        }

        .comparison-column {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .comparison-column-title {
            font-size: 15px;
            font-weight: 600;
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-column-title.old-user {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
        }

        .comparison-column-title.new-user {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
        }

        .comparison-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }

        .comparison-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comparison-item-name {
            font-weight: 600;
            font-size: 14px;
        }

        .comparison-item-score {
            font-size: 18px;
            font-weight: 700;
        }

        .comparison-item-score.boosted {
            color: #22c55e;
        }

        .comparison-item-score.normal {
            color: #6366f1;
        }

        .boost-detail {
            background: #f0fdf4;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 11px;
            margin-top: 8px;
        }

        .boost-detail .factor {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .boost-detail .factor .label { color: #666; }
        .boost-detail .factor .value { font-weight: 600; color: #166534; }

        .boost-explanation {
            font-size: 12px;
            color: #15803d;
            margin-top: 6px;
            font-style: italic;
        }

        .comparison-summary {
            background: rgba(255,255,255,0.9);
            padding: 16px;
            border-radius: 10px;
            margin-top: 16px;
            text-align: center;
        }

        .comparison-summary h4 {
            margin: 0 0 10px 0;
            color: #92400e;
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .number {
            font-size: 24px;
            font-weight: 700;
            color: var(--starbucks-green);
        }

        .summary-stat .label {
            font-size: 12px;
            color: #666;
        }

        /* å®¢åˆ¶åŒ–ç›¸å…³æ ·å¼ */
        .customization-section {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 10px;
            font-size: 12px;
        }

        .customization-section .title {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .customization-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            color: #0c4a6e;
        }

        .customization-item .label { color: #64748b; }
        .customization-item .value { font-weight: 500; }

        .customization-reason {
            font-size: 11px;
            color: #0369a1;
            margin-top: 6px;
            font-style: italic;
            padding-top: 6px;
            border-top: 1px dashed rgba(3,105,161,0.3);
        }

        .customization-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .customization-keyword {
            padding: 3px 8px;
            background: rgba(3,105,161,0.15);
            color: #0369a1;
            border-radius: 12px;
            font-size: 10px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .confidence-high { background: #dcfce7; color: #166534; }
        .confidence-medium { background: #fef3c7; color: #92400e; }
        .confidence-low { background: #fee2e2; color: #991b1b; }

        /* å®¢åˆ¶åŒ–é€‰é¡¹å¯è§†åŒ–æ ·å¼ */
        .cust-options-panel {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #e2e8f0;
        }

        .cust-options-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .cust-options-panel .panel-title {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cust-options-panel .toggle-icon {
            font-size: 10px;
            color: #94a3b8;
            transition: transform 0.2s;
        }

        .cust-options-panel.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .cust-options-content {
            display: none;
        }

        .cust-options-panel.expanded .cust-options-content {
            display: block;
        }

        .cust-option-group {
            margin-bottom: 10px;
        }

        .cust-option-group:last-child {
            margin-bottom: 0;
        }

        .cust-option-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cust-option-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .cust-chip {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            background: #e2e8f0;
            color: #64748b;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .cust-chip.highlighted {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
        }

        .cust-chip.matched {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .cust-chip.persona-match {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .cust-chip.default {
            border: 2px solid #94a3b8;
            background: white;
        }

        .cust-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed #e2e8f0;
        }

        .cust-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: #64748b;
        }

        .cust-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .cust-legend-dot.recommended { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .cust-legend-dot.persona { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .cust-legend-dot.default { background: white; border: 2px solid #94a3b8; }

        .member-price-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        /* é¢„è®¾ç®¡ç†æ ·å¼ */
        .preset-section {
            background: linear-gradient(135deg, #fae8ff 0%, #e9d5ff 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .preset-title {
            font-size: 16px;
            font-weight: 700;
            color: #7e22ce;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preset-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .btn-preset {
            padding: 8px 16px;
            background: #9333ea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-preset:hover { background: #7e22ce; }
        .btn-preset:disabled { background: #ccc; cursor: not-allowed; }

        .preset-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preset-card {
            background: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .preset-card .name { font-weight: 600; color: #7e22ce; margin-bottom: 4px; }
        .preset-card .options { color: #666; font-size: 11px; }

        /* å®¢åˆ¶åŒ–åå¥½é¢æ¿æ ·å¼ */
        .cust-prefs-panel {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            border-radius: 8px;
        }

        .cust-prefs-panel .title {
            font-weight: 600;
            color: #0d9488;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .cust-pref-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 11px;
        }

        .cust-pref-item .label { color: #5eead4; font-weight: 500; }
        .cust-pref-item .value { color: #0d9488; font-weight: 600; }

        /* è‡ªå®šä¹‰åå¥½è¾“å…¥ */
        .custom-preference-section {
            margin-top: 16px;
            padding: 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
        }

        .custom-preference-section .title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .custom-input-group {
            display: flex;
            gap: 8px;
        }

        .custom-input-group input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #d97706;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }

        .custom-input-group input:focus {
            border-color: #92400e;
            box-shadow: 0 0 0 2px rgba(217,119,6,0.2);
        }

        .btn-custom-search {
            padding: 10px 16px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-custom-search:hover { background: #d97706; }

        .hint-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .hint-tag {
            padding: 4px 10px;
            background: rgba(255,255,255,0.7);
            border: 1px solid #d97706;
            border-radius: 12px;
            font-size: 11px;
            color: #92400e;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hint-tag:hover {
            background: #f59e0b;
            color: white;
        }

        /* è´­ç‰©è½¦æ ·å¼ */
        .cart-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cart-title {
            font-weight: 600;
            color: var(--starbucks-green);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cart-badge {
            background: var(--starbucks-green);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .btn-clear-cart {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid #dc2626;
            color: #dc2626;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn-clear-cart:hover {
            background: #dc2626;
            color: white;
        }

        .cart-items {
            max-height: 300px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .cart-item-customization {
            font-size: 10px;
            color: #666;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cart-item-qty button {
            width: 22px;
            height: 22px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .cart-item-qty button:hover {
            background: #f5f5f5;
        }

        .cart-item-qty span {
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }

        .cart-item-price {
            font-weight: 600;
            color: var(--starbucks-green);
        }

        .cart-item-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: #fee2e2;
            color: #dc2626;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .cart-item-remove:hover {
            background: #dc2626;
            color: white;
        }

        .cart-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,112,74,0.2);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .cart-total-label {
            color: #666;
        }

        .cart-total-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--starbucks-green);
        }

        .btn-checkout {
            width: 100%;
            padding: 12px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-checkout:hover { background: var(--starbucks-light-green); }
        .btn-checkout:disabled { background: #ccc; cursor: not-allowed; }

        .cart-empty {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 13px;
        }

        /* æ·»åŠ åˆ°è´­ç‰©è½¦æŒ‰é’® */
        .btn-add-cart {
            flex: 1;
            padding: 8px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
        }

        .btn-add-cart:hover {
            background: var(--starbucks-light-green);
        }

        .btn-add-cart.added {
            background: #22c55e;
        }

        /* è®¢å•æˆåŠŸå¼¹çª— */
        .order-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .order-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .order-modal-icon {
            font-size: 60px;
            margin-bottom: 16px;
        }

        .order-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--starbucks-green);
            margin-bottom: 8px;
        }

        .order-modal-id {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .order-modal-items {
            text-align: left;
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .order-modal-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--starbucks-green);
            margin-bottom: 16px;
        }

        .btn-close-modal {
            padding: 12px 30px;
            background: var(--starbucks-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* å®æ—¶åˆ·æ–°æç¤º */
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--starbucks-green);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .refresh-indicator.hidden {
            animation: slideOut 0.3s ease forwards;
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100px); opacity: 0; }
        }
    </style>
</head>
<body>
    <header class="demo-header">
        <h1>æ™ºèƒ½æ¨èç³»ç»Ÿ V2</h1>
        <p>A/Bæµ‹è¯• | ç”¨æˆ·è¡Œä¸º | Sessionä¸ªæ€§åŒ– | å®¢åˆ¶åŒ–æ¨è | è§£é‡Šæ€§å¢å¼º</p>
        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 12px;">
            <span class="badge">OpenAI Embedding + GPT-4o-mini</span>
            <a href="/presentation" class="badge" style="text-decoration: none; background: rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.3)'">
                ğŸ“Š æŸ¥çœ‹æŠ€æœ¯æ–¹æ¡ˆPPT
            </a>
        </div>
    </header>

    <div class="demo-container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="panel control-panel">
            <div class="panel-title">é…ç½®é€‰é¡¹</div>

            <div class="form-group">
                <label class="form-label">é€‰æ‹©ç”¨æˆ·ç”»åƒ</label>
                <div class="persona-grid" id="personaGrid">
                    <div class="persona-card selected" data-persona="å¥åº·è¾¾äºº">
                        <span class="emoji">ğŸ¥—</span>
                        <span>å¥åº·è¾¾äºº</span>
                    </div>
                    <div class="persona-card" data-persona="å’–å•¡é‡åº¦ç”¨æˆ·">
                        <span class="emoji">â˜•</span>
                        <span>å’–å•¡è¾¾äºº</span>
                    </div>
                    <div class="persona-card" data-persona="ç”œå“çˆ±å¥½è€…">
                        <span class="emoji">ğŸ°</span>
                        <span>ç”œå“æ§</span>
                    </div>
                    <div class="persona-card" data-persona="å°é²œæ´¾">
                        <span class="emoji">âœ¨</span>
                        <span>å°é²œæ´¾</span>
                    </div>
                    <div class="persona-card" data-persona="å®ç”¨ä¸»ä¹‰">
                        <span class="emoji">ğŸ’¼</span>
                        <span>å®ç”¨æ´¾</span>
                    </div>
                    <div class="persona-card" data-persona="å…»ç”Ÿç™½é¢†">
                        <span class="emoji">ğŸ§˜</span>
                        <span>å…»ç”Ÿç™½é¢†</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">åŠŸèƒ½å¼€å…³</label>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <label>A/Bæµ‹è¯•</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableABTest" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>å†å²è¡Œä¸ºåŠ æƒ</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableBehavior" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>Sessionä¸ªæ€§åŒ–</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableSession" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item">
                        <label>è§£é‡Šæ€§å¢å¼º</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableExplainability" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="toggle-item" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);">
                        <label style="color: #0369a1; font-weight: 600;">ğŸ¨ å®¢åˆ¶åŒ–æ¨è</label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="enableCustomization" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰åå¥½è¾“å…¥ -->
            <div class="custom-preference-section">
                <div class="title">ğŸ” æˆ–è€…ï¼Œæè¿°æ‚¨æƒ³è¦çš„é¥®å“</div>
                <div class="custom-input-group">
                    <input type="text" id="customPreference" placeholder="ä¾‹å¦‚ï¼šä½å¡ã€æç¥ã€å†°çˆ½çš„é¥®å“" maxlength="100">
                    <button class="btn-custom-search" id="btnCustomSearch">æ™ºèƒ½åŒ¹é…</button>
                </div>
                <div class="hint-tags">
                    <span class="hint-tag" onclick="addHint('ä½å¡')">ä½å¡</span>
                    <span class="hint-tag" onclick="addHint('æç¥')">æç¥</span>
                    <span class="hint-tag" onclick="addHint('ç”œèœœ')">ç”œèœœ</span>
                    <span class="hint-tag" onclick="addHint('å†°çˆ½')">å†°çˆ½</span>
                    <span class="hint-tag" onclick="addHint('æ¤ç‰©å¥¶')">æ¤ç‰©å¥¶</span>
                    <span class="hint-tag" onclick="addHint('æ— å’–å•¡å› ')">æ— å’–å•¡å› </span>
                </div>
            </div>

            <button class="btn-recommend" id="btnRecommend">è·å–æ¨è</button>

            <div class="stats-card" id="metricsCard" style="display: none;">
                <div class="stats-row">
                    <span class="label">æ€»è€—æ—¶</span>
                    <span class="value" id="metricTime">-</span>
                </div>
                <div class="stats-row">
                    <span class="label">LLMè°ƒç”¨</span>
                    <span class="value" id="metricLLM">-</span>
                </div>
                <div class="stats-row">
                    <span class="label">å¹³å‡åŒ¹é…åº¦</span>
                    <span class="value" id="metricScore">-</span>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content panel">
            <!-- å®¢åˆ¶åŒ–é¢„è®¾æ¼”ç¤º -->
            <div class="preset-section" id="presetSection">
                <div class="preset-title">
                    ğŸ¨ å®¢åˆ¶åŒ–é¢„è®¾ç®¡ç†
                </div>
                <div class="preset-controls">
                    <button class="btn-preset" id="btnCreatePreset">
                        â• åˆ›å»ºé¢„è®¾
                    </button>
                    <button class="btn-preset" id="btnLoadPresets" style="background: #7e22ce;">
                        ğŸ“‹ åŠ è½½æˆ‘çš„é¢„è®¾
                    </button>
                    <div class="order-status" id="presetStatus" style="background: rgba(255,255,255,0.8);">
                        åˆ›å»ºé¢„è®¾ä»¥å¿«é€Ÿåº”ç”¨æ‚¨çš„åå¥½è®¾ç½®
                    </div>
                </div>
                <div class="preset-list" id="presetList"></div>
            </div>

            <!-- è®¢å•å†å²å¯¹æ¯”æ¼”ç¤º -->
            <div class="comparison-section" id="comparisonSection">
                <div class="comparison-title">
                    ğŸ“Š è®¢å•å†å²æƒé‡å¯¹æ¯”æ¼”ç¤º
                </div>
                <div class="comparison-controls">
                    <button class="btn-simulate" id="btnSimulateOrders">
                        ğŸ² æ¨¡æ‹Ÿç”Ÿæˆè®¢å•å†å²
                    </button>
                    <button class="btn-compare" id="btnCompare">
                        âš¡ å¯¹æ¯”æ¨èæ•ˆæœ
                    </button>
                    <div class="order-status" id="orderStatus">
                        æš‚æ— æ¨¡æ‹Ÿè®¢å•
                    </div>
                </div>
                <div class="comparison-grid" id="comparisonGrid" style="display: none;">
                    <!-- å·¦ä¾§ï¼šæœ‰è®¢å•å†å²ç”¨æˆ· -->
                    <div class="comparison-column">
                        <div class="comparison-column-title old-user">
                            ğŸ‘¤ è€ç”¨æˆ· (æœ‰è®¢å•å†å²)
                            <span id="oldUserOrderCount" style="font-weight: normal; font-size: 12px;"></span>
                        </div>
                        <div id="oldUserRecs"></div>
                    </div>
                    <!-- å³ä¾§ï¼šæ–°ç”¨æˆ· -->
                    <div class="comparison-column">
                        <div class="comparison-column-title new-user">
                            ğŸ†• æ–°ç”¨æˆ· (æ— è®¢å•å†å²)
                        </div>
                        <div id="newUserRecs"></div>
                    </div>
                </div>
                <div class="comparison-summary" id="comparisonSummary" style="display: none;">
                    <h4>å¯¹æ¯”ç»“è®º</h4>
                    <div class="summary-stats" id="summaryStats"></div>
                </div>
            </div>

            <div class="panel-title">æ¨èç»“æœ</div>

            <div id="experimentBanner" class="experiment-banner" style="display: none;">
                <div class="title">A/Bå®éªŒåˆ†ç»„</div>
                <div class="variants" id="experimentVariants"></div>
            </div>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 16px;">æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–æ¨è...</p>
            </div>

            <div id="recommendationsGrid" class="recommendations-grid">
                <div style="text-align: center; padding: 60px; color: #888;">
                    <p>é€‰æ‹©ç”¨æˆ·ç”»åƒå¹¶ç‚¹å‡»ã€Œè·å–æ¨èã€</p>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ -->
        <div class="panel side-panel">
            <div class="panel-title">SessionçŠ¶æ€</div>

            <div class="session-info">
                <div class="title">å½“å‰ä¼šè¯</div>
                <div>Session ID: <span id="sessionId">-</span></div>
                <div>User ID: <span id="userId">-</span></div>
                <div>äº¤äº’æ¬¡æ•°: <span id="interactionCount">0</span></div>
            </div>

            <div class="realtime-prefs">
                <div class="pref-section">
                    <div class="label">å®æ—¶å–œå¥½æ ‡ç­¾</div>
                    <div class="pref-tags" id="likedTags">
                        <span style="color: #888; font-size: 11px;">æš‚æ— </span>
                    </div>
                </div>
                <div class="pref-section">
                    <div class="label">å®æ—¶æ’æ–¥æ ‡ç­¾</div>
                    <div class="pref-tags" id="dislikedTags">
                        <span style="color: #888; font-size: 11px;">æš‚æ— </span>
                    </div>
                </div>
            </div>

            <div id="explanationPanel" class="explanation-panel" style="display: none;">
                <div class="title">æ¨èè§£é‡Š (Top 1)</div>
                <div id="explanationContent"></div>
            </div>

            <div id="custPrefsPanel" class="cust-prefs-panel" style="display: none;">
                <div class="title">ğŸ¨ å®¢åˆ¶åŒ–åå¥½åˆ†æ</div>
                <div id="custPrefsContent">
                    <div class="pref-section">
                        <div class="label" style="font-size: 11px; color: #5eead4;">æ¸©åº¦åå¥½</div>
                        <div id="tempPref" style="font-size: 12px; color: #0d9488; font-weight: 600;">-</div>
                    </div>
                    <div class="pref-section">
                        <div class="label" style="font-size: 11px; color: #5eead4;">å¥¶ç±»åå¥½</div>
                        <div id="milkPref" style="font-size: 12px; color: #0d9488; font-weight: 600;">-</div>
                    </div>
                    <div class="pref-section">
                        <div class="label" style="font-size: 11px; color: #5eead4;">ç³–åº¦åå¥½</div>
                        <div id="sugarPref" style="font-size: 12px; color: #0d9488; font-weight: 600;">-</div>
                    </div>
                    <div class="pref-section">
                        <div class="label" style="font-size: 11px; color: #5eead4;">å®¢åˆ¶åŒ–å…³é”®è¯</div>
                        <div id="custKeywords" class="customization-keywords"></div>
                    </div>
                </div>
            </div>

            <!-- è´­ç‰©è½¦ -->
            <div class="cart-section" id="cartSection">
                <div class="cart-header">
                    <div class="cart-title">
                        ğŸ›’ è´­ç‰©è½¦
                        <span class="cart-badge" id="cartBadge">0</span>
                    </div>
                    <button class="btn-clear-cart" id="btnClearCart" style="display: none;">æ¸…ç©º</button>
                </div>
                <div class="cart-items" id="cartItems">
                    <div class="cart-empty">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>
                </div>
                <div class="cart-footer" id="cartFooter" style="display: none;">
                    <div class="cart-total">
                        <span class="cart-total-label">åˆè®¡</span>
                        <span class="cart-total-value" id="cartTotal">Â¥0.00</span>
                    </div>
                    <button class="btn-checkout" id="btnCheckout">å»ç»“ç®—</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æç¤º -->
    <div class="refresh-indicator" id="refreshIndicator" style="display: none;">
        <div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
        <span>æ­£åœ¨æ›´æ–°æ¨è...</span>
    </div>

    <!-- è®¢å•æˆåŠŸå¼¹çª— -->
    <div class="order-modal" id="orderModal" style="display: none;">
        <div class="order-modal-content">
            <div class="order-modal-icon">âœ…</div>
            <div class="order-modal-title">ä¸‹å•æˆåŠŸï¼</div>
            <div class="order-modal-id" id="modalOrderId">è®¢å•å·: -</div>
            <div class="order-modal-items" id="modalOrderItems"></div>
            <div class="order-modal-total" id="modalOrderTotal">Â¥0.00</div>
            <button class="btn-close-modal" onclick="closeOrderModal()">ç¡®å®š</button>
        </div>
    </div>

    <script>
        // ç”Ÿæˆå”¯ä¸€ID
        const sessionId = 'session_' + Date.now();
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);

        document.getElementById('sessionId').textContent = sessionId.substr(0, 16) + '...';
        document.getElementById('userId').textContent = userId;

        let selectedPersona = 'å¥åº·è¾¾äºº';
        let interactionCount = 0;
        let currentRecommendations = [];

        // äººè®¾ä¸å®¢åˆ¶åŒ–åå¥½æ˜ å°„
        const personaCustomizationMap = {
            'å¥åº·è¾¾äºº': {
                temperatures: ['å†°', 'å°‘å†°', 'å»å†°'],
                sugars: ['ä¸å¦å¤–åŠ ç³–', '0çƒ­é‡ä»£ç³–'],
                milks: ['ç‡•éº¦å¥¶', 'è„±è„‚ç‰›å¥¶', 'å·´æ—¦æœ¨å¥¶', 'è±†å¥¶'],
                keywords: ['ä½å¡', 'æ— ç³–', 'æ¤ç‰©åŸº']
            },
            'å’–å•¡é‡åº¦ç”¨æˆ·': {
                temperatures: ['çƒ­', 'ç‰¹åˆ«çƒ­'],
                espressoRoasts: ['ç»å…¸æµ“ç¼©(æ·±çƒ˜)'],
                espressoTypes: ['åŸèƒæµ“ç¼©', 'æ»¡èƒæµ“ç¼©'],
                keywords: ['æµ“éƒ', 'æç¥', 'æµ“ç¼©']
            },
            'ç”œå“çˆ±å¥½è€…': {
                temperatures: ['å†°', 'å°‘å†°'],
                sugars: ['ç»å…¸ç³–'],
                sugarFreeFlavors: ['é¦™è‰é£å‘³', 'æ¦›æœé£å‘³', 'æµ·ç›ç„¦ç³–é£å‘³'],
                drizzles: ['æ‘©å¡æ·‹é…±', 'ç„¦ç³–é£å‘³é…±'],
                whippedCream: true,
                keywords: ['ç”œèœœ', 'å¥¶æ²¹', 'ç„¦ç³–']
            },
            'å°é²œæ´¾': {
                temperatures: ['å†°', 'å°‘å†°'],
                milks: ['ç‡•éº¦å¥¶', 'æ¤°å¥¶'],
                sugarFreeFlavors: ['å¤§æºªåœ°é¦™è‰é£å‘³', 'è“è“é£å‘³', 'ç³¯é¦™æ–‘æ–“é£å‘³'],
                keywords: ['æ–°å“', 'é™å®š', 'åˆ›æ–°']
            },
            'å®ç”¨ä¸»ä¹‰': {
                cupSizes: ['å¤§æ¯', 'è¶…å¤§æ¯'],
                temperatures: ['çƒ­', 'å†°'],
                sugars: ['ç»å…¸ç³–', 'ä¸å¦å¤–åŠ ç³–'],
                keywords: ['ç»å…¸', 'å®æƒ ', 'å¤§æ¯']
            },
            'å…»ç”Ÿç™½é¢†': {
                temperatures: ['çƒ­', 'å¾®çƒ­', 'å°‘å†°'],
                sugars: ['ä¸å¦å¤–åŠ ç³–', '0çƒ­é‡ä»£ç³–', 'å°‘ç”œ'],
                milks: ['ç‡•éº¦å¥¶', 'è„±è„‚ç‰›å¥¶'],
                keywords: ['æç¥', 'ä½ç³–', 'å¥åº·']
            }
        };

        // æ¸²æŸ“å®¢åˆ¶åŒ–é€‰é¡¹
        function renderCustomizationOptions(constraints, suggestedCust, persona) {
            if (!constraints) return '';

            const personaPrefs = personaCustomizationMap[persona] || {};
            const suggested = suggestedCust?.suggested_customization || {};

            let html = '<div class="cust-options-content">';

            // æ¸©åº¦é€‰é¡¹
            if (constraints.available_temperatures?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">ğŸŒ¡ï¸ æ¸©åº¦</div>
                    <div class="cust-option-chips">
                        ${constraints.available_temperatures.map(t => {
                            const isRecommended = suggested.temperature === t;
                            const isPersonaMatch = personaPrefs.temperatures?.includes(t);
                            const isDefault = constraints.default_temperature === t;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${t}${isRecommended ? ' âœ“' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // æµ“ç¼©çƒ˜ç„™ç±»å‹
            if (constraints.available_espresso_roasts?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">â˜• æµ“ç¼©çƒ˜ç„™</div>
                    <div class="cust-option-chips">
                        ${constraints.available_espresso_roasts.map(r => {
                            const isRecommended = suggested.espresso_roast === r;
                            const isPersonaMatch = personaPrefs.espressoRoasts?.includes(r);
                            const isDefault = constraints.default_espresso_roast === r;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${r}${isRecommended ? ' âœ“' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // æµ“ç¼©èƒå–ç±»å‹
            if (constraints.available_espresso_types?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">âš¡ æµ“ç¼©èƒå–</div>
                    <div class="cust-option-chips">
                        ${constraints.available_espresso_types.map(t => {
                            const isRecommended = suggested.espresso_type === t;
                            const isPersonaMatch = personaPrefs.espressoTypes?.includes(t);
                            const isDefault = constraints.default_espresso_type === t;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${t}${isRecommended ? ' âœ“' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // ç”œåº¦é€‰é¡¹
            if (constraints.available_sugar_levels?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">ğŸ¬ ç”œåº¦</div>
                    <div class="cust-option-chips">
                        ${constraints.available_sugar_levels.map(s => {
                            const isRecommended = suggested.sugar_level === s;
                            const isPersonaMatch = personaPrefs.sugars?.includes(s);
                            const isDefault = constraints.default_sugar_level === s;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${s}${isRecommended ? ' âœ“' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // å¥¶ç±»é€‰é¡¹
            if (constraints.available_milk_types?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">ğŸ¥› å¥¶ç±»</div>
                    <div class="cust-option-chips">
                        ${constraints.available_milk_types.map(m => {
                            const isRecommended = suggested.milk_type === m;
                            const isPersonaMatch = personaPrefs.milks?.includes(m);
                            const isDefault = constraints.default_milk_type === m;
                            let classes = ['cust-chip'];
                            if (isRecommended) classes.push('highlighted');
                            else if (isPersonaMatch) classes.push('persona-match');
                            if (isDefault) classes.push('default');
                            return `<span class="${classes.join(' ')}">${m}${isRecommended ? ' âœ“' : ''}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // æ— ç³–é£å‘³ç³–æµ†
            if (constraints.available_sugar_free_flavors?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">ğŸŒ¸ æ— ç³–é£å‘³ç³–æµ†</div>
                    <div class="cust-option-chips">
                        ${constraints.available_sugar_free_flavors.map(f => {
                            const isPersonaMatch = personaPrefs.sugarFreeFlavors?.includes(f);
                            let classes = ['cust-chip'];
                            if (isPersonaMatch) classes.push('persona-match');
                            return `<span class="${classes.join(' ')}">${f}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // æ·‹é…±é€‰é¡¹
            if (constraints.available_drizzles?.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">ğŸ« æ·‹é…±</div>
                    <div class="cust-option-chips">
                        ${constraints.available_drizzles.map(d => {
                            const isPersonaMatch = personaPrefs.drizzles?.includes(d);
                            let classes = ['cust-chip'];
                            if (isPersonaMatch) classes.push('persona-match');
                            return `<span class="${classes.join(' ')}">${d}</span>`;
                        }).join('')}
                    </div>
                </div>`;
            }

            // é¢å¤–é€‰é¡¹ï¼ˆå¥¶æ²¹é¡¶ã€æµ“ç¼©ä»½æ•°ï¼‰
            let extras = [];
            if (constraints.supports_whipped_cream) {
                const isPersonaMatch = personaPrefs.whippedCream;
                extras.push(`<span class="cust-chip ${isPersonaMatch ? 'persona-match' : ''}">å¯åŠ å¥¶æ²¹é¡¶</span>`);
            }
            if (constraints.supports_espresso_adjustment) {
                extras.push(`<span class="cust-chip">å¯è°ƒæ•´æµ“ç¼©ä»½æ•°</span>`);
            }
            if (constraints.supports_extra_cream) {
                extras.push(`<span class="cust-chip">å¯åŠ ç¨€å¥¶æ²¹</span>`);
            }
            if (constraints.supports_mocha_sauce) {
                extras.push(`<span class="cust-chip">å¯åŠ æ‘©å¡é…±</span>`);
            }

            if (extras.length > 0) {
                html += `<div class="cust-option-group">
                    <div class="cust-option-label">âœ¨ é¢å¤–é€‰é¡¹</div>
                    <div class="cust-option-chips">${extras.join('')}</div>
                </div>`;
            }

            // å›¾ä¾‹
            html += `<div class="cust-legend">
                <div class="cust-legend-item"><span class="cust-legend-dot recommended"></span>æ¨èé€‰é¡¹</div>
                <div class="cust-legend-item"><span class="cust-legend-dot persona"></span>äººè®¾åå¥½</div>
                <div class="cust-legend-item"><span class="cust-legend-dot default"></span>é»˜è®¤é…ç½®</div>
            </div>`;

            html += '</div>';

            return html;
        }

        // åˆ‡æ¢å®¢åˆ¶åŒ–é¢æ¿å±•å¼€/æ”¶èµ·
        function toggleCustPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.toggle('expanded');
            }
        }

        // ç”»åƒé€‰æ‹©
        document.querySelectorAll('.persona-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.persona-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedPersona = card.dataset.persona;
            });
        });

        // è·å–æ¨è
        document.getElementById('btnRecommend').addEventListener('click', async () => {
            const btn = document.getElementById('btnRecommend');
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('recommendationsGrid');

            btn.disabled = true;
            btn.textContent = 'æ¨èä¸­...';
            loading.style.display = 'flex';
            grid.innerHTML = '';

            try {
                const response = await fetch('/api/embedding/recommend/v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona_type: selectedPersona,
                        user_id: userId,
                        session_id: sessionId,
                        top_k: 6,
                        enable_ab_test: document.getElementById('enableABTest').checked,
                        enable_behavior: document.getElementById('enableBehavior').checked,
                        enable_session: document.getElementById('enableSession').checked,
                        enable_explainability: document.getElementById('enableExplainability').checked,
                        enable_customization: document.getElementById('enableCustomization').checked
                    })
                });

                const data = await response.json();
                currentRecommendations = data.recommendations || [];

                // æ˜¾ç¤ºå®éªŒåˆ†ç»„
                if (data.experiment && Object.keys(data.experiment).length > 0) {
                    const banner = document.getElementById('experimentBanner');
                    const variants = document.getElementById('experimentVariants');
                    variants.innerHTML = '';

                    for (const [expId, info] of Object.entries(data.experiment)) {
                        const tag = document.createElement('span');
                        tag.className = 'variant-tag';
                        tag.textContent = `${info.experiment_name || expId}: ${info.variant_name || info.variant}`;
                        variants.appendChild(tag);
                    }

                    banner.style.display = 'block';
                } else {
                    document.getElementById('experimentBanner').style.display = 'none';
                }

                // æ˜¾ç¤ºæŒ‡æ ‡
                if (data.metrics) {
                    document.getElementById('metricsCard').style.display = 'block';
                    document.getElementById('metricTime').textContent = `${data.metrics.total_time_ms}ms`;
                    document.getElementById('metricLLM').textContent = `${data.llm_info?.total_llm_calls || 0}æ¬¡`;
                    document.getElementById('metricScore').textContent = `${(data.metrics.avg_match_score * 100).toFixed(1)}%`;
                }

                // æ¸²æŸ“æ¨èå¡ç‰‡
                renderRecommendations(data.recommendations);

                // æ˜¾ç¤ºè§£é‡Š
                if (data.recommendations?.[0]?.explanation) {
                    showExplanation(data.recommendations[0].explanation);
                }

                // æ›´æ–°å®¢åˆ¶åŒ–åå¥½é¢æ¿
                if (document.getElementById('enableCustomization').checked) {
                    updateCustomizationPrefs();
                }

            } catch (error) {
                console.error('Error:', error);
                grid.innerHTML = `<div style="color: red; padding: 20px;">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'è·å–æ¨è';
                loading.style.display = 'none';
            }
        });

        function renderRecommendations(recommendations) {
            const grid = document.getElementById('recommendationsGrid');
            grid.innerHTML = '';

            recommendations.forEach((rec, index) => {
                const card = document.createElement('div');
                card.className = 'rec-card';

                const breakdown = rec.score_breakdown || {};
                const behaviorClass = breakdown.behavior_multiplier > 1 ? 'boost' : '';
                const sessionClass = breakdown.session_multiplier > 1 ? 'boost' : (breakdown.session_multiplier < 1 ? 'penalty' : '');
                const customizationClass = breakdown.customization_multiplier > 1 ? 'boost' : (breakdown.customization_multiplier < 1 ? 'penalty' : '');

                // æ„å»ºå®¢åˆ¶åŒ–å»ºè®®HTML
                const suggestedCust = rec.suggested_customization;
                let customizationHtml = '';
                if (suggestedCust && suggestedCust.suggested_customization) {
                    const sc = suggestedCust.suggested_customization;
                    const confidence = suggestedCust.confidence || 0;
                    const confClass = confidence >= 0.7 ? 'confidence-high' : (confidence >= 0.4 ? 'confidence-medium' : 'confidence-low');
                    const confText = confidence >= 0.7 ? 'é«˜ç½®ä¿¡åº¦' : (confidence >= 0.4 ? 'ä¸­ç½®ä¿¡åº¦' : 'ä½ç½®ä¿¡åº¦');

                    customizationHtml = `
                        <div class="customization-section">
                            <div class="title">
                                ğŸ¨ æ¨èå®¢åˆ¶åŒ–
                                <span class="confidence-badge ${confClass}">${confText} ${(confidence * 100).toFixed(0)}%</span>
                            </div>
                            ${sc.temperature ? `<div class="customization-item"><span class="label">æ¸©åº¦</span><span class="value">${formatTemp(sc.temperature)}</span></div>` : ''}
                            ${sc.cup_size ? `<div class="customization-item"><span class="label">æ¯å‹</span><span class="value">${formatSize(sc.cup_size)}</span></div>` : ''}
                            ${sc.sugar_level ? `<div class="customization-item"><span class="label">ç³–åº¦</span><span class="value">${formatSugar(sc.sugar_level)}</span></div>` : ''}
                            ${sc.milk_type ? `<div class="customization-item"><span class="label">å¥¶ç±»</span><span class="value">${formatMilk(sc.milk_type)}</span></div>` : ''}
                            ${suggestedCust.reason ? `<div class="customization-reason">ğŸ’¡ ${suggestedCust.reason}</div>` : ''}
                        </div>
                    `;
                }

                // è·å–å®¢åˆ¶åŒ–çº¦æŸå’Œä¼šå‘˜ä»·
                const constraints = rec.item.customization_constraints || {};
                const memberPrice = constraints.member_discount;
                const custPanelId = `cust-panel-${index}`;

                // æ„å»ºå®¢åˆ¶åŒ–é€‰é¡¹é¢æ¿HTML
                const custOptionsHtml = renderCustomizationOptions(constraints, suggestedCust, selectedPersona);

                card.innerHTML = `
                    <div class="rec-card-header">
                        <div>
                            <div class="rec-card-title">${rec.item.name}</div>
                            <div class="rec-card-category">
                                ${rec.item.category} Â· Â¥${rec.item.base_price}
                                ${memberPrice ? `<span class="member-price-badge">â­ ä¼šå‘˜ Â¥${memberPrice}</span>` : ''}
                            </div>
                        </div>
                        <div class="match-score">${(rec.match_score * 100).toFixed(1)}%</div>
                    </div>

                    <div class="score-breakdown">
                        <div class="score-row">
                            <span class="label">Embeddingç›¸ä¼¼åº¦</span>
                            <span class="value">${(breakdown.embedding_similarity * 100).toFixed(1)}%</span>
                        </div>
                        <div class="score-row">
                            <span class="label">ä¸šåŠ¡è§„åˆ™</span>
                            <span class="value">Ã—${breakdown.rule_multiplier?.toFixed(2) || '1.00'}</span>
                        </div>
                        <div class="score-row">
                            <span class="label">å†å²è¡Œä¸º</span>
                            <span class="value ${behaviorClass}">Ã—${breakdown.behavior_multiplier?.toFixed(2) || '1.00'}</span>
                        </div>
                        <div class="score-row">
                            <span class="label">Sessionåå¥½</span>
                            <span class="value ${sessionClass}">Ã—${breakdown.session_multiplier?.toFixed(2) || '1.00'}</span>
                        </div>
                        <div class="score-row" style="background: rgba(3,105,161,0.1); margin: 4px -10px; padding: 4px 10px;">
                            <span class="label" style="color: #0369a1;">ğŸ¨ å®¢åˆ¶åŒ–åŒ¹é…</span>
                            <span class="value ${customizationClass}" style="color: #0369a1;">Ã—${breakdown.customization_multiplier?.toFixed(2) || '1.00'}</span>
                        </div>
                    </div>

                    ${customizationHtml}

                    ${custOptionsHtml ? `
                    <div class="cust-options-panel" id="${custPanelId}">
                        <div class="panel-header" onclick="toggleCustPanel('${custPanelId}')">
                            <div class="panel-title">
                                <span>ğŸ“‹ å¯é€‰å®¢åˆ¶åŒ–é…ç½®</span>
                                <span style="font-size: 10px; color: #94a3b8; font-weight: normal;">(ç‚¹å‡»å±•å¼€)</span>
                            </div>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        ${custOptionsHtml}
                    </div>
                    ` : ''}

                    <div class="rec-reason">${rec.reason || 'ä¸ºæ‚¨ç²¾é€‰æ¨è'}</div>

                    ${rec.matched_keywords?.length > 0 ? `
                        <div class="matched-keywords">
                            ${rec.matched_keywords.map(k => `<span class="keyword-tag">${k}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="feedback-buttons">
                        <button class="feedback-btn like" onclick="recordFeedback('${rec.item.sku}', 'like', this, ${JSON.stringify(rec.item.tags).replace(/"/g, "'")})">ğŸ‘ å–œæ¬¢</button>
                        <button class="feedback-btn dislike" onclick="recordFeedback('${rec.item.sku}', 'dislike', this, ${JSON.stringify(rec.item.tags).replace(/"/g, "'")})">ğŸ‘ ä¸å–œæ¬¢</button>
                        <button class="btn-add-cart" onclick="addToCart('${rec.item.sku}', '${rec.item.name}', ${rec.item.base_price}, this, ${JSON.stringify(rec.suggested_customization?.suggested_customization || {}).replace(/"/g, "'")})">ğŸ›’ åŠ å…¥</button>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function showExplanation(explanation) {
            const panel = document.getElementById('explanationPanel');
            const content = document.getElementById('explanationContent');

            let html = `<div style="margin-bottom: 8px;">${explanation.summary}</div>`;

            if (explanation.factors) {
                html += explanation.factors.map(f => `
                    <div class="factor-item">
                        <span style="flex-shrink: 0; width: 80px; font-size: 11px; color: #666;">${f.label}</span>
                        <div class="factor-bar">
                            <div class="factor-bar-fill" style="width: ${f.contribution || 25}%"></div>
                        </div>
                        <span style="flex-shrink: 0; font-size: 11px; font-weight: 600;">${f.contribution?.toFixed(0) || 25}%</span>
                    </div>
                `).join('');
            }

            content.innerHTML = html;
            panel.style.display = 'block';
        }

        async function recordFeedback(sku, type, btn, tags) {
            // è§†è§‰åé¦ˆ
            btn.classList.add('clicked');

            // æ›´æ–°äº¤äº’è®¡æ•°
            interactionCount++;
            document.getElementById('interactionCount').textContent = interactionCount;

            // æ›´æ–°å®æ—¶åå¥½æ˜¾ç¤º
            updateRealtimePrefs(type, tags);

            // è®°å½•åé¦ˆ
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        session_id: sessionId,
                        item_sku: sku,
                        feedback_type: type
                    })
                });

                // è®°å½•Sessionäº¤äº’
                const item = currentRecommendations.find(r => r.item.sku === sku)?.item;
                if (item) {
                    await fetch('/api/session/interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            interaction_type: type,
                            item_data: {
                                sku: item.sku,
                                tags: item.tags,
                                category: item.category,
                                price: item.base_price
                            }
                        })
                    });
                }
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        function updateRealtimePrefs(type, tags) {
            const container = type === 'like' ? document.getElementById('likedTags') : document.getElementById('dislikedTags');

            // è§£ætags (å¤„ç†å•å¼•å·)
            let parsedTags = [];
            if (typeof tags === 'string') {
                try {
                    parsedTags = JSON.parse(tags.replace(/'/g, '"'));
                } catch (e) {
                    parsedTags = tags.split(',');
                }
            } else if (Array.isArray(tags)) {
                parsedTags = tags;
            }

            // æ¸…é™¤"æš‚æ— "æç¤º
            if (container.querySelector('span[style]')) {
                container.innerHTML = '';
            }

            // æ·»åŠ æ ‡ç­¾
            parsedTags.forEach(tag => {
                if (!container.querySelector(`[data-tag="${tag}"]`)) {
                    const span = document.createElement('span');
                    span.className = `pref-tag ${type === 'like' ? 'liked' : 'disliked'}`;
                    span.textContent = tag;
                    span.dataset.tag = tag;
                    container.appendChild(span);
                }
            });
        }

        // ============ è®¢å•å†å²å¯¹æ¯”æ¼”ç¤º ============
        const comparisonUserId = 'demo_order_user_' + Date.now();
        const newUserId = 'brand_new_user_' + Date.now();
        let simulatedOrderCount = 0;

        // æ¨¡æ‹Ÿç”Ÿæˆè®¢å•
        document.getElementById('btnSimulateOrders').addEventListener('click', async () => {
            const btn = document.getElementById('btnSimulateOrders');
            const status = document.getElementById('orderStatus');

            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';

            try {
                const response = await fetch('/api/orders/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: comparisonUserId,
                        order_count: 20,
                        days_range: 60,
                        category_weights: {
                            'å’–å•¡': 0.6,
                            'èŒ¶é¥®': 0.25,
                            'æ˜Ÿå†°ä¹': 0.15
                        }
                    })
                });

                const data = await response.json();
                simulatedOrderCount = data.order_count;

                status.className = 'order-status has-orders';
                status.innerHTML = `âœ… å·²ç”Ÿæˆ <strong>${data.order_count}</strong> ç¬”è®¢å• |
                    ${Object.entries(data.category_distribution).map(([k,v]) => `${k}: ${v}`).join(', ')}`;

            } catch (error) {
                console.error('Error:', error);
                status.textContent = 'âŒ ç”Ÿæˆå¤±è´¥';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ² æ¨¡æ‹Ÿç”Ÿæˆè®¢å•å†å²';
            }
        });

        // å¯¹æ¯”æ¨èæ•ˆæœ
        document.getElementById('btnCompare').addEventListener('click', async () => {
            const btn = document.getElementById('btnCompare');
            const grid = document.getElementById('comparisonGrid');
            const summary = document.getElementById('comparisonSummary');

            btn.disabled = true;
            btn.textContent = 'å¯¹æ¯”ä¸­...';

            try {
                // å¹¶è¡Œè¯·æ±‚ä¸¤ä¸ªç”¨æˆ·çš„æ¨è
                const [oldUserResp, newUserResp] = await Promise.all([
                    fetch('/api/embedding/recommend/v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona_type: selectedPersona,
                            user_id: comparisonUserId,
                            top_k: 4,
                            enable_ab_test: false,
                            enable_behavior: true,
                            enable_session: false,
                            enable_explainability: true
                        })
                    }),
                    fetch('/api/embedding/recommend/v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            persona_type: selectedPersona,
                            user_id: newUserId,
                            top_k: 4,
                            enable_ab_test: false,
                            enable_behavior: true,
                            enable_session: false,
                            enable_explainability: true
                        })
                    })
                ]);

                const oldUserData = await oldUserResp.json();
                const newUserData = await newUserResp.json();

                // æ¸²æŸ“è€ç”¨æˆ·æ¨è
                document.getElementById('oldUserOrderCount').textContent =
                    simulatedOrderCount > 0 ? `(${simulatedOrderCount}ç¬”è®¢å•)` : '';
                renderComparisonRecs('oldUserRecs', oldUserData.recommendations, true);

                // æ¸²æŸ“æ–°ç”¨æˆ·æ¨è
                renderComparisonRecs('newUserRecs', newUserData.recommendations, false);

                // è®¡ç®—å¯¹æ¯”ç»Ÿè®¡
                const oldAvgScore = oldUserData.recommendations.reduce((sum, r) => sum + r.match_score, 0) / oldUserData.recommendations.length;
                const newAvgScore = newUserData.recommendations.reduce((sum, r) => sum + r.match_score, 0) / newUserData.recommendations.length;
                const avgBoost = oldUserData.recommendations.reduce((sum, r) => sum + (r.score_breakdown?.behavior_multiplier || 1), 0) / oldUserData.recommendations.length;
                const improvement = ((oldAvgScore / newAvgScore - 1) * 100).toFixed(1);

                document.getElementById('summaryStats').innerHTML = `
                    <div class="summary-stat">
                        <div class="number">${(oldAvgScore * 100).toFixed(1)}%</div>
                        <div class="label">è€ç”¨æˆ·å¹³å‡å¾—åˆ†</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number">${(newAvgScore * 100).toFixed(1)}%</div>
                        <div class="label">æ–°ç”¨æˆ·å¹³å‡å¾—åˆ†</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number">Ã—${avgBoost.toFixed(2)}</div>
                        <div class="label">å¹³å‡è®¢å•åŠ æƒ</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number" style="color: ${improvement > 0 ? '#22c55e' : '#6366f1'}">
                            ${improvement > 0 ? '+' : ''}${improvement}%
                        </div>
                        <div class="label">æ¨èæå‡</div>
                    </div>
                `;

                grid.style.display = 'grid';
                summary.style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'âš¡ å¯¹æ¯”æ¨èæ•ˆæœ';
            }
        });

        // å®¢åˆ¶åŒ–æ ¼å¼åŒ–è¾…åŠ©å‡½æ•°
        function formatTemp(temp) {
            const map = { 'HOT': 'çƒ­é¥® â˜•', 'ICED': 'å†°é¥® ğŸ§Š', 'BLENDED': 'å†°æ²™ ğŸŒ€' };
            return map[temp] || temp;
        }

        function formatSize(size) {
            const map = { 'TALL': 'ä¸­æ¯', 'GRANDE': 'å¤§æ¯', 'VENTI': 'è¶…å¤§æ¯' };
            return map[size] || size;
        }

        function formatSugar(sugar) {
            const map = { 'NONE': 'æ— ç³–', 'LIGHT': 'å°‘ç³–', 'HALF': 'åŠç³–', 'STANDARD': 'æ ‡å‡†ç³–', 'EXTRA': 'å¤šç³–' };
            return map[sugar] || sugar;
        }

        function formatMilk(milk) {
            const map = { 'WHOLE': 'å…¨è„‚å¥¶', 'SKIM': 'è„±è„‚å¥¶', 'SOY': 'è±†å¥¶', 'OAT': 'ç‡•éº¦å¥¶', 'ALMOND': 'æä»å¥¶', 'COCONUT': 'æ¤°å¥¶' };
            return map[milk] || milk;
        }

        // æ›´æ–°å®¢åˆ¶åŒ–åå¥½é¢æ¿
        async function updateCustomizationPrefs() {
            try {
                const response = await fetch(`/api/behavior/user/${userId}`);
                const data = await response.json();

                if (data.customization_preference) {
                    const panel = document.getElementById('custPrefsPanel');
                    panel.style.display = 'block';

                    const cp = data.customization_preference;

                    // æ¸©åº¦åå¥½
                    if (cp.temperature_preference) {
                        const temps = Object.entries(cp.temperature_preference)
                            .sort((a, b) => b[1] - a[1])
                            .map(([k, v]) => `${formatTemp(k)} ${(v * 100).toFixed(0)}%`)
                            .join(', ');
                        document.getElementById('tempPref').textContent = temps || '-';
                    }

                    // å¥¶ç±»åå¥½
                    if (cp.milk_preference) {
                        const milks = Object.entries(cp.milk_preference)
                            .sort((a, b) => b[1] - a[1])
                            .map(([k, v]) => `${formatMilk(k)} ${(v * 100).toFixed(0)}%`)
                            .join(', ');
                        document.getElementById('milkPref').textContent = milks || '-';
                    }

                    // ç³–åº¦åå¥½
                    if (cp.sugar_preference) {
                        const sugars = Object.entries(cp.sugar_preference)
                            .sort((a, b) => b[1] - a[1])
                            .map(([k, v]) => `${formatSugar(k)} ${(v * 100).toFixed(0)}%`)
                            .join(', ');
                        document.getElementById('sugarPref').textContent = sugars || '-';
                    }

                    // å®¢åˆ¶åŒ–å…³é”®è¯
                    const keywordsContainer = document.getElementById('custKeywords');
                    if (data.customization_keywords && data.customization_keywords.length > 0) {
                        keywordsContainer.innerHTML = data.customization_keywords
                            .map(k => `<span class="customization-keyword">${k}</span>`)
                            .join('');
                    } else {
                        keywordsContainer.innerHTML = '<span style="color: #888; font-size: 11px;">æš‚æ— </span>';
                    }
                }
            } catch (error) {
                console.log('No customization preferences yet');
            }
        }

        // ============ é¢„è®¾ç®¡ç† ============
        document.getElementById('btnCreatePreset').addEventListener('click', async () => {
            const btn = document.getElementById('btnCreatePreset');
            const status = document.getElementById('presetStatus');

            btn.disabled = true;
            btn.textContent = 'åˆ›å»ºä¸­...';

            try {
                const response = await fetch('/api/presets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        name: 'æˆ‘çš„æ—¥å¸¸',
                        default_temperature: 'ICED',
                        default_cup_size: 'GRANDE',
                        default_sugar_level: 'NONE',
                        default_milk_type: 'OAT'
                    })
                });

                const data = await response.json();
                if (data.preset) {
                    status.className = 'order-status has-orders';
                    status.innerHTML = `âœ… å·²åˆ›å»ºé¢„è®¾: <strong>${data.preset.name}</strong>`;
                    loadUserPresets();
                }
            } catch (error) {
                console.error('Error:', error);
                status.textContent = 'âŒ åˆ›å»ºå¤±è´¥';
            } finally {
                btn.disabled = false;
                btn.textContent = 'â• åˆ›å»ºé¢„è®¾';
            }
        });

        document.getElementById('btnLoadPresets').addEventListener('click', loadUserPresets);

        async function loadUserPresets() {
            const container = document.getElementById('presetList');
            const status = document.getElementById('presetStatus');

            try {
                const response = await fetch(`/api/presets/user/${userId}`);
                const data = await response.json();

                if (data.presets && data.presets.length > 0) {
                    container.innerHTML = data.presets.map(p => `
                        <div class="preset-card">
                            <div class="name">ğŸ“‹ ${p.name}</div>
                            <div class="options">
                                ${p.default_temperature ? formatTemp(p.default_temperature) : ''}
                                ${p.default_cup_size ? ' Â· ' + formatSize(p.default_cup_size) : ''}
                                ${p.default_sugar_level ? ' Â· ' + formatSugar(p.default_sugar_level) : ''}
                                ${p.default_milk_type ? ' Â· ' + formatMilk(p.default_milk_type) : ''}
                            </div>
                        </div>
                    `).join('');
                    status.className = 'order-status has-orders';
                    status.innerHTML = `âœ… å·²åŠ è½½ <strong>${data.presets.length}</strong> ä¸ªé¢„è®¾`;
                } else {
                    container.innerHTML = '<div style="color: #888; font-size: 12px;">æš‚æ— é¢„è®¾ï¼Œç‚¹å‡»"åˆ›å»ºé¢„è®¾"å¼€å§‹</div>';
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderComparisonRecs(containerId, recommendations, showBoost) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            recommendations.forEach((rec, index) => {
                const breakdown = rec.score_breakdown || {};
                const orderDetail = breakdown.order_boost_detail || {};
                const hasBoosted = breakdown.behavior_multiplier > 1;

                let boostHtml = '';
                if (showBoost && hasBoosted && orderDetail.factors) {
                    boostHtml = `
                        <div class="boost-detail">
                            <div class="factor">
                                <span class="label">å¤è´­åŠ æƒ</span>
                                <span class="value">Ã—${orderDetail.factors.repurchase?.toFixed(2) || '1.00'}</span>
                            </div>
                            <div class="factor">
                                <span class="label">ç±»åˆ«åå¥½</span>
                                <span class="value">Ã—${orderDetail.factors.category?.toFixed(2) || '1.00'}</span>
                            </div>
                            <div class="factor">
                                <span class="label">æ ‡ç­¾åŒ¹é…</span>
                                <span class="value">Ã—${orderDetail.factors.tag?.toFixed(2) || '1.00'}</span>
                            </div>
                            <div class="factor">
                                <span class="label">ä»·æ ¼åŒ¹é…</span>
                                <span class="value">Ã—${orderDetail.factors.price_match?.toFixed(2) || '1.00'}</span>
                            </div>
                            ${orderDetail.explanation ? `<div class="boost-explanation">ğŸ’¡ ${orderDetail.explanation}</div>` : ''}
                        </div>
                    `;
                }

                const hasCustBoosted = breakdown.customization_multiplier && breakdown.customization_multiplier !== 1;

                const item = document.createElement('div');
                item.className = 'comparison-item';
                item.innerHTML = `
                    <div class="comparison-item-header">
                        <div>
                            <div class="comparison-item-name">${index + 1}. ${rec.item.name}</div>
                            <div style="font-size: 12px; color: #888;">${rec.item.category} Â· Â¥${rec.item.base_price}</div>
                        </div>
                        <div class="comparison-item-score ${hasBoosted ? 'boosted' : 'normal'}">
                            ${(rec.match_score * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        Embedding: ${(breakdown.embedding_similarity * 100).toFixed(1)}%
                        Ã— è§„åˆ™: ${breakdown.rule_multiplier?.toFixed(2) || '1.00'}
                        Ã— <strong style="color: ${hasBoosted ? '#22c55e' : '#666'}">è®¢å•: ${breakdown.behavior_multiplier?.toFixed(2) || '1.00'}</strong>
                        Ã— <strong style="color: ${hasCustBoosted ? '#0369a1' : '#666'}">å®¢åˆ¶åŒ–: ${breakdown.customization_multiplier?.toFixed(2) || '1.00'}</strong>
                    </div>
                    ${boostHtml}
                `;
                container.appendChild(item);
            });
        }

        // ============ è‡ªå®šä¹‰åå¥½æœç´¢ ============
        function addHint(hint) {
            const input = document.getElementById('customPreference');
            const currentVal = input.value.trim();
            if (currentVal) {
                input.value = currentVal + 'ã€' + hint;
            } else {
                input.value = hint;
            }
        }

        document.getElementById('btnCustomSearch').addEventListener('click', searchByCustomPreference);
        document.getElementById('customPreference').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchByCustomPreference();
        });

        async function searchByCustomPreference() {
            const input = document.getElementById('customPreference').value.trim();
            if (!input) return;

            const btn = document.getElementById('btnCustomSearch');
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('recommendationsGrid');

            btn.disabled = true;
            btn.textContent = 'åŒ¹é…ä¸­...';
            loading.style.display = 'flex';
            grid.innerHTML = '';

            try {
                const response = await fetch('/api/embedding/recommend/custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        custom_preference: input,
                        user_id: userId,
                        session_id: sessionId,
                        top_k: 6,
                        enable_ab_test: document.getElementById('enableABTest').checked,
                        enable_behavior: document.getElementById('enableBehavior').checked,
                        enable_session: document.getElementById('enableSession').checked,
                        enable_explainability: document.getElementById('enableExplainability').checked,
                        enable_customization: document.getElementById('enableCustomization').checked
                    })
                });

                const data = await response.json();
                currentRecommendations = data.recommendations || [];

                // æ˜¾ç¤ºå®éªŒåˆ†ç»„
                if (data.experiment && Object.keys(data.experiment).length > 0) {
                    const banner = document.getElementById('experimentBanner');
                    const variants = document.getElementById('experimentVariants');
                    variants.innerHTML = '';

                    for (const [expId, info] of Object.entries(data.experiment)) {
                        const tag = document.createElement('span');
                        tag.className = 'variant-tag';
                        tag.textContent = `${info.experiment_name || expId}: ${info.variant_name || info.variant}`;
                        variants.appendChild(tag);
                    }

                    banner.style.display = 'block';
                }

                // æ˜¾ç¤ºæŒ‡æ ‡
                if (data.metrics) {
                    document.getElementById('metricsCard').style.display = 'block';
                    document.getElementById('metricTime').textContent = `${data.metrics.total_time_ms}ms`;
                    document.getElementById('metricLLM').textContent = `${data.llm_info?.total_llm_calls || 0}æ¬¡`;
                    document.getElementById('metricScore').textContent = `${(data.metrics.avg_match_score * 100).toFixed(1)}%`;
                }

                renderRecommendations(data.recommendations);

                if (data.recommendations?.[0]?.explanation) {
                    showExplanation(data.recommendations[0].explanation);
                }

            } catch (error) {
                console.error('Error:', error);
                grid.innerHTML = `<div style="color: red; padding: 20px;">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æ™ºèƒ½åŒ¹é…';
                loading.style.display = 'none';
            }
        }

        // ============ è´­ç‰©è½¦åŠŸèƒ½ ============
        let cartData = { items: [], total_price: 0, total_items: 0 };

        // åˆå§‹åŒ–åŠ è½½è´­ç‰©è½¦
        async function loadCart() {
            try {
                const response = await fetch(`/api/cart/${sessionId}`);
                cartData = await response.json();
                renderCart();
            } catch (error) {
                console.log('Cart not loaded:', error);
            }
        }

        // æ·»åŠ åˆ°è´­ç‰©è½¦
        async function addToCart(sku, name, price, btn, customization) {
            btn.disabled = true;
            btn.textContent = 'æ·»åŠ ä¸­...';

            try {
                // å¤„ç†customization - è§£æå•å¼•å·çš„JSON
                let custData = null;
                if (customization && typeof customization === 'string') {
                    try {
                        custData = JSON.parse(customization.replace(/'/g, '"'));
                    } catch (e) {}
                } else if (customization && typeof customization === 'object' && Object.keys(customization).length > 0) {
                    custData = customization;
                }

                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_id: userId,
                        item_sku: sku,
                        quantity: 1,
                        customization: custData
                    })
                });

                const data = await response.json();
                if (data.status === 'added') {
                    cartData = data.cart;
                    renderCart();
                    btn.classList.add('added');
                    btn.textContent = 'âœ“ å·²åŠ å…¥';
                    setTimeout(() => {
                        btn.classList.remove('added');
                        btn.textContent = 'ğŸ›’ åŠ å…¥';
                    }, 1500);
                } else {
                    alert(data.message || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                console.error('Add to cart error:', error);
                alert('æ·»åŠ å¤±è´¥');
            } finally {
                btn.disabled = false;
            }
        }

        // æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡
        async function updateCartItemQty(itemId, delta) {
            const item = cartData.items.find(i => i.id === itemId);
            if (!item) return;

            const newQty = item.quantity + delta;

            try {
                const response = await fetch(`/api/cart/${sessionId}/item/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: newQty })
                });

                const data = await response.json();
                if (data.status === 'updated') {
                    cartData = data.cart;
                    renderCart();
                }
            } catch (error) {
                console.error('Update cart error:', error);
            }
        }

        // åˆ é™¤è´­ç‰©è½¦å•†å“
        async function removeCartItem(itemId) {
            try {
                const response = await fetch(`/api/cart/${sessionId}/item/${itemId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'removed') {
                    cartData = data.cart;
                    renderCart();
                }
            } catch (error) {
                console.error('Remove cart error:', error);
            }
        }

        // æ¸…ç©ºè´­ç‰©è½¦
        document.getElementById('btnClearCart').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/cart/${sessionId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'cleared') {
                    cartData = data.cart;
                    renderCart();
                }
            } catch (error) {
                console.error('Clear cart error:', error);
            }
        });

        // ç»“ç®—
        document.getElementById('btnCheckout').addEventListener('click', async () => {
            if (cartData.items.length === 0) return;

            const btn = document.getElementById('btnCheckout');
            btn.disabled = true;
            btn.textContent = 'å¤„ç†ä¸­...';

            try {
                const response = await fetch('/api/cart/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_id: userId
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showOrderModal(data);
                    cartData = { items: [], total_price: 0, total_items: 0 };
                    renderCart();
                } else {
                    alert(data.message || 'ç»“ç®—å¤±è´¥');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('ç»“ç®—å¤±è´¥');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å»ç»“ç®—';
            }
        });

        // æ¸²æŸ“è´­ç‰©è½¦
        function renderCart() {
            const itemsContainer = document.getElementById('cartItems');
            const footer = document.getElementById('cartFooter');
            const clearBtn = document.getElementById('btnClearCart');
            const badge = document.getElementById('cartBadge');
            const total = document.getElementById('cartTotal');

            badge.textContent = cartData.total_items || 0;
            total.textContent = `Â¥${(cartData.total_price || 0).toFixed(2)}`;

            if (!cartData.items || cartData.items.length === 0) {
                itemsContainer.innerHTML = '<div class="cart-empty">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>';
                footer.style.display = 'none';
                clearBtn.style.display = 'none';
                return;
            }

            footer.style.display = 'block';
            clearBtn.style.display = 'block';

            itemsContainer.innerHTML = cartData.items.map(item => {
                const custText = formatCartCustomization(item.customization);
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.item_name}</div>
                            ${custText ? `<div class="cart-item-customization">${custText}</div>` : ''}
                        </div>
                        <div class="cart-item-qty">
                            <button onclick="updateCartItemQty('${item.id}', -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateCartItemQty('${item.id}', 1)">+</button>
                        </div>
                        <div class="cart-item-price">Â¥${(item.final_price * item.quantity).toFixed(2)}</div>
                        <button class="cart-item-remove" onclick="removeCartItem('${item.id}')">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        function formatCartCustomization(cust) {
            if (!cust) return '';
            const parts = [];
            if (cust.cup_size) parts.push(formatSize(cust.cup_size));
            if (cust.temperature) parts.push(formatTemp(cust.temperature));
            if (cust.sugar_level) parts.push(formatSugar(cust.sugar_level));
            if (cust.milk_type && cust.milk_type !== 'WHOLE') parts.push(formatMilk(cust.milk_type));
            return parts.join(' Â· ');
        }

        // æ˜¾ç¤ºè®¢å•æˆåŠŸå¼¹çª—
        function showOrderModal(data) {
            const modal = document.getElementById('orderModal');
            document.getElementById('modalOrderId').textContent = `è®¢å•å·: ${data.order_id}`;
            document.getElementById('modalOrderTotal').textContent = `Â¥${data.order.total_price.toFixed(2)}`;
            document.getElementById('modalOrderItems').innerHTML = data.order.items.map(item =>
                `<div>${item.item_name} Ã— ${item.quantity} = Â¥${(item.final_price * item.quantity).toFixed(2)}</div>`
            ).join('');
            modal.style.display = 'flex';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        // ============ å®æ—¶åˆ·æ–°æœºåˆ¶ ============
        let refreshTimer = null;
        let autoRefreshEnabled = true;

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = 'flex';
            indicator.classList.remove('hidden');
        }

        function hideRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('hidden');
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 300);
        }

        async function autoRefreshRecommendations() {
            if (!autoRefreshEnabled || currentRecommendations.length === 0) return;

            showRefreshIndicator();

            try {
                const customPref = document.getElementById('customPreference').value.trim();

                const response = await fetch(customPref ? '/api/embedding/recommend/custom' : '/api/embedding/recommend/v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        persona_type: selectedPersona,
                        custom_preference: customPref || undefined,
                        user_id: userId,
                        session_id: sessionId,
                        top_k: 6,
                        enable_ab_test: document.getElementById('enableABTest').checked,
                        enable_behavior: document.getElementById('enableBehavior').checked,
                        enable_session: document.getElementById('enableSession').checked,
                        enable_explainability: document.getElementById('enableExplainability').checked,
                        enable_customization: document.getElementById('enableCustomization').checked
                    })
                });

                const data = await response.json();
                currentRecommendations = data.recommendations || [];
                renderRecommendations(data.recommendations);

                // æ›´æ–°æŒ‡æ ‡
                if (data.metrics) {
                    document.getElementById('metricTime').textContent = `${data.metrics.total_time_ms}ms`;
                    document.getElementById('metricScore').textContent = `${(data.metrics.avg_match_score * 100).toFixed(1)}%`;
                }

            } catch (error) {
                console.error('Auto refresh error:', error);
            } finally {
                hideRefreshIndicator();
            }
        }

        // ä¿®æ”¹recordFeedbackå‡½æ•°ï¼Œæ·»åŠ è‡ªåŠ¨åˆ·æ–°
        const originalRecordFeedback = recordFeedback;
        recordFeedback = async function(sku, type, btn, tags) {
            // è§†è§‰åé¦ˆ
            btn.classList.add('clicked');

            // æ›´æ–°äº¤äº’è®¡æ•°
            interactionCount++;
            document.getElementById('interactionCount').textContent = interactionCount;

            // æ›´æ–°å®æ—¶åå¥½æ˜¾ç¤º
            updateRealtimePrefs(type, tags);

            // è®°å½•åé¦ˆ
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        session_id: sessionId,
                        item_sku: sku,
                        feedback_type: type
                    })
                });

                // è®°å½•Sessionäº¤äº’
                const item = currentRecommendations.find(r => r.item.sku === sku)?.item;
                if (item) {
                    await fetch('/api/session/interaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            interaction_type: type,
                            item_data: {
                                sku: item.sku,
                                tags: item.tags,
                                category: item.category,
                                price: item.base_price
                            }
                        })
                    });
                }

                // è§¦å‘è‡ªåŠ¨åˆ·æ–°ï¼ˆé˜²æŠ–ï¼‰
                if (refreshTimer) clearTimeout(refreshTimer);
                refreshTimer = setTimeout(autoRefreshRecommendations, 800);

            } catch (error) {
                console.error('Feedback error:', error);
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è´­ç‰©è½¦
        loadCart();
    </script>
</body>
</html>
